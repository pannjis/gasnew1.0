<script>
  let salesChartInstance = null;
  let pieChartInstance = null;
  let globalLaporanData = {};
  let currentUser = {};
  let globalCompanyProfile = {};
  let globalListPelanggan = [];
  let globalListSupplier = [];
  let globalListKaryawan = [];
  let globalKeuanganData = [];
  let sessionPayrollData = [];
  let globalListAkun = [];
  let dataGajiPreview = [];
  let payrollDataTemp = [];
  let keranjangBelanja = [];
  let globalRiwayatData = [];
  let dataJualTemp = [];
  let dataBeliTemp = [];
  let keranjangBeli = [];
  let globalProdukList = [];
  let currentReturData = null;
  let draftBuffer = {};
  let tempProductPOS = {};
  let globalModalObj;
  let diskonMode = 'Rp'; // Default Rupiah
  let onConfirmAction = null;
  const rupiah = (n) => new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits:0}).format(n);


window.onload = function() { 
      // 1. Setup Database
      google.script.run.setupDatabase(); 

      // 2. Pindahkan Modal
      const modals = document.querySelectorAll('.modal');
      modals.forEach(m => document.body.appendChild(m));

      // 3. Init Modal Global
      initModal();
      
      // 4. Aktifkan Tanggal (Sekaligus isi default value)
      initTanggal(); 
      
      // (Baris setAutoDate DIBUANG saja karena sudah di-handle initTanggal)

      loadNotifHutang();
};

// --- LOGIKA PENCARIAN PELANGGAN ALA GOOGLE (UPDATE) ---

// 1. Fungsi Helper: Tampilkan Menu Default (Umum + 5 Pelanggan)
function tampilkanMenuDefault() {
    const container = document.getElementById('hasil-cari-container');
    container.innerHTML = ''; 

    // A. Opsi "Umum" (Paling Atas)
    const btnUmum = document.createElement('button');
    btnUmum.className = 'list-group-item list-group-item-action fw-bold text-primary py-2';
    btnUmum.innerHTML = 'Umum (Default)';
    btnUmum.onclick = function() {
            document.getElementById('kasir-pelanggan').value = 'Umum';
            container.classList.add('d-none');
    };
    container.appendChild(btnUmum);

    // B. Tambahkan 5 Pelanggan Teratas dari Database
    if(globalListPelanggan && globalListPelanggan.length > 0) {
        globalListPelanggan.slice(0, 5).forEach(r => {
            let label = r[1]; // Nama Kontak
            let subLabel = r[2] ? r[2] : ''; // Nama Perusahaan

            let display = `
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold text-dark text-truncate" style="font-size:13px; max-width: 65%;">${label}</span>
                    ${subLabel ? `<small class="text-muted text-end text-truncate" style="font-size:10px; max-width: 30%;">${subLabel}</small>` : ''}
                </div>
            `;

            const btn = document.createElement('button');
            btn.className = 'list-group-item list-group-item-action text-start py-1 px-2';
            btn.innerHTML = display;
            
            btn.onclick = function() {
                let finalVal = r[1];
                if(r[2]) finalVal = `${r[2]} (${r[1]})`;
                document.getElementById('kasir-pelanggan').value = finalVal;
                container.classList.add('d-none');
            };
            container.appendChild(btn);
        });
    }
    container.classList.remove('d-none'); // Pastikan muncul
}

// Panggil fungsi ini saat halaman dimuat, misal gabungkan di loadSemuaDataAwal()
function loadMetodeBayarKasir() {
    const sel = document.getElementById('pos-metode-bayar');
    
    google.script.run.withSuccessHandler(akunList => {
        sel.innerHTML = ''; // Bersihkan dulu

        // 1. Masukkan Akun-Akun Keuangan (Tunai, BCA, BRI, dll)
        akunList.forEach(akun => {
            // Value kita isi dengan Nama Akun agar nyambung ke sheet KEUANGAN
            sel.innerHTML += `<option value="${akun.nama}">${akun.nama}</option>`;
        });

        // 2. Tambahkan Garis Pemisah (Opsional, agar rapi)
        sel.innerHTML += `<option disabled>------------------</option>`;

        // 3. Tambahkan Opsi HUTANG (Wajib ada)
        sel.innerHTML += `<option value="Hutang">⚠️ Hutang / Bon</option>`;
        
    }).getDaftarAkun(); // Fungsi ini sudah kita buat di langkah sebelumnya
}

// [PENTING] Update Event Listener agar Hutang tetap memunculkan tanggal jatuh tempo
// Ganti event listener lama 'pos-metode-bayar' dengan yang ini:
document.getElementById('pos-metode-bayar')?.addEventListener('change', function() {
    const val = this.value;
    const box = document.getElementById('box-jatuh-tempo');
    
    // Logic: Jika pilih Hutang, munculkan tanggal. Jika Akun Bank/Tunai, sembunyikan.
    if(val === 'Hutang') {
        box.classList.remove('d-none');
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        // Cek apakah flatpickr aktif
        if(document.getElementById('pos-jatuh-tempo')._flatpickr) {
             document.getElementById('pos-jatuh-tempo')._flatpickr.setDate(nextWeek);
        } else {
             document.getElementById('pos-jatuh-tempo').value = nextWeek.toISOString().split('T')[0];
        }
    } else {
        box.classList.add('d-none');
    }
});

// 2. Saat Mengetik / Hapus Teks (Input Event)
document.getElementById('kasir-pelanggan')?.addEventListener('input', function() {
    const keyword = this.value.toLowerCase();
    const container = document.getElementById('hasil-cari-container');
    
    // --- [PERUBAHAN UTAMA DI SINI] ---
    // Jika input jadi kosong (dihapus), panggil menu default lagi
    if(keyword.length < 1) {
        tampilkanMenuDefault(); 
        return; 
    }
    // ---------------------------------

    // Jika ada teks, lakukan pencarian seperti biasa
    container.innerHTML = ''; // Bersihkan default

    const hasil = globalListPelanggan.filter(r => {
        const nama = r[1].toLowerCase();
        const pt = r[2] ? r[2].toLowerCase() : '';
        return nama.includes(keyword) || pt.includes(keyword);
    });

    if(hasil.length === 0) {
         container.innerHTML = '<div class="list-group-item text-muted small">Data tidak ditemukan.</div>';
         container.classList.remove('d-none');
         return;
    }
    
    // Render Hasil Pencarian (Maks 7)
    hasil.slice(0, 7).forEach(r => {
        let label = r[1];
        let subLabel = r[2] ? r[2] : '';
        
        let display = `
            <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold text-dark text-truncate" style="font-size:13px; max-width: 65%;">${label}</span>
                ${subLabel ? `<small class="text-muted text-end text-truncate" style="font-size:10px; max-width: 30%;">${subLabel}</small>` : ''}
            </div>
        `;
        
        const btn = document.createElement('button');
        btn.className = 'list-group-item list-group-item-action text-start py-1 px-2';
        btn.innerHTML = display;
        
        btn.onclick = function() {
            let finalVal = r[1];
            if(r[2]) finalVal = `${r[2]} (${r[1]})`;
            document.getElementById('kasir-pelanggan').value = finalVal;
            container.classList.add('d-none');
        };
        container.appendChild(btn);
    });
    
    container.classList.remove('d-none');
});

// 3. Saat Field Diklik (Focus) - Tampilkan Default
document.getElementById('kasir-pelanggan')?.addEventListener('focus', function() {
    if(this.value === '') {
        tampilkanMenuDefault();
    }
});

// 4. Sembunyikan Dropdown jika klik di luar
document.addEventListener('click', function(e) {
    if (e.target.id !== 'kasir-pelanggan') {
        document.getElementById('hasil-cari-container').classList.add('d-none');
    }
});

  function initModal() {
     if(!globalModalObj) globalModalObj = new bootstrap.Modal(document.getElementById('globalModal'));
  }

  // 1. PENGGANTI ALERT (Hanya Tombol OK)
  function myAlert(title, message, type = 'info') {
     initModal();
     document.getElementById('globalModalTitle').innerText = title;
     document.getElementById('globalModalBody').innerText = message;
     document.getElementById('btn-cancel').classList.add('d-none'); // Sembunyikan tombol Batal
     
     const btnOk = document.getElementById('btn-confirm');
     btnOk.innerText = "OK";
     btnOk.onclick = () => globalModalObj.hide();

     // Styling Warna Header & Icon
     const header = document.getElementById('globalModalHeader');
     const icon = document.getElementById('globalModalIcon');
     header.className = 'modal-header text-white'; // Reset
     
     if(type === 'error') {
        header.classList.add('bg-danger');
        icon.innerText = 'error_outline';
        icon.style.color = '#dc3545';
        btnOk.className = 'btn btn-danger px-4';
     } else if (type === 'success') {
        header.classList.add('bg-success');
        icon.innerText = 'check_circle';
        icon.style.color = '#198754';
        btnOk.className = 'btn btn-success px-4';
     } else {
        header.classList.add('bg-primary');
        icon.innerText = 'info';
        icon.style.color = '#0d6efd';
        btnOk.className = 'btn btn-primary px-4';
     }

     globalModalObj.show();
  }

  // 2. PENGGANTI CONFIRM (Tombol Ya & Batal)
  function myConfirm(title, message, callback) {
     initModal();
     document.getElementById('globalModalTitle').innerText = title;
     document.getElementById('globalModalBody').innerText = message;
     document.getElementById('btn-cancel').classList.remove('d-none'); // Munculkan tombol Batal
     
     // Styling
     const header = document.getElementById('globalModalHeader');
     const icon = document.getElementById('globalModalIcon');
     header.className = 'modal-header text-white bg-warning'; // Warna kuning untuk warning
     icon.innerText = 'help_outline';
     icon.style.color = '#ffc107';

     const btnYes = document.getElementById('btn-confirm');
     btnYes.innerText = "YA, LANJUTKAN";
     btnYes.className = 'btn btn-warning fw-bold px-4';
     
     // Set Action saat klik YA
     btnYes.onclick = () => {
        globalModalObj.hide();
        if(callback) callback(); // Jalankan fungsi yang dikirim
     };

     globalModalObj.show();
  }
  
  // --- FUNGSI LOADING (ANIMASI) ---
  function loading(status) {
    const el = document.getElementById('loading-overlay');
    if(el) { // Cek jika elemen ada agar tidak error
        if(status) {
            el.classList.remove('d-none');
        } else {
            el.classList.add('d-none');
        }
    }
  }

function showPage(pageId) {
    // ... (kode bagian atas showPage biarkan saja) ...

    // 1. Ganti Halaman (UI Saja)
    document.querySelectorAll('.page-section').forEach(el => el.classList.add('d-none'));
    const targetPage = document.getElementById('page-' + pageId);
    if(targetPage) targetPage.classList.remove('d-none');
    
    // 2. Update Navigasi Aktif (RESET SEMUA DULU)
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    
    // 3. Set Aktif pada Tombol yang Diklik (JIKA ADA ID-NYA)
    const navEl = document.getElementById('nav-' + pageId);
    if(navEl) {
        navEl.classList.add('active');
    }
    
    // 4. Khusus Menu Riwayat: Pastikan Submenu Terbuka
    if(pageId === 'riwayat-jual' || pageId === 'riwayat-beli' || pageId === 'riwayat-piutang') {
        const collapseRiwayat = document.getElementById('submenu-riwayat');
        if(collapseRiwayat && !collapseRiwayat.classList.contains('show')) {
            new bootstrap.Collapse(collapseRiwayat, { show: true });
        }
    }
    
    // --- LOAD DATA ---
    if(pageId === 'riwayat-jual') { setAutoDate('jual'); loadRiwayatJual(); }
    if(pageId === 'riwayat-beli') { setAutoDate('beli'); loadRiwayatBeli(); }
    if(pageId === 'riwayat-piutang') loadPiutang();
    if(pageId === 'pembelian') loadPembelianData();
    if(pageId === 'payroll') { loadKaryawan(); loadKasbon(); }

    // --- [PERBAIKAN ANTI BOCOR] ---
    if (pageId === 'laporan') {
        // 1. HARD RESET: Buang class 'active' & 'show' dari SEMUA konten tab laporan
        // Ini memastikan tidak ada konten tab lain (Saldo/Beban) yang masih nyangkut/muncul
        document.querySelectorAll('#laporanTabsContent .tab-pane').forEach(el => {
            el.classList.remove('show', 'active');
        });

        // 2. Reset status tombol navigasi tab (pills)
        document.querySelectorAll('#laporanTabs .nav-link').forEach(btn => {
            btn.classList.remove('active');
        });

        // 3. Aktifkan Manual Tab Pertama (Laba)
        const tabLaba = document.getElementById('tab-laba');
        const btnLaba = document.getElementById('tab-laba-btn');

        if(tabLaba) tabLaba.classList.add('show', 'active');
        if(btnLaba) btnLaba.classList.add('active');

        // 4. Load Data Laporan
        const elStart = document.getElementById('lap-start');
        if (!elStart.value) {
            setFilterLaporan('bulan_ini');
        } else {
            loadLaporanUtama();
        }
    }

    // --- PINDAHKAN KESINI (KELUAR DARI BLOK LAPORAN) ---
    if (pageId === 'page-stok-opname' || pageId === 'stok-opname') {
        // Reset Tab Opname ke posisi awal (Input) agar tidak blank
        if (typeof switchTabOpname === 'function') {
            switchTabOpname('input'); 
        }
    }

    if (pageId === 'pembelian') {
    loadAkunUntukPembelian(); // [BARU] Load Akun
    loadDataProdukGlobal();   // [BARU] Load Produk utk Search
    }
}

function handleLogin() {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  
  if(!u || !p) return myAlert('Isian Kosong', 'Harap isi username & password!', 'warning');

  loading(true); // Layar Putih Nyala

    google.script.run
        .withSuccessHandler(function(res) {
            
            if(res.status === 'success') {
                currentUser = res;
                document.getElementById('display-user').innerText = res.nama;
                
                // 1. PANGGIL SEMUA DATA DI SINI
                loadSemuaDataAwal(); 

                // 2. Beri waktu 1.5 detik agar data sempat terambil, baru buka aplikasi
                // User akan melihat loading selama 1.5 detik, tapi setelah itu aplikasi NGEBUT.
                setTimeout(function() {
                  loading(false); // Matikan loading
                  document.getElementById('login-section').classList.add('d-none');
                  document.getElementById('main-app').classList.remove('d-none');
                  showPage('dashboard');
                }, 1500); 

            } else {
                loading(false);
                myAlert('Gagal Masuk', 'Username atau Password salah!', 'error');
            }
        })
        .withFailureHandler(function(e) {
            loading(false);
            myAlert('Error Server', 'Gagal terhubung: ' + e, 'error');
        })
        .loginUser(u, p);
}

// --- TAMBAHAN: FUNGSI ENTER ---

// Pastikan kode berjalan setelah halaman selesai dimuat
document.addEventListener("DOMContentLoaded", function() {
  
  // Daftar ID input yang ingin diberi fungsi Enter
  const fields = ['username', 'password'];

  fields.forEach(function(id) {
    const inputElement = document.getElementById(id);
    
    // Cek apakah elemen ada untuk menghindari error
    if (inputElement) {
      inputElement.addEventListener("keypress", function(event) {
        // Jika tombol yang ditekan adalah Enter (Key Code 13 atau key === 'Enter')
        if (event.key === "Enter") {
          event.preventDefault(); // Mencegah refresh halaman jika ada tag <form>
          handleLogin(); // Panggil fungsi login
        }
      });
    }
  });

});
  
  function logout() {
    // 1. Tampilkan Loading sebentar agar transisi halus
    loading(true);

    setTimeout(() => {
        // 2. Reset Variabel User (Hapus sesi di memori browser)
        currentUser = {};
        
        // 3. Reset Tampilan: Sembunyikan Dashboard, Munculkan Login
        document.getElementById('main-app').classList.add('d-none'); // Tutup Dashboard
        document.getElementById('login-section').classList.remove('d-none'); // Buka Login

        // 4. Bersihkan Form Input Login
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        
        // 5. Matikan Loading
        loading(false);
    }, 500); // Beri jeda 0.5 detik
}

function loadSemuaDataAwal() {
    // Kita panggil semua fungsi data di sini secara paralel
    console.log("Memulai preload data...");
    
    loadDashboard();   // Update angka dashboard
    loadProduk();      // Update stok & harga
    loadPelanggan();   // Update list pelanggan
    loadKeuangan();    // Update tabel kas
    loadNotifHutang(); // Cek notifikasi hutang
    
    // Khusus Dropdown Pelanggan (untuk Kasir)
    loadPelangganDropdown();
    loadCompanyProfile(); 
    loadMetodeBayarKasir();
    loadNotifikasiLonceng();
}

// Tambahkan di fungsi switchSettingTab yang sudah ada
function switchSettingTab(tab, btn) {
   // Reset UI (Sembunyikan semua konten)
   document.querySelectorAll('.setting-content').forEach(el => el.classList.add('d-none'));
   document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
   
   // Aktifkan Target
   document.getElementById('set-content-' + tab).classList.remove('d-none');
   btn.classList.add('active');

   if(tab === 'users') loadUsers();
   if(tab === 'akun') loadSettingAkun(); // <--- TAMBAHAN: Load Akun saat tab diklik
}

function loadSettingAkun() {
    const tbody = document.querySelector('#tabel-setting-akun tbody');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';

    google.script.run.withSuccessHandler(data => {
        tbody.innerHTML = '';
        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Belum ada akun.</td></tr>';
            return;
        }

        data.forEach(acc => {
            let displayNorek = acc.norek ? acc.norek : '-';

            tbody.innerHTML += `
            <tr>
                <td class="fw-bold text-dark">${acc.nama}</td>
                <td class="text-primary fw-bold" style="font-family:monospace; font-size:1.1em;">${displayNorek}</td>
                <td><span class="badge bg-light text-dark border">${acc.tipe}</span></td>
                <td>${rupiah(acc.saldo)}</td>
                <td>
                    <button class="btn btn-sm btn-warning me-1" onclick="editAkun('${acc.id}', '${acc.nama}', '${displayNorek}', '${acc.tipe}', ${acc.saldo})">
                        <i class="material-icons" style="font-size:14px">edit</i>
                    </button>
                    <button class="btn btn-sm btn-light text-danger border" onclick="hapusAkunJS('${acc.id}')">
                        <i class="material-icons" style="font-size:14px">delete</i>
                    </button>
                </td>
            </tr>
            `;
        });
    }).getDaftarAkun();
}

// UPDATE 2: Fungsi Modal (Reset Input Baru)
function modalTambahAkun() {
    document.getElementById('edit-id-akun').value = ''; // KOSONGKAN ID (PENTING!)
    document.getElementById('input-akun-nama').value = '';
    document.getElementById('input-akun-norek').value = '';
    document.getElementById('input-akun-tipe').value = 'Bank';
    document.getElementById('input-akun-saldo').value = '0';
    
    document.getElementById('label-modal-akun').innerText = "Tambah Akun Keuangan";
    new bootstrap.Modal(document.getElementById('modalAkunBaru')).show();
}

function editAkun(id, nama, norek, tipe, saldo) {
    // Isi form dengan data yang mau diedit
    document.getElementById('edit-id-akun').value = id; // ID disimpan di hidden input
    document.getElementById('input-akun-nama').value = nama;
    document.getElementById('input-akun-norek').value = norek;
    document.getElementById('input-akun-tipe').value = tipe;
    
    // Format Saldo ke Ribuan agar enak dilihat
    document.getElementById('input-akun-saldo').value = Number(saldo).toLocaleString('id-ID');
    
    // Ubah Judul Modal
    document.getElementById('label-modal-akun').innerText = "Edit Akun Keuangan";
    
    // Tampilkan Modal
    new bootstrap.Modal(document.getElementById('modalAkunBaru')).show();
}

// UPDATE 3: Fungsi Simpan (Kirim Norek)
function simpanAkunBaruJS() {
    // Ambil ID dari hidden input
    const id = document.getElementById('edit-id-akun').value; 
    
    const nama = document.getElementById('input-akun-nama').value;
    const norek = document.getElementById('input-akun-norek').value || '-';
    const tipe = document.getElementById('input-akun-tipe').value;
    
    // Bersihkan titik ribuan dari saldo
    const rawSaldo = document.getElementById('input-akun-saldo').value;
    const saldo = Number(rawSaldo.replace(/\./g, '')) || 0;

    if(!nama) return myAlert('Error', 'Nama akun wajib diisi', 'warning');

    const payload = {
        id: id, // KIRIM ID (Kalau kosong berarti baru, kalau ada isi berarti edit)
        nama: nama,
        norek: norek,
        tipe: tipe,
        saldo: saldo
    };

    loading(true);
    google.script.run.withSuccessHandler(res => {
        loading(false);
        bootstrap.Modal.getInstance(document.getElementById('modalAkunBaru')).hide();
        myAlert('Sukses', res, 'success');
        
        loadSettingAkun(); 
        loadMetodeBayarKasir(); 

    }).simpanAkunBaru(payload);
}
function hapusAkunJS(id) {
    myConfirm('Hapus Akun', 'Yakin ingin menghapus akun ini? Data transaksi lama tetap ada, tapi akun hilang dari pilihan.', () => {
        loading(true);
        google.script.run.withSuccessHandler(res => {
            loading(false);
            
            // Refresh Tabel Pengaturan
            loadSettingAkun();
            
            // [TAMBAHAN PENTING] Refresh Dropdown Kasir
            loadMetodeBayarKasir(); 
            
            myAlert('Info', res, 'success');
        }).hapusAkun(id);
    });
}

// 1. FUNGSI PREVIEW LOGO (Baru)
function previewLogo(input) {
    const preview = document.getElementById('img-preview-logo');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('d-none');
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// 2. UPDATE FUNGSI LOAD (Agar menampilkan logo yang sudah tersimpan)
// Ganti fungsi loadCompanyProfile() yang lama dengan ini:
function loadCompanyProfile() {
   google.script.run.withSuccessHandler(config => {
      globalCompanyProfile = config; 
      
      document.getElementById('set-comp-nama').value = config.nama_perusahaan || '';
      document.getElementById('set-comp-owner').value = config.nama_pemilik || '';
      document.getElementById('set-comp-alamat').value = config.alamat || '';
      document.getElementById('set-comp-no-pt').value = config.no_perusahaan || '';
      document.getElementById('set-comp-no-owner').value = config.no_pemilik || '';

      // Tampilkan Logo jika ada
      const imgPrev = document.getElementById('img-preview-logo');
      if(config.logo_perusahaan) {
          imgPrev.src = config.logo_perusahaan;
          imgPrev.classList.remove('d-none');
      }

   }).getProfilPerusahaan();
}

// 3. UPDATE FUNGSI SIMPAN (Agar mengirim file gambar ke backend)
// Ganti fungsi simpanProfilPerusahaanJS() yang lama dengan ini:
function simpanProfilPerusahaanJS() {
   const fileInput = document.getElementById('set-comp-logo');
   const file = fileInput.files[0];

   const payload = {
      nama_perusahaan: document.getElementById('set-comp-nama').value,
      nama_pemilik: document.getElementById('set-comp-owner').value,
      alamat: document.getElementById('set-comp-alamat').value,
      no_perusahaan: document.getElementById('set-comp-no-pt').value,
      no_pemilik: document.getElementById('set-comp-no-owner').value,
      logo: null // Default null
   };
   
   // Fungsi Kirim Data (Sub-function agar rapi)
   const kirim = (data) => {
       loading(true);
       google.script.run.withSuccessHandler(res => {
          loading(false);
          // Update global profile agar Invoice langsung berubah tanpa refresh
          globalCompanyProfile = data; 
          // Jika ada logo baru di response (biasanya URL), update juga (tapi disini kita reload aja biar aman)
          loadCompanyProfile(); 
          
          myAlert('Sukses', res, 'success');
       }).simpanProfilPerusahaan(data);
   };

   // Cek apakah ada file logo yang dipilih?
   if (file) {
       // Validasi Ukuran (Maks 2MB)
       if(file.size > 2 * 1024 * 1024) return myAlert('File Besar', 'Maksimal ukuran logo 2MB', 'warning');

       const reader = new FileReader();
       reader.onload = function(e) {
           payload.logo = {
               data: e.target.result.split(',')[1], // Ambil base64
               mimeType: file.type
           };
           kirim(payload); // Kirim dengan logo
       };
       reader.readAsDataURL(file);
   } else {
       kirim(payload); // Kirim tanpa update logo (data teks saja)
   }
}

// 3. LOGIKA MANAJEMEN USER
function loadUsers() {
   google.script.run.withSuccessHandler(users => {
      const tb = document.querySelector('#tabel-users tbody');
      tb.innerHTML = '';
      
      users.forEach(u => {
         // u[0]:Username, u[2]:Role, u[3]:Nama
         let badge = u[2] === 'Admin' ? '<span class="badge bg-danger">ADMIN</span>' : '<span class="badge bg-secondary">USER</span>';
         
         tb.innerHTML += `
            <tr>
               <td>${u[3]}</td>
               <td class="fw-bold">${u[0]}</td>
               <td>${badge}</td>
               <td>
                  <button class="btn btn-sm btn-warning" onclick="editUser('${u[0]}','${u[3]}','${u[2]}')"><i class="material-icons" style="font-size:14px">edit</i></button>
                  ${u[0] !== 'admin' && u[0] !== currentUser.username ? `<button class="btn btn-sm btn-light text-danger border" onclick="hapusUserJS('${u[0]}')"><i class="material-icons" style="font-size:14px">delete</i></button>` : ''}
               </td>
            </tr>
         `;
      });
   }).getAllUsers();
}

function modalUserBaru() {
   document.getElementById('modalUserTitle').innerText = 'User Baru';
   document.getElementById('user-is-edit').value = 'false';
   document.getElementById('user-username').value = '';
   document.getElementById('user-username').removeAttribute('readonly');
   document.getElementById('user-nama').value = '';
   document.getElementById('user-pass').value = '';
   document.getElementById('note-pass-edit').classList.add('d-none');
   document.getElementById('role-admin').checked = false;
   
   new bootstrap.Modal(document.getElementById('modalUser')).show();
}

function editUser(username, nama, role) {
   document.getElementById('modalUserTitle').innerText = 'Edit User';
   document.getElementById('user-is-edit').value = 'true';
   
   document.getElementById('user-username').value = username;
   document.getElementById('user-username').setAttribute('readonly', true); // Username gak boleh ganti
   
   document.getElementById('user-nama').value = nama;
   document.getElementById('user-pass').value = '';
   document.getElementById('note-pass-edit').classList.remove('d-none');
   
   // Set Checkbox berdasarkan Role
   document.getElementById('role-admin').checked = (role === 'Admin');
   
   new bootstrap.Modal(document.getElementById('modalUser')).show();
}

// Cari fungsi ini di javascript.html dan GANTI isinya:

function simpanUserDB() {
   const isEdit = document.getElementById('user-is-edit').value === 'true';
   const username = document.getElementById('user-username').value.trim();
   const nama = document.getElementById('user-nama').value;
   const pass = document.getElementById('user-pass').value;
   const isAdmin = document.getElementById('role-admin').checked;
   
   if(!username || !nama) return myAlert('Error', 'Username dan Nama wajib diisi', 'error');
   if(!isEdit && !pass) return myAlert('Error', 'Password wajib diisi untuk user baru', 'error');

   const payload = {
      isEdit: isEdit,
      username: username,
      nama: nama,
      password: pass, 
      role: isAdmin ? 'Admin' : 'User' 
   };
   
   loading(true);
   google.script.run.withSuccessHandler(res => {
      loading(false);
      if(res.includes('Error')) {
         myAlert('Gagal', res, 'error');
      } else {
         myAlert('Sukses', res, 'success');
         bootstrap.Modal.getInstance(document.getElementById('modalUser')).hide();
         loadUsers();

         // --- [TAMBAHAN BARU] ---
         // Jika user yang diedit adalah user yang sedang login, update tampilan langsung
         if (currentUser.username === username) {
             currentUser.nama = nama; // Update memori
             currentUser.role = payload.role;
             
             // Update Teks di Pojok Kanan Atas
             const displayUser = document.getElementById('display-user');
             if(displayUser) displayUser.innerText = nama;
         }
         // -----------------------
      }
   }).simpanUserBaru(payload);
}

function hapusUserJS(username) {
   myConfirm('Hapus User', `Yakin hapus user ${username}?`, () => {
      loading(true);
      google.script.run.withSuccessHandler(res => {
         loading(false);
         loadUsers();
         myAlert('Info', res, 'success');
      }).hapusUser(username);
   });
}

// 4. GANTI PASSWORD SENDIRI
function modalGantiPassword() {
   document.getElementById('gp-old').value = '';
   document.getElementById('gp-new').value = '';
   new bootstrap.Modal(document.getElementById('modalGantiPass')).show();
}

function prosesGantiPassword() {
   const oldP = document.getElementById('gp-old').value;
   const newP = document.getElementById('gp-new').value;
   
   if(!oldP || !newP) return myAlert('Error', 'Isi semua field', 'warning');
   
   loading(true);
   // currentUser.username didapat dari loginResult yang sudah diupdate di Code.gs
   google.script.run.withSuccessHandler(res => {
      loading(false);
      if(res.includes('Berhasil')) {
          myAlert('Sukses', res, 'success');
          bootstrap.Modal.getInstance(document.getElementById('modalGantiPass')).hide();
      } else {
          myAlert('Gagal', res, 'error');
      }
   }).gantiPasswordSendiri(currentUser.username, oldP, newP);
}


// [JAVASCRIPT.HTML] Update Fungsi loadDashboard (Anti-Loading Stuck)
function loadDashboard(startDate = null, endDate = null) {
  // 1. SET TAMPILAN JADI LOADING DULU
  const setHtml = (id, html) => {
      const el = document.getElementById(id);
      if(el) el.innerHTML = html;
  };

  const spinner = '<div class="spinner-border spinner-border-sm text-secondary" role="status"></div>';

  setHtml('dash-main-income', spinner);
  setHtml('dash-avg-trx', '...');
  setHtml('dash-main-expense', spinner);
  setHtml('dash-retur', '...');
  setHtml('dash-count-order', '...');
  setHtml('dash-count-pel', '...');
  setHtml('dash-count-refill', '...');
  setHtml('dash-periode-info', 'Sedang memuat data...');
  
  // Reset Tabel Top Produk
  setHtml('tabel-top-produk', '<tr><td colspan="2" class="text-center py-4 text-muted"><div class="spinner-border text-primary spinner-border-sm mb-2"></div><br>Sedang menganalisa data...</td></tr>');

  // 2. PANGGIL DATA KE SERVER (DENGAN PENANGANAN ERROR)
  google.script.run
    .withFailureHandler(err => {
        // [PENTING] Jika server error, matikan loading dan tampilkan pesan
        console.error("Dashboard Error:", err);
        setHtml('dash-main-income', '<span class="text-danger small">Error</span>');
        setHtml('dash-main-expense', '<span class="text-danger small">Error</span>');
        setHtml('dash-periode-info', '<span class="text-danger">Gagal memuat data dashboard.</span>');
        setHtml('tabel-top-produk', `<tr><td colspan="2" class="text-center text-danger py-4">Error: ${err.message}</td></tr>`);
    })
    .withSuccessHandler(res => {
        const stats = res.stats;
        
        // 1. UPDATE INFO PERIODE
        document.getElementById('dash-periode-info').innerText = `Periode: ${res.periode}`;
        
        // 2. UPDATE NILAI KARTU
        // Pastikan angka valid (tidak NaN) sebelum ditampilkan
        const safeRupiah = (val) => rupiah(Number(val) || 0);

        document.getElementById('dash-main-income').innerText = safeRupiah(stats.pendapatan);
        document.getElementById('dash-avg-trx').innerText = `Rata-rata: ${safeRupiah(stats.rataRataTransaksi)} / trx`;
        
        document.getElementById('dash-main-expense').innerText = safeRupiah(stats.pengeluaran);
        document.getElementById('dash-retur').innerText = `Retur: ${safeRupiah(stats.retur)}`;
        
        document.getElementById('dash-count-order').innerText = stats.pesanan;
        document.getElementById('dash-count-pel').innerText = `${stats.totalPelanggan} Pelanggan`;
        document.getElementById('dash-count-refill').innerText = stats.qtyRefill + " Pcs";

        // 3. RENDER TABEL TOP PRODUK
        const prodTable = document.getElementById('tabel-top-produk');
        if(prodTable) {
            prodTable.innerHTML = '';
            const sortedProduk = Object.entries(stats.produkTerjual).sort(([,a],[,b]) => b - a);
            
            if(sortedProduk.length === 0) {
                prodTable.innerHTML = '<tr><td colspan="2" class="text-center text-muted py-4 small">Belum ada data penjualan.</td></tr>';
            } else {
                const maxQty = sortedProduk[0][1] || 1; // Hindari pembagian nol

                sortedProduk.slice(0, 5).forEach(([nama, qty], index) => {
                    const rank = index + 1;
                    const percent = (qty / maxQty) * 100;
                    
                    let badgeRank = `<span class="badge bg-light text-secondary border" style="width:24px; height:24px; display:flex; align-items:center; justify-content:center; border-radius:50%;">${rank}</span>`;
                    if(rank === 1) badgeRank = `<span class="badge bg-warning text-dark border border-warning shadow-sm" style="width:24px; height:24px; display:flex; align-items:center; justify-content:center; border-radius:50%;">1</span>`;
                    
                    prodTable.innerHTML += `
                    <tr>
                        <td class="ps-3 py-3" style="width: 40px; vertical-align:top;">${badgeRank}</td>
                        <td class="pe-3 py-2">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-bold text-dark text-truncate" style="font-size:13px; max-width:180px;">${nama}</span>
                                <span class="fw-bold text-primary" style="font-size:12px;">${qty}</span>
                            </div>
                            <div class="progress" style="height: 6px; border-radius: 10px; background-color: #f0f2f5;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: ${percent}%; border-radius: 10px;"></div>
                            </div>
                        </td>
                    </tr>`;
                });
            }
        }

        // 4. RENDER CHART (Gunakan try-catch agar chart error tidak mematikan fungsi lain)
        try {
            renderCharts(stats); 
        } catch(e) {
            console.warn("Gagal render chart:", e);
        }

    })
    .getDashboardRealtime(startDate, endDate);
}
// --- FUNGSI BARU UNTUK TOMBOL FILTER ---

function applyDashboardFilter() {
    const start = document.getElementById('dash-date-start').value;
    const end = document.getElementById('dash-date-end').value;
    
    if(!start || !end) {
        Swal.fire('Error', 'Harap pilih tanggal awal dan akhir', 'warning');
        return;
    }
    
    loadDashboard(start, end);
}

function resetDashboardFilter() {
    // Reset input tanggal
    document.getElementById('dash-date-start').value = '';
    document.getElementById('dash-date-end').value = '';
    
    // Load default (Bulan Ini)
    loadDashboard(); 
}

// Inisialisasi awal saat halaman dibuka
document.addEventListener('DOMContentLoaded', function() {
    // ... init lainnya ...
    // loadDashboard(); // Pastikan dipanggil di init utama
});

// FUNGSI RENDER CHART (BARU)
function renderCharts(stats) {
    // 1. HAPUS CHART LAMA JIKA ADA (Agar tidak numpuk saat refresh)
    if(salesChartInstance) salesChartInstance.destroy();
    if(pieChartInstance) pieChartInstance.destroy();

    // 2. CHART PENJUALAN HARIAN (Line Chart)
    const ctxSales = document.getElementById('chartSales').getContext('2d');
    
    // Bikin Gradient Warna Merah
    let gradient = ctxSales.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(255, 59, 48, 0.5)');   
    gradient.addColorStop(1, 'rgba(255, 59, 48, 0.0)');

    salesChartInstance = new Chart(ctxSales, {
        type: 'line',
        data: {
            labels: stats.chartLabels, // Tanggal 1, 2, 3...
            datasets: [
                {
                    label: 'Pemasukan (Omzet)',
                    data: stats.chartSales,
                    borderColor: '#ff3b30', // Merah Primary
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#ff3b30',
                    fill: true,
                    tension: 0.4 // Garis lengkung halus
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { borderDash: [2, 4] }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    // 3. CHART PIE (PEMASUKAN vs PENGELUARAN)
    const ctxPie = document.getElementById('chartPie').getContext('2d');
    
    // PERBAIKAN: Gunakan nama variabel yang sesuai dengan Code.gs (stats.pendapatan & stats.pengeluaran)
    let profit = stats.pendapatan - stats.pengeluaran; 
    if(profit < 0) profit = 0; // Biar chart ga error

    pieChartInstance = new Chart(ctxPie, {
        type: 'doughnut',
        data: {
            labels: ['Pengeluaran', 'Laba Bersih'],
            datasets: [{
                // PERBAIKAN: Gunakan stats.pengeluaran
                data: [stats.pengeluaran, profit],
                backgroundColor: [
                    '#dc3545', // Merah (Expense)
                    '#198754'  // Hijau (Profit)
                ],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%', // Bolong tengah
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

  // --- PRODUK & KASIR ---
function loadProduk() {
    loading(true);
    google.script.run.withSuccessHandler(data => {
      loading(false);
      globalProdukList = data; // Simpan ke global
      
      // 1. Render Grid Kasir (POS)
      renderProdukGrid(data);  
      
      // 2. Render Tabel Admin (YANG HILANG SEBELUMNYA)
      const tb = document.querySelector('#tabel-produk tbody');
        if(tb) {
         tb.innerHTML = ''; // Kosongkan tabel dulu
            data.forEach(r => {
            
            // [BARU] Ambil Data Harga Tabung (Index 9 & 10 sesuai CODE.GS)
            let hargaBeliTabung = r[9] || 0;
            let hargaJualTabung = r[10] || 0;

            // Render Baris
            tb.innerHTML += `
              <tr>
                <td class="fw-bold text-dark">${r[1]}</td>
                
                <td class="text-success fw-bold">${rupiah(r[2])}</td>
                <td class="text-muted small">${rupiah(r[3])}</td>
                
                <td class="text-primary fw-bold" style="background-color:#f8f9fa;">${rupiah(hargaJualTabung)}</td>
                <td class="text-muted small" style="background-color:#f8f9fa;">${rupiah(hargaBeliTabung)}</td>

                <td class="text-center fw-bold">${r[4]}</td>
                <td class="text-center text-secondary">${r[5]}</td>
                
                <td>
                   <button class="btn btn-sm btn-warning text-dark border me-1" onclick="bukaHalamanEdit('${r[0]}')">
                     <i class="material-icons" style="font-size:14px">edit</i>
                   </button>
                   
                   <button class="btn btn-sm btn-light text-danger border" onclick="hapusProduk('${r[1]}')">
                     <i class="material-icons" style="font-size:14px">delete</i>
                   </button>
                </td>
              </tr>
            `;
         });
      }

      // 3. Update Dropdown di halaman Stok Masuk (Beli)
      const selB = document.getElementById('beli-produk');
      if(selB) {
         selB.innerHTML = '<option value="">--Pilih--</option>';
         data.forEach(p => selB.innerHTML += `<option value="${p[1]}" data-buy="${p[3]}">${p[1]}</option>`);
      }

    }).getData('PRODUK');
}

// [UPDATE] 4. BUKA HALAMAN EDIT (Isi Field Baru)
function bukaHalamanEdit(id) {
    const produk = globalProdukList.find(row => row[0] == id);
    if (!produk) return myAlert('Error', 'Data produk tidak ditemukan.', 'error');

    // Field Lama
    document.getElementById('edit-prod-id').value = produk[0];
    document.getElementById('edit-prod-nama').value = produk[1];
    document.getElementById('edit-prod-sku').value = produk[6] || '';
    document.getElementById('edit-prod-kode').value = produk[7] || '';
    document.getElementById('edit-prod-isi').value = produk[4];
    document.getElementById('edit-prod-kosong').value = produk[5];

    // Field Harga (Format Ribuan)
    document.getElementById('edit-prod-jual').value = Number(produk[2]).toLocaleString('id-ID'); // Jual Isi
    document.getElementById('edit-prod-beli').value = Number(produk[3]).toLocaleString('id-ID'); // Beli Isi (Modal)

    // [BARU] Field Harga Tabung
    document.getElementById('edit-prod-jual-tabung').value = Number(produk[10] || 0).toLocaleString('id-ID');
    document.getElementById('edit-prod-beli-tabung').value = Number(produk[9] || 0).toLocaleString('id-ID');

    // Tambahkan di dalam fungsi bukaHalamanEdit(id)
    
    // Field Harga Refill Level 2 & 3
    document.getElementById('edit-prod-jual-2').value = Number(produk[11] || 0).toLocaleString('id-ID');
    document.getElementById('edit-prod-jual-3').value = Number(produk[12] || 0).toLocaleString('id-ID');

    // Field Harga Tabung Level 2 & 3
    document.getElementById('edit-prod-jual-tabung-2').value = Number(produk[13] || 0).toLocaleString('id-ID');
    document.getElementById('edit-prod-jual-tabung-3').value = Number(produk[14] || 0).toLocaleString('id-ID');

    // Gambar
    const imgUrl = produk[8];
    const imgPrev = document.getElementById('edit-img-preview');
    if(imgUrl && imgUrl.length > 5) {
        imgPrev.src = imgUrl; imgPrev.classList.remove('d-none');
    } else {
        imgPrev.src = ''; imgPrev.classList.add('d-none');
    }
    document.getElementById('edit-prod-file').value = '';

    showPage('edit-produk');
}

// 2. Helper Preview Image di Halaman Edit
function previewEditImage(input) {
    const preview = document.getElementById('edit-img-preview');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('d-none');
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// [UPDATE] 5. PROSES SIMPAN EDIT (Kirim Field Baru)
function prosesSimpanEdit() {
    const fileInput = document.getElementById('edit-prod-file');
    const file = fileInput.files[0];

    // Helper Unformat Rupiah
    const num = (id) => Number(document.getElementById(id).value.replace(/\./g, '')) || 0;

    const payload = {
        id: document.getElementById('edit-prod-id').value,
        nama: document.getElementById('edit-prod-nama').value,
        sku: document.getElementById('edit-prod-sku').value,
        kode: document.getElementById('edit-prod-kode').value,
        
        hargaJual: num('edit-prod-jual'),
        hargaJualRefill2: num('edit-prod-jual-2'), // Baru
        hargaJualRefill3: num('edit-prod-jual-3'), // Baru
        
        hargaBeli: num('edit-prod-beli'),
        
        hargaJualTabung: num('edit-prod-jual-tabung'),
        hargaJualTabung2: num('edit-prod-jual-tabung-2'), // Baru
        hargaJualTabung3: num('edit-prod-jual-tabung-3'), // Baru
        
        hargaBeliTabung: num('edit-prod-beli-tabung'),
        
        gambar: null 
    };

    // ... (Logika kirim updateProduk sama, cuma payload nambah) ...
    // Copy paste logika fileReader dari kode lama disini
    const kirimUpdate = (data) => {
        loading(true);
        google.script.run.withSuccessHandler(res => {
            loading(false); myAlert('Sukses', res, 'success');
            showPage('produk'); loadProduk();
        }).updateProduk(data);
    };

    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            payload.gambar = { data: e.target.result.split(',')[1], mimeType: file.type, fileName: file.name };
            kirimUpdate(payload);
        };
        reader.readAsDataURL(file);
    } else {
        kirimUpdate(payload);
    }
}

// Fungsi Render Grid
function renderProdukGrid(data) {
   const container = document.getElementById('pos-grid-container');
   if(!container) return;
   container.innerHTML = '';

   // 1. CEK MODE SAAT INI (REFILL / BARU)
   let modeEl = document.querySelector('input[name="posMode"]:checked');
   let mode = modeEl ? modeEl.value : 'Tukar (Refill)';

   data.forEach(p => {
      let nama = p[1];
      let hargaRefill = Number(p[2]); 
      let hargaTabung = Number(p[10]) || 0; 
      
      let stokIsi = Number(p[4]);    // Stok Gas (Isi)
      let stokKosong = Number(p[5]); // Stok Tabung Kosong (Cangkang)
      let linkGambar = p[8]; 

      // 2. TENTUKAN HARGA & STOK UTAMA YANG TAMPIL
      let hargaShow = 0;
      let stokShow = 0;
      let labelStok = '';
      let warnaStok = '';

      if (mode === 'Beli Tabung Baru') {
          // Mode Baru: Harga Paket
          hargaShow = hargaRefill + hargaTabung;
          stokShow = stokIsi; 
          labelStok = 'Ready Isi'; 
          warnaStok = 'bg-primary-subtle text-primary border-primary-subtle';
      } else {
          // Mode Refill
          hargaShow = hargaRefill;
          stokShow = stokIsi;
          labelStok = 'Ready Isi';
          warnaStok = 'bg-success-subtle text-success border-success-subtle';
      }

      // 3. RENDER TAMPILAN GAMBAR
      let gambarHtml = (linkGambar && linkGambar.length > 5) 
          ? `<img src="${linkGambar}" class="mb-2 rounded" style="width: 100%; height: 100px; object-fit: contain;">`
          : `<div class="product-icon mx-auto mb-2"><i class="material-icons">propane</i></div>`;

      let disabledClass = stokShow <= 0 ? 'opacity-50 grayscale' : '';
      
      // Badge Stok Utama (Isi)
      let badgeStok = stokShow > 0 
          ? `<span class="badge ${warnaStok} border rounded-pill mb-1" style="font-size:10px;">${labelStok}: ${stokShow}</span>` 
          : `<span class="badge bg-danger text-white rounded-pill mb-1">Stok Isi Habis</span>`;
      
      // [BARU] Tampilan Stok Wadah (Lebih Umum)
      let infoKosong = `
        <div class="d-flex justify-content-center align-items-center mt-1" style="font-size: 11px; color: #6c757d;">
            <span class="material-icons me-1" style="font-size: 12px;">check_box_outline_blank</span>
            <span>Stok Wadah: <b>${stokKosong}</b></span>
        </div>
      `;

      // Harga
      let hargaHtml = stokShow > 0 
          ? `<div class="text-dark fw-bold mb-1 transition-all" style="font-size: 0.95rem;">${rupiah(hargaShow)}</div>`
          : `<div class="text-muted text-decoration-line-through mb-1 small">${rupiah(hargaShow)}</div>`;

      container.innerHTML += `
      <div class="col-6 col-md-4 col-lg-3">
         <div class="card h-100 product-card border-0 shadow-sm ${disabledClass}" 
              onclick="klikProdukPOS('${nama}')">
            <div class="card-body text-center p-2 d-flex flex-column justify-content-between">
               <div>
                   ${gambarHtml}
                   <h6 class="fw-bold text-dark mb-1 text-truncate" title="${nama}" style="font-size: 0.85rem;">${nama}</h6>
                   ${hargaHtml}
               </div>
               
               <div class="mt-2">
                   ${badgeStok}
                   ${infoKosong} </div>
            </div>
         </div>
      </div>
      `;
   });
}

// A. HELPER BARU: Ubah Qty di dalam Modal
function ubahQtyModal(delta) {
    const el = document.getElementById('input-qty-pos');
    let val = Number(el.value) || 1;
    val += delta;
    if(val < 1) val = 1;
    el.value = val;
}

function klikProdukPOS(namaProduk) {
    const produk = globalProdukList.find(p => p[1] === namaProduk);
    if (!produk) return;

    let stok = Number(produk[4]);
    
    // AMBIL DATA HARGA (LEVEL 1, 2, 3)
    // Refill
    let r1 = Number(produk[2]) || 0;
    let r2 = Number(produk[11]) || r1; // Jika kosong, pakai level 1
    let r3 = Number(produk[12]) || r1;

    // Tabung
    let t1 = Number(produk[10]) || 0;
    let t2 = Number(produk[13]) || t1;
    let t3 = Number(produk[14]) || t1;

    // HPP (Modal)
    let hppIsi = Number(produk[3]) || 0;     
    let hppTabung = Number(produk[9]) || 0;  

    let mode = document.querySelector('input[name="posMode"]:checked').value;
    
    // Simpan semua harga ke Variable Global Sementara
    tempProductPOS = { 
        nama: produk[1], 
        stok, mode, hppIsi, hppTabung,
        hargaRefill: { 1: r1, 2: r2, 3: r3 },
        hargaTabung: { 1: t1, 2: t2, 3: t3 }
    };

    document.getElementById('qty-modal-title').innerText = produk[1];
    
    // Reset Radio Button ke Level 1
    document.getElementById('btn-lvl-1').checked = true;

    // Setup UI Toggle
    const boxToggle = document.getElementById('box-toggle-tabung');
    if (mode === 'Beli Tabung Baru') {
        boxToggle.classList.remove('d-none');
        document.getElementById('toggle-isi-tabung').checked = true; 
        updateTampilanToggle(true); 
    } else {
        boxToggle.classList.add('d-none');
    }

    document.getElementById('input-qty-pos').value = 1;
    
    // HITUNG HARGA LEVEL
    hitungHargaLevel(); 

    // Reset Pesan Error
    document.getElementById('qty-msg-error').classList.add('d-none');

    new bootstrap.Modal(document.getElementById('modalInputQty')).show();
    setTimeout(() => { document.getElementById('input-qty-pos').focus(); }, 500);
}

function hitungHargaLevel() {
    // 1. Cek Level yang Dipilih (1, 2, atau 3)
    let level = document.querySelector('input[name="pilihLevel"]:checked').value;
    
    // 2. Ambil Harga Sesuai Level dari tempProductPOS
    let hargaRefill = tempProductPOS.hargaRefill[level];
    let hargaTabung = tempProductPOS.hargaTabung[level];

    // 3. Cek Mode (Refill atau Baru)
    let hargaTampil = 0;
    
    if (tempProductPOS.mode === 'Beli Tabung Baru') {
        const isFull = document.getElementById('toggle-isi-tabung').checked;
        updateTampilanToggle(isFull); // Update visual
        
        if (isFull) {
            hargaTampil = hargaRefill + hargaTabung;
        } else {
            hargaTampil = hargaTabung; // Cuma wadah
        }
    } else {
        // Mode Refill / Tukar
        hargaTampil = hargaRefill;
    }

    // 4. Tampilkan ke Input Harga
    const inputHarga = document.getElementById('input-harga-custom');
    inputHarga.value = Number(hargaTampil).toLocaleString('id-ID');
    
    // Efek Kedip Kuning
    inputHarga.style.backgroundColor = '#fff3cd';
    setTimeout(() => { inputHarga.style.backgroundColor = 'transparent'; }, 200);
}

// C. UPDATE: Fungsi Hitung Harga & Animasi UI
function hitungHargaToggle() {
    const isFull = document.getElementById('toggle-isi-tabung').checked;
    const inputHarga = document.getElementById('input-harga-custom');

    // 1. Update UI (Warna & Teks)
    updateTampilanToggle(isFull);

    // 2. Hitung Harga
    let hargaBaru = 0;
    if (isFull) {
        hargaBaru = tempProductPOS.hargaTabung + tempProductPOS.hargaIsi;
    } else {
        hargaBaru = tempProductPOS.hargaTabung;
    }

    // 3. Update Input Harga dengan efek flash kuning (opsional, biar kelihatan berubah)
    inputHarga.style.backgroundColor = '#fff3cd'; // Kuning muda
    setTimeout(() => { inputHarga.style.backgroundColor = 'transparent'; }, 300);
    
    inputHarga.value = Number(hargaBaru).toLocaleString('id-ID');
    hitungHargaLevel();
}

// D. HELPER BARU: Update Tampilan Visual Toggle
function updateTampilanToggle(isActive) {
    const box = document.getElementById('box-toggle-tabung');
    const lblMain = document.getElementById('lbl-toggle-main');
    const lblSub = document.getElementById('lbl-toggle-sub');

    if (isActive) {
        // === KONDISI ON: PAKET LENGKAP ===
        box.style.border = "1px solid #198754";
        box.style.backgroundColor = "#f0fff4"; 
        
        // Ganti istilah jadi "Isi + Wadah"
        lblMain.innerText = "Isi + Wadah"; 
        lblMain.className = "d-block fw-bold text-success";
        lblSub.innerText = "Beli baru (Paket Lengkap)";
    } else {
        // === KONDISI OFF: WADAH KOSONG ===
        box.style.border = "1px solid #dc3545";
        box.style.backgroundColor = "#fff5f5"; 
        
        // Ganti istilah jadi "Wadah Kosong"
        lblMain.innerText = "Hanya Wadah Kosong";
        lblMain.className = "d-block fw-bold text-danger";
        lblSub.innerText = "Jual Tabung/Galon saja";
    }
}

// [UPDATE] 3. SUBMIT QTY (Menggunakan data tempProductPOS yang sudah dihitung)
function submitQtyPOS() {
    const qtyInput = document.getElementById('input-qty-pos');
    const hargaInput = document.getElementById('input-harga-custom');
    const elMsg = document.getElementById('qty-msg-error'); 
    
    const qty = Number(qtyInput.value);
    const hargaCustom = Number(hargaInput.value.replace(/\./g, '')); 

    // Reset Error
    elMsg.classList.add('d-none');
    elMsg.innerText = ''; // Bersihkan teks lama

    if(qty <= 0) { qtyInput.focus(); return; }

    const { nama, stok, mode, hppIsi, hppTabung } = tempProductPOS;

    // --- 1. TENTUKAN MODAL SAAT INI ---
    let modalSaatIni = 0;
    let labelTipe = '';
    
    if (mode === 'Beli Tabung Baru') {
        const isFull = document.getElementById('toggle-isi-tabung').checked;
        if (isFull) {
            // [UBAH DISINI] Gunakan istilah umum
            labelTipe = 'Baru (Isi + Wadah)'; 
            modalSaatIni = hppIsi + hppTabung; 
            
            // Cek Stok Isi
            let index = keranjangBelanja.findIndex(item => item.produkNama === nama && item.tipe === labelTipe);
            let currentQty = (index !== -1) ? keranjangBelanja[index].qty : 0;
            if((currentQty + qty) > stok) {
                elMsg.innerText = `Stok isi hanya ${stok}`;
                elMsg.classList.remove('d-none');
                return;
            }
        } else {
            // [UBAH DISINI] Gunakan istilah umum
            labelTipe = 'Wadah Kosong';
            modalSaatIni = hppTabung; 
        }
        } else {
            labelTipe = 'Tukar (Refill)';
            modalSaatIni = hppIsi;

        // Cek Stok Isi
        let index = keranjangBelanja.findIndex(item => item.produkNama === nama && item.tipe === labelTipe);
        let currentQty = (index !== -1) ? keranjangBelanja[index].qty : 0;
        if((currentQty + qty) > stok) {
            elMsg.innerText = `Stok isi hanya ${stok}`;
            elMsg.classList.remove('d-none');
            return;
        }
    }

    // --- 2. VALIDASI HARGA (PRIVASI AMAN) ---
    if (hargaCustom < modalSaatIni) {
        // [UPDATE] Pesan Error Generik (Tanpa Angka Modal)
        elMsg.innerText = "Harga terlalu rendah!";
        elMsg.classList.remove('d-none');
        
        // Efek getar/merah pada input
        hargaInput.classList.add('is-invalid');
        setTimeout(() => hargaInput.classList.remove('is-invalid'), 2000);
        hargaInput.focus();
        return; // Stop proses
    }

    // --- SIMPAN KE KERANJANG ---
    // --- SIMPAN KE KERANJANG (DENGAN DATA HPP) ---
    let index = keranjangBelanja.findIndex(item => item.produkNama === nama && item.tipe === labelTipe);

    if(index !== -1) {
       keranjangBelanja[index].qty += qty;
       keranjangBelanja[index].hargaSatuan = hargaCustom;
       keranjangBelanja[index].total = keranjangBelanja[index].qty * hargaCustom;
       // Update HPP Total (jika qty nambah)
       keranjangBelanja[index].totalHpp = keranjangBelanja[index].qty * modalSaatIni; 
    } else {
       keranjangBelanja.push({
          produkNama: nama,
          qty: qty,
          tipe: labelTipe, 
          hargaSatuan: hargaCustom, 
          total: qty * hargaCustom,
          // [BARU] Simpan HPP agar bisa divalidasi nanti
          hppSatuan: modalSaatIni, 
          totalHpp: qty * modalSaatIni
       });
    }
    
    bootstrap.Modal.getInstance(document.getElementById('modalInputQty')).hide();
    renderKeranjangPOS();
}

// 3. TAMBAHAN: Agar bisa tekan tombol "ENTER" di keyboard saat input qty
document.getElementById('input-qty-pos')?.addEventListener("keypress", function(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    submitQtyPOS();
  }
});

function toggleModeDiskon() {
    const btn = document.getElementById('btn-toggle-diskon');
    const input = document.getElementById('pos-input-diskon');
    
    if (diskonMode === 'Rp') {
        diskonMode = '%';
        btn.innerText = '%';
        btn.classList.add('active'); 
        input.placeholder = '0-100';
    } else {
        diskonMode = 'Rp';
        btn.innerText = 'Rp';
        btn.classList.remove('active');
        input.placeholder = 'Nominal';
    }

    // Reset nilai agar tidak error hitungan (misal angka 100.000 jadi 100.000%)
    input.value = '';
    
    // Hitung ulang keranjang
    renderKeranjangPOS();
}

// --- 2. UPDATE FUNGSI INPUT (GANTI YANG LAMA) ---
// --- 2. FUNGSI INPUT (FORMATTING) ---
function hitungDiskonRealtime(input) {
    // Ambil angka saja
    let raw = input.value.replace(/\D/g, ''); 
    let val = Number(raw);

    if (diskonMode === '%') {
        // Mode Persen: Batasi maks 100
        if (val > 100) { val = 100; raw = '100'; }
        if (val < 0) { val = 0; raw = '0'; }
        
        // Update input tanpa titik ribuan
        input.value = val; 
    } else {
        // Mode Rupiah: Format Ribuan
        if(raw !== '') {
            input.value = new Intl.NumberFormat('id-ID').format(raw);
        } else {
            input.value = '';
        }
    }
    
    // Panggil fungsi hitung total
    renderKeranjangPOS(); 
}

// --- 3. UPDATE RENDER KERANJANG (GANTI YANG LAMA) ---
function renderKeranjangPOS() {
   const tbody = document.getElementById('pos-cart-body');
   const emptyMsg = document.getElementById('empty-cart-msg');
   
   // 1. Cek jika keranjang kosong
   if(!keranjangBelanja || keranjangBelanja.length === 0) {
      tbody.innerHTML = '';
      emptyMsg.classList.remove('d-none');
      document.getElementById('pos-subtotal').innerText = 'Rp 0';
      document.getElementById('pos-grand-total').innerText = 'Rp 0';
      document.getElementById('cart-count-badge').innerText = '0 Item';
      document.getElementById('info-diskon-nominal').classList.add('d-none');
      return;
   }

   emptyMsg.classList.add('d-none');
   tbody.innerHTML = '';
   
   let grandTotal = 0;
   let totalItem = 0;

   // 2. Loop Keranjang & Hitung Subtotal
   keranjangBelanja.forEach((item, index) => {
      // Pastikan angka valid
      let totalBaris = Number(item.total) || 0;
      grandTotal += totalBaris;
      totalItem += Number(item.qty);
      
      let labelTipe = item.tipe; 
      let warnaClass = 'text-success'; 
      if(labelTipe.toLowerCase().includes('refill')) warnaClass = 'text-warning'; 
      else if (labelTipe.toLowerCase().includes('kosong')) warnaClass = 'text-danger';
      
      let badgeTipe = `<span class="${warnaClass} fw-bold" style="font-size:10px">● ${labelTipe}</span>`;

      tbody.innerHTML += `
      <tr>
         <td class="ps-3 py-3" style="width: 65%;">
            <div class="fw-bold text-dark mb-1 text-truncate" style="max-width:150px; font-size: 13px;">${item.produkNama}</div>
            <div class="d-flex align-items-center justify-content-between mb-2">
                ${badgeTipe}
                <small class="text-muted" style="font-size:10px;">@${rupiah(item.hargaSatuan)}</small>
            </div>
            <div class="input-group input-group-sm" style="width: 100px;">
                <button class="btn btn-outline-secondary px-2 py-0 d-flex align-items-center justify-content-center" type="button" onclick="ubahQty(${index}, -1)" style="height:26px;"><i class="material-icons" style="font-size:14px">remove</i></button>
                <input type="text" class="form-control text-center px-0 py-0 fw-bold bg-white border-secondary" value="${item.qty}" readonly style="font-size:13px; height: 26px; border-left:0; border-right:0;">
                <button class="btn btn-outline-primary px-2 py-0 d-flex align-items-center justify-content-center" type="button" onclick="ubahQty(${index}, 1)" style="height:26px;"><i class="material-icons" style="font-size:14px">add</i></button>
            </div>
         </td>
         <td class="text-end pe-3 py-3 align-top">
            <div class="fw-bold text-dark mb-2" style="font-size:13px;">${rupiah(totalBaris)}</div>
            <button class="btn btn-sm btn-light text-danger border-0 p-1 rounded-circle shadow-sm" onclick="hapusItemKeranjang(${index})"><i class="material-icons" style="font-size:18px">delete</i></button>
         </td>
      </tr>`;
   });

   // 3. LOGIKA DISKON (Fix perhitungan)
   const inputDiskon = document.getElementById('pos-input-diskon');
   const infoNominal = document.getElementById('info-diskon-nominal');
   
   // Ambil nilai input, buang titik ribuan agar jadi angka murni
   let rawVal = inputDiskon.value.replace(/\./g, '');
   let inputValue = Number(rawVal) || 0; 
   
   let nilaiPotonganRupiah = 0;

   if(diskonMode === '%') {
       // Rumus: Total * (Persen / 100)
       nilaiPotonganRupiah = grandTotal * (inputValue / 100);
       
       // Tampilkan info rupiah di bawah input persen
       if(inputValue > 0) {
           infoNominal.innerText = `Potongan: -${rupiah(nilaiPotonganRupiah)}`;
           infoNominal.classList.remove('d-none');
       } else {
           infoNominal.classList.add('d-none');
       }
   } else {
       // Rumus: Nominal langsung
       nilaiPotonganRupiah = inputValue;
       infoNominal.classList.add('d-none'); 
   }

   // Pastikan potongan tidak lebih besar dari total belanja
   if(nilaiPotonganRupiah > grandTotal) {
       nilaiPotonganRupiah = grandTotal; 
   }

   // 4. Hitung Final Total
   let finalTotal = grandTotal - nilaiPotonganRupiah;
   if(finalTotal < 0) finalTotal = 0;

   // 5. Update UI Angka
   document.getElementById('pos-subtotal').innerText = rupiah(grandTotal);
   document.getElementById('pos-grand-total').innerText = rupiah(finalTotal);
   document.getElementById('cart-count-badge').innerText = totalItem + ' Item';
}


// --- FUNGSI BARU: LOGIKA TAMBAH/KURANG QTY ---
function ubahQty(index, delta) {
    const item = keranjangBelanja[index];
    
    // 1. Logika Pengurangan (Jika 1 dikurang -> Konfirmasi Hapus)
    if(delta < 0 && item.qty === 1) {
        // Hapus langsung atau tanya dulu (opsional), di sini kita hapus langsung biar cepat
        keranjangBelanja.splice(index, 1);
        renderKeranjangPOS();
        return; 
    }

    // 2. Logika Penambahan (Cek Stok Dulu)
    if(delta > 0) {
        // Cari data produk asli di database lokal
        const produkDb = globalProdukList.find(p => p[1] === item.produkNama);
        if(produkDb) {
             const stokMax = Number(produkDb[4]); // Index 4 = Stok Isi
             
             // Hitung total qty item ini di keranjang 
             if(item.qty + delta > stokMax) {
                 return myAlert('Stok Terbatas', `Sisa stok gudang hanya ${stokMax}`, 'warning');
             }
        }
    }

    // 3. Update Angka
    item.qty += delta;
    item.total = item.qty * item.hargaSatuan; // Hitung ulang total harga
    
    // 4. Render Ulang Tampilan
    renderKeranjangPOS(); 
}

// Fungsi Pencarian Grid
function filterProdukGrid() {
   const keyword = document.getElementById('cari-produk-pos').value.toLowerCase();
   const filtered = globalProdukList.filter(p => p[1].toLowerCase().includes(keyword));
   renderProdukGrid(filtered);
}

// Override fungsi resetKeranjang agar compatible dengan POS
let originalReset = resetKeranjang;
resetKeranjang = function() {
    keranjangBelanja = [];
    renderKeranjangPOS();
}

function simpanProduk() {
    // 1. Ambil File Gambar
    const fileInput = document.getElementById('prod-file-gambar');
    const file = fileInput.files[0];
    
    // 2. Helper untuk membersihkan format Ribuan (titik) menjadi angka biasa
    const cleanNum = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.replace(/\./g, '') : '0';
    };

    // 3. Susun Data Form (Termasuk Field Baru untuk Tabung)
    // Update bagian ini di dalam simpanProduk()
    const dataForm = {
        sku: document.getElementById('prod-sku').value,
        kode: document.getElementById('prod-kode').value,
        nama: document.getElementById('prod-nama').value, 
        
        // HARGA REFILL (LEVEL 1, 2, 3)
        hargaJual: cleanNum('prod-jual'), 
        hargaJualRefill2: cleanNum('prod-jual-2'), // Baru
        hargaJualRefill3: cleanNum('prod-jual-3'), // Baru
        hargaBeli: cleanNum('prod-beli'), 
        
        // HARGA TABUNG (LEVEL 1, 2, 3)
        hargaJualTabung: cleanNum('prod-jual-tabung'),
        hargaJualTabung2: cleanNum('prod-jual-tabung-2'), // Baru
        hargaJualTabung3: cleanNum('prod-jual-tabung-3'), // Baru
        hargaBeliTabung: cleanNum('prod-beli-tabung'),
        
        stokIsi: document.getElementById('prod-isi').value, 
        stokKosong: document.getElementById('prod-kosong').value,
        gambar: null 
    };

    // Validasi Sederhana
    if(!dataForm.nama) return myAlert('Error', 'Nama produk wajib diisi!', 'warning');

    // 4. Fungsi Pengirim Data ke Backend (Google Script)
    const kirimData = (finalData) => {
        loading(true); // Nyalakan loading
        
        google.script.run
            .withSuccessHandler(() => { 
                loading(false); // Matikan loading
                document.getElementById('loading-upload')?.classList.add('d-none');
                
                // Reset Preview & Input File
                const imgPrev = document.getElementById('img-preview');
                if(imgPrev) {
                    imgPrev.classList.add('d-none');
                    imgPrev.src = '';
                }
                
                // Tutup Modal
                const modalEl = document.getElementById('modalProduk');
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if(modalInstance) modalInstance.hide(); 
                
                // Refresh Tabel Data Produk
                loadProduk(); 
                
                // Reset Form Input
                document.querySelectorAll('#modalProduk input').forEach(i => i.value = '');

                // Tampilkan Pesan Sukses
                myAlert('Sukses', 'Produk berhasil disimpan ke database!', 'success');
            })
            .withFailureHandler((err) => {
                loading(false);
                myAlert('Gagal', err.message, 'error');
            })
            .tambahProduk(finalData); // Panggil fungsi di Code.gs
    };
        
    // 5. LOGIKA UPLOAD GAMBAR
    if (file) {
        // Validasi ukuran (Maks 2MB)
        if (file.size > 2 * 1024 * 1024) {
            return myAlert('File Terlalu Besar', 'Maksimal ukuran gambar 2MB', 'error');
        }

        const loadingText = document.getElementById('loading-upload');
        if(loadingText) loadingText.classList.remove('d-none'); // Tampilkan teks loading upload
        
        const reader = new FileReader();
        reader.onload = function(e) {
            // Isi properti gambar dengan data file (base64)
            dataForm.gambar = {
                data: e.target.result.split(',')[1], // Ambil string base64 murni
                mimeType: file.type,
                fileName: 'PROD-' + Date.now() // Nama file unik
            };
            kirimData(dataForm); // Kirim setelah file terbaca
        };
        reader.readAsDataURL(file);
    } else {
        // Jika tidak ada gambar, kirim dataForm dengan gambar = null
        kirimData(dataForm);
    }
}

// [TAMBAHAN] Fungsi untuk Preview Gambar
function tampilkanPreview(input) {
    const preview = document.getElementById('img-preview');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();

        reader.onload = function(e) {
            preview.src = e.target.result; // Isi sumber gambar dengan hasil bacaan file
            preview.classList.remove('d-none'); // Munculkan gambar
        }

        reader.readAsDataURL(input.files[0]); // Mulai membaca file
    } else {
        // Jika user batal milih file, sembunyikan lagi gambarnya
        preview.src = '';
        preview.classList.add('d-none');
    }
}

function hapusProduk(n) { 
      myConfirm('Hapus Produk', `Yakin hapus produk ${n}?`, () => {
          loading(true);
          google.script.run.withSuccessHandler(() => {
              loading(false);
              loadProduk();
              myAlert('Info', 'Produk dihapus', 'success');
          }).hapusProduk(n);
      });
  }
  function updateHargaJual() {
    const sel = document.getElementById('kasir-produk');
    const price = sel.options[sel.selectedIndex]?.getAttribute('data-price') || 0;
    const qty = document.getElementById('kasir-qty').value;
    document.getElementById('kasir-total').innerText = rupiah(price * qty);
  }

  function hapusItemKeranjang(index) {
      // 1. Hapus item dari array data
      keranjangBelanja.splice(index, 1);
      
      // 2. Render ulang tampilan menggunakan fungsi POS yang baru
      renderKeranjangPOS(); 
  }

  function resetKeranjang() {
    keranjangBelanja = [];
    renderKeranjang();
  }

function prosesBayarFinal() {
    if(keranjangBelanja.length === 0) return myAlert('Keranjang Kosong', 'Belum ada barang yang diinput.', 'error');

    // 1. Cek Apakah ada Refill?
    let butuhTabungKosong = 0;
    keranjangBelanja.forEach(k => { 
        if(k.tipe === 'Tukar (Refill)') butuhTabungKosong += k.qty; 
    });

    // 2. JIKA ADA REFILL -> BUKA MODAL CEK FISIK (GATEKEEPER)
    if(butuhTabungKosong > 0) {
        // Reset Inputan
        document.getElementById('lbl-qty-refill').innerText = butuhTabungKosong;
        document.getElementById('input-fisik-tabung').value = ''; 
        document.getElementById('msg-error-tabung').classList.add('d-none');
        
        // Buka Modal
        new bootstrap.Modal(document.getElementById('modalCekTabung')).show();
        
        // Auto Focus ke input agar kasir langsung ketik
        setTimeout(() => document.getElementById('input-fisik-tabung').focus(), 500);
        
    } else {
        // 3. JIKA TIDAK ADA REFILL (BELI BARU SEMUA) -> LANGSUNG EKSEKUSI
        eksekusiBayarUtama();
    }
}

// Fungsi dipanggil saat tombol LANJUT BAYAR di modal diklik
function validasiTabung() {
    // 1. Ambil Angka Target & Inputan
    let target = Number(document.getElementById('lbl-qty-refill').innerText);
    let input = Number(document.getElementById('input-fisik-tabung').value);
    
    // 2. VALIDASI KERAS (HARD BLOCK)
    if(input !== target) {
        // Jika angka beda, munculkan error dan JANGAN LANJUT
        const elMsg = document.getElementById('msg-error-tabung');
        elMsg.classList.remove('d-none');
        
        // Mainkan animasi getar (optional, visual feedback)
        document.getElementById('input-fisik-tabung').classList.add('is-invalid');
        return; 
    }

    // 3. Jika Cocok, Tutup Modal & Lanjut Bayar
    bootstrap.Modal.getInstance(document.getElementById('modalCekTabung')).hide();
    eksekusiBayarUtama();
}

// Tambahan: Supaya bisa Enter di input tabung
document.getElementById('input-fisik-tabung')?.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') validasiTabung();
});
// TAMBAHAN: Reset Error saat user mulai mengetik ulang
document.getElementById('input-fisik-tabung')?.addEventListener('input', function() {
    this.classList.remove('is-invalid'); // Hilangkan border merah
    document.getElementById('msg-error-tabung').classList.add('d-none'); // Sembunyikan pesan error
});

// --- INI LOGIKA PEMBAYARAN UTAMA (YANG TADINYA ADA DI DALAM PROSESBAYARFINAL) ---
// Kita pisahkan jadi fungsi sendiri agar bisa dipanggil dari dua tempat
// --- 4. FUNGSI BAYAR (FIX DATA SAVE) ---
function eksekusiBayarUtama() {
    // Hitung ulang angka final untuk dikirim ke database
    // Kita tidak ambil dari Text HTML (rawan error), tapi hitung ulang dari data mentah
    
    let totalBelanjaMurni = 0;
    let totalHPP = 0;
    
    keranjangBelanja.forEach(item => {
        totalBelanjaMurni += Number(item.total);
        totalHPP += Number(item.totalHpp || 0); 
    });

    // Ambil Data Diskon
    const inputDiskon = document.getElementById('pos-input-diskon');
    let inputValue = Number(inputDiskon.value.replace(/\./g, '')) || 0;
    let nilaiDiskonFinal = 0;

    if(diskonMode === '%') {
        nilaiDiskonFinal = totalBelanjaMurni * (inputValue / 100);
    } else {
        nilaiDiskonFinal = inputValue;
    }

    // Proteksi Diskon Kebesaran
    if(nilaiDiskonFinal > totalBelanjaMurni) {
        nilaiDiskonFinal = totalBelanjaMurni;
    }

    let grandTotalFinal = totalBelanjaMurni - nilaiDiskonFinal;

    // Cek Profit/Rugi
    if (grandTotalFinal < totalHPP) {
        let selisih = totalHPP - grandTotalFinal;
        return myAlert('Rugi', `Diskon kebesaran! Harga jual di bawah modal. Selisih: ${rupiah(selisih)}`, 'error');
    }
    
    // Validasi Pelanggan & Metode
    const pelangganDipilih = document.getElementById('kasir-pelanggan').value;
    const metodeDipilih = document.getElementById('pos-metode-bayar').value;
    const tglJatuhTempo = document.getElementById('pos-jatuh-tempo').value;

     if (!pelangganDipilih || pelangganDipilih === "") {
        return myAlert('Pilih Pelanggan', 'Anda belum memilih pelanggan.', 'warning');
    }

    if(metodeDipilih === 'Hutang') {
        if(pelangganDipilih === 'Umum') return myAlert('Data Belum Lengkap', 'Hutang tidak boleh akun Umum.', 'warning');
        if(!tglJatuhTempo) return myAlert('Data Belum Lengkap', 'Isi tanggal jatuh tempo.', 'warning');
    }

    // Konfirmasi
    myConfirm('Konfirmasi Pembayaran', `Total: ${rupiah(grandTotalFinal)}\n(Diskon: ${rupiah(nilaiDiskonFinal)}) \n\nSimpan data ini?`, () => {
        const payload = {
            pelanggan: pelangganDipilih,
            kasir: currentUser.nama || 'Admin',
            metode: metodeDipilih,
            jatuhTempo: (metodeDipilih === 'Hutang') ? tglJatuhTempo : '', 
            items: keranjangBelanja,
            diskon: nilaiDiskonFinal, // PENTING: Kirim nominal Rupiah ke DB
            totalFinal: grandTotalFinal
        };

        loading(true);
        google.script.run.withSuccessHandler(res => {
           loading(false);
           const idTrxSementara = 'KBA-' + Date.now(); 
           tampilkanInvoice(payload, idTrxSementara);
           
           // Reset Form Setelah Sukses
           document.getElementById('kasir-pelanggan').value = ""; 
           document.getElementById('pos-input-diskon').value = '';
           document.getElementById('info-diskon-nominal').classList.add('d-none');
           
           // Reset Keranjang
           keranjangBelanja = [];
           renderKeranjangPOS(); // Render keranjang kosong
           
           // Reload Data Lain
           loadProduk(); loadDashboard(); loadKeuangan();
        }).withFailureHandler(err => {
           loading(false); myAlert('Gagal', err.message, 'error');
        }).simpanTransaksiBulk(payload);
    });
}

  function loadNotifHutang() {
    google.script.run.withSuccessHandler(jumlah => {
        const badge = document.getElementById('notif-badge');
        if(jumlah > 0) {
            badge.innerText = jumlah;
            badge.classList.remove('d-none');
        } else {
            badge.classList.add('d-none');
        }
    }).getJumlahJatuhTempo();
}

// Panggil fungsi ini di window.onload agar saat buka aplikasi langsung cek
// Tambahkan di dalam window.onload = function() { ... loadNotifHutang(); ... }

// --- UPDATE FRONTEND NOTIFIKASI ---

// Panggil fungsi ini di dalam `loadSemuaDataAwal()` atau saat login sukses
function loadNotifikasiLonceng() {
  google.script.run
    .withSuccessHandler(renderNotifikasi)
    .getNotifikasiData();
}

function renderNotifikasi(data) {
  const badge = document.getElementById('notif-badge');
  const container = document.getElementById('notif-list');
  
  // 1. Bersihkan isi list sebelumnya
  container.innerHTML = '';
  
  // 2. JIKA DATA KOSONG / FRESH
  if (!data || data.length === 0) {
    badge.classList.add('d-none'); // [PERBAIKAN] Gunakan classList.add
    container.innerHTML = '<li><a class="dropdown-item text-muted text-center small" href="#" onclick="return false;">Tidak ada notifikasi baru</a></li>';
    return; 
  }
  
  // 3. JIKA ADA DATA
  // Tampilkan Angka di Badge
  badge.innerText = data.length > 9 ? '9+' : data.length;
  badge.classList.remove('d-none'); // [PERBAIKAN] Hapus class d-none agar badge muncul
  
  // Loop data untuk ditampilkan ke list
  data.forEach(item => {
      // Tentukan Ikon & Warna (Sesuai Material Icons)
      let iconCode = 'info'; 
      let warnaBg = 'bg-light';
      let warnaIcon = 'text-warning';

      if (item.tipe === 'hutang') {
          iconCode = 'person'; 
          warnaBg = 'bg-danger-subtle';
          warnaIcon = 'text-danger';
      } else if (item.tipe === 'kasbon') {
          iconCode = 'payments'; 
          warnaBg = 'bg-warning-subtle';
          warnaIcon = 'text-warning';
      } else if (item.tipe === 'stok') {
          iconCode = 'inventory_2'; 
          warnaBg = 'bg-danger-subtle'; 
          warnaIcon = 'text-danger';
      }

      let html = `
        <li>
          <a class="dropdown-item d-flex align-items-center gap-3 py-2" href="#" onclick="return false;">
            <div class="${warnaBg} rounded-circle p-2 d-flex justify-content-center align-items-center" style="width: 35px; height: 35px;">
                <i class="material-icons ${warnaIcon}" style="font-size: 18px;">${iconCode}</i>
            </div>
            <div>
              <div class="fw-bold text-dark" style="font-size: 13px;">${item.judul}</div>
              <div class="text-muted" style="font-size: 11px; line-height: 1.2;">${item.pesan}</div>
            </div>
          </a>
        </li>
        <li><hr class="dropdown-divider my-0"></li>
      `;
      
      container.insertAdjacentHTML('beforeend', html);
  });
}
// [UPDATE] Fungsi Update Harga Beli dengan Format Ribuan
function updateHargaBeli() {
    // 1. Ambil Qty
    var qtyInput = document.getElementById('beli-qty').value;
    var qty = parseInt(qtyInput) || 0;

    // 2. Ambil Harga (Langsung dari input text, bukan dari option dropdown lagi)
    var hargaInput = document.getElementById('beli-harga').value;
    // Hapus karakter non-angka jika ada format Rp, lalu parse
    var harga = parseInt(String(hargaInput).replace(/\D/g, '')) || 0;

    // 3. Hitung Subtotal
    var subtotal = qty * harga;

    // 4. Tampilkan (Gunakan fungsi rupiah() jika anda punya, atau toLocaleString)
    // Jika function rupiah() ada: 
    // document.getElementById('beli-subtotal-label').innerText = rupiah(subtotal);
    
    // Jika tidak yakin, pakai ini:
    document.getElementById('beli-subtotal-label').innerText = "Rp " + subtotal.toLocaleString('id-ID');
}

// [BARU] Fungsi khusus saat Ganti Produk di Dropdown
function setHargaOtomatis() {
  const sel = document.getElementById('beli-produk');
  const hargaInput = document.getElementById('beli-harga');
  
  // 1. Ambil harga dari database (atribut data-buy)
  const hargaDatabase = sel.options[sel.selectedIndex]?.getAttribute('data-buy') || 0;
  
  // 2. Paksa Update Input Harga dengan format Ribuan
  hargaInput.value = Number(hargaDatabase).toLocaleString('id-ID');
  
  // 3. Panggil fungsi lama untuk hitung Subtotal
  updateHargaBeli(); 
}

function tambahKeKeranjangBeli() {
    // [FIX] Ambil nama produk dari Hidden Input (yang valid)
    // Jika kosong (user ngetik manual), ambil dari Input Text biasa
    var produkNama = document.getElementById('beli-produk-selected').value;
    if (!produkNama) {
        produkNama = document.getElementById('beli-cari-produk').value;
    }

    // [FIX] Definisikan variabel 'prod' agar kode bawahnya jalan
    var prod = produkNama;

    // Ambil data lain
    var qty = parseInt(document.getElementById('beli-qty').value) || 0;
    var harga = parseInt(String(document.getElementById('beli-harga').value).replace(/\D/g, '')) || 0;
    var isTukar = document.getElementById('beli-tukar').checked;

    // Validasi
    if (!prod) {
        Swal.fire('Eits', 'Pilih atau ketik nama produk dulu!', 'warning');
        return;
    }
    if (qty <= 0) {
        Swal.fire('Eits', 'Jumlah (Qty) minimal 1', 'warning');
        return;
    }

    // Hitung Total Item Ini
    var total = qty * harga;

    // Masukkan ke Array Global Keranjang
    // Pastikan variabel global 'keranjangBeli' sudah ada di paling atas script
    keranjangBeli.push({
        produk: prod,
        qty: qty,
        harga: harga,
        total: total,
        isTukar: isTukar
    });

    // Render Ulang Tabel
    renderKeranjangBeli();

    // Reset Input Form
    document.getElementById('beli-cari-produk').value = '';     // Reset pencarian
    document.getElementById('beli-produk-selected').value = ''; // Reset hidden ID
    document.getElementById('beli-qty').value = '';
    document.getElementById('beli-harga').value = '';
    document.getElementById('beli-subtotal-label').innerText = 'Rp 0';
}

function renderKeranjangBeli() {
    const tb = document.querySelector('#tabel-keranjang-beli tbody');
    tb.innerHTML = '';
    let grandTotal = 0;

    keranjangBeli.forEach((item, index) => {
        grandTotal += item.total;
        let badgeTukar = item.isTukar ? 
            '<span class="badge bg-warning text-dark" style="font-size:10px">Tukar Tabung</span>' : 
            '<span class="badge bg-success" style="font-size:10px">Tabung Baru</span>';
        
        tb.innerHTML += `
          <tr>
              <td class="fw-bold">${item.produk}</td>
              <td>${badgeTukar}</td>
              <td>${item.qty}</td>
              <td>${rupiah(item.total)}</td>
              <td>
                  <button class="btn btn-sm btn-light text-danger" onclick="hapusItemBeli(${index})">
                      <i class="material-icons" style="font-size:16px">delete</i>
                  </button>
              </td>
          </tr>
        `;
    });

    document.getElementById('label-grand-total-beli').innerText = rupiah(grandTotal);
    
    // [HAPUS 2 BARIS PEMBERSIH INPUT DARI SINI]
}

  function hapusItemBeli(index) {
      keranjangBeli.splice(index, 1);
      renderKeranjangBeli();
  }

  function resetKeranjangBeli() {
      keranjangBeli = [];
      renderKeranjangBeli();
  }

function prosesBeliFinal() {
  // 1. Ambil data keranjang (sesuaikan dengan variabel global keranjang Anda)
  // Asumsi variabel global Anda bernama: keranjangBeli
  if (!keranjangBeli || keranjangBeli.length === 0) {
    return Swal.fire('Kosong', 'Belum ada barang di daftar belanja', 'warning');
  }

  // 2. Ambil Input Baru
  const noFaktur = document.getElementById('beli-noFaktur').value;
  const akunBayar = document.getElementById('beli-akunBayar').value;

  if (!noFaktur) {
    return Swal.fire('Wajib', 'Mohon isi Nomor Faktur Supplier', 'warning');
  }
  if (!akunBayar) {
    return Swal.fire('Wajib', 'Pilih Akun Pembayaran', 'warning');
  }

  // 3. Siapkan Object Data
  const dataKirim = {
    supplier: document.getElementById('beli-supplier').value, // Atau ambil dari variabel global
    noFaktur: noFaktur,
    akunBayar: akunBayar,
    grandTotal: parseInt(document.getElementById('label-grand-total-beli').innerText.replace(/\D/g,'')) || 0,
    items: keranjangBeli
  };

  // 4. Kirim ke Server
  loading(true); // Jika punya fungsi loading
  google.script.run
    .withSuccessHandler(function(res) {
      loading(false);
      Swal.fire('Sukses', res, 'success');
      resetKeranjangBeli();
      document.getElementById('beli-noFaktur').value = ''; // Reset input
    })
    .simpanPembelianBulk(dataKirim);
}

// --- INIT PAGE RETUR (Panggil saat menu diklik) ---
function loadPageRetur() {
  // Switch tampilan (logika ganti page anda)
  document.querySelectorAll('.page-section').forEach(el => el.classList.add('d-none'));
  document.getElementById('page-retur-pembelian').classList.remove('d-none');
  
  // Load Akun ke Dropdown Retur (Reuse data akun jika ada)
  google.script.run.withSuccessHandler(function(list){
     let html = '';
     list.forEach(a => html += `<option value="${a.nama}">${a.nama}</option>`);
     document.getElementById('retur-akun-masuk').innerHTML = html;
     // Sekalian update dropdown beli jika belum
     document.getElementById('beli-akunBayar').innerHTML = html;
  }).getDaftarAkun(); 
}

// --- CARI FAKTUR ---
function cariFakturRetur() {
  const kataKunci = document.getElementById('retur-cari-input').value;
  if(!kataKunci) return Swal.fire('Input', 'Masukkan nomor faktur!', 'info');

  google.script.run.withSuccessHandler(function(data) {
    const tbody = document.getElementById('tabel-hasil-retur');
    tbody.innerHTML = '';
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center">Data tidak ditemukan</td></tr>';
      return;
    }

    data.forEach(row => {
      // Kita kirim object row ke fungsi pilih via tombol
      // row berisi: {idBeli, tanggal, noFaktur, produk, qtyAwal, hargaTotal}
      // Kita hitung harga satuan kasar:
      let hargaSatuan = Math.round(row.hargaTotal / row.qtyAwal);
      
      let btn = `<button class="btn btn-sm btn-outline-danger rounded-pill" 
                  onclick="pilihItemRetur('${row.noFaktur}', '${row.produk}', ${hargaSatuan})">
                  <i class="material-icons fs-6">undo</i> Retur
                 </button>`;

      let tr = `
        <tr>
          <td>${row.tanggal}</td>
          <td><span class="badge bg-secondary">${row.noFaktur}</span></td>
          <td>${row.produk}</td>
          <td>${row.qtyAwal} Unit</td>
          <td>${btn}</td>
        </tr>
      `;
      tbody.innerHTML += tr;
    });
  }).cariFakturPembelianServer(kataKunci);
}

// --- PILIH ITEM UNTUK DIRETUR ---
function pilihItemRetur(faktur, produk, hargaSatuan) {
  document.getElementById('form-retur-panel').classList.remove('d-none');
  
  document.getElementById('retur-faktur-asal').value = faktur;
  document.getElementById('retur-nama-produk').value = produk;
  document.getElementById('retur-harga').value = hargaSatuan;
  document.getElementById('retur-qty').value = '';
  document.getElementById('retur-total-show').innerText = 'Rp 0';
}

// --- HITUNG TOTAL REFUND ---
function hitungRefund() {
  let qty = document.getElementById('retur-qty').value || 0;
  let harga = document.getElementById('retur-harga').value || 0;
  let total = qty * harga;
  document.getElementById('retur-total-show').innerText = 'Rp ' + total.toLocaleString('id-ID');
}

// --- PROSES RETUR FINAL ---
function prosesReturFinal() {
  const data = {
    noFaktur: document.getElementById('retur-faktur-asal').value,
    produk: document.getElementById('retur-nama-produk').value,
    qtyRetur: document.getElementById('retur-qty').value,
    totalRefund: parseInt(document.getElementById('retur-total-show').innerText.replace(/\D/g,'')),
    akunMasuk: document.getElementById('retur-akun-masuk').value,
    alasan: 'Retur Barang via Web'
  };

  if (data.qtyRetur <= 0) return Swal.fire('Error', 'Qty retur harus lebih dari 0', 'error');

  google.script.run.withSuccessHandler(function(res) {
    if (res.status === 'success') {
      Swal.fire('Berhasil', 'Retur tercatat. Stok berkurang, Saldo bertambah.', 'success');
      
      // CETAK STRUK
      cetakBuktiRetur(res, data);
      
      // Reset Form
      document.getElementById('form-retur-panel').classList.add('d-none');
      document.getElementById('tabel-hasil-retur').innerHTML = '';
      document.getElementById('retur-cari-input').value = '';
    }
  }).prosesReturPembelianFinal(data);
}

// --- FUNGSI CETAK ---
function cetakBuktiRetur(res, data) {
  let w = window.open('', 'PRINT', 'height=500,width=400');
  w.document.write(`
    <html>
    <body style="font-family: monospace; padding: 20px;">
      <h3 style="text-align:center; border-bottom: 1px dashed #000; padding-bottom:10px;">BUKTI RETUR PEMBELIAN</h3>
      <div>ID Retur: ${res.idRetur}</div>
      <div>Tanggal : ${res.tgl}</div>
      <br>
      <div>Faktur Asal : ${data.noFaktur}</div>
      <div>Produk      : ${data.produk}</div>
      <div>Qty Retur   : ${data.qtyRetur}</div>
      <div style="text-align:right; font-weight:bold; margin-top:10px;">TOTAL REFUND: Rp ${data.totalRefund.toLocaleString()}</div>
      <br>
      <div>Dana masuk ke: ${data.akunMasuk}</div>
      <br>
      <center style="border-top: 1px dashed #000; padding-top:10px;">Barang dikembalikan ke Supplier</center>
    </body>
    </html>
  `);
  w.document.close();
  w.focus();
  w.print();
  w.close();
}


// Panggil fungsi ini saat halaman Pembelian dibuka (misal di showPage('pembelian'))
function loadAkunUntukPembelian() {
  const elSelect = document.getElementById('beli-akunBayar');
  elSelect.innerHTML = '<option value="">Memuat data...</option>';

  google.script.run.withSuccessHandler(function(dataAkun) {
      let html = '<option value="" disabled selected>-- Pilih Akun Pembayaran --</option>';
      
      // Tambahkan Opsi Hutang (Opsional, jika pembelian bisa hutang ke supplier)
      html += '<option value="Hutang" class="text-danger fw-bold">Hutang (Tempo)</option>'; 
      
      dataAkun.forEach(akun => {
          // Format saldo ke Rupiah
          let saldoFmt = Number(akun.saldo).toLocaleString('id-ID');
          html += `<option value="${akun.nama}">${akun.nama} (Saldo: Rp ${saldoFmt})</option>`;
      });

      elSelect.innerHTML = html;
  }).getDaftarAkun();
}

// ==========================================
// 2. LOGIKA PENCARIAN PRODUK (AUTOCOMPLETE)
// ==========================================

let cacheProdukList = []; // Variabel global untuk menyimpan daftar produk sementara

// Fungsi untuk memuat data produk sekali saja saat halaman dimuat
function loadDataProdukGlobal() {
   google.script.run.withSuccessHandler(function(data){
       // Data produk dari server: [ID, Nama, Jual, Beli, StokIsi, StokKosong, ...]
       // Kita mapping agar mudah dicari
       cacheProdukList = data.map(row => {
          return {
             nama: row[1],      // Nama Produk
             hargaBeli: row[3], // Harga Beli (Default)
             stok: row[4]       // Stok Isi Sekarang
          };
       });
   }).getData('PRODUK'); // Pastikan fungsi getData('PRODUK') bisa diakses atau buat wrapper di CODE.GS
}

// Fungsi dipanggil saat mengetik di kolom pencarian produk
function filterProdukBeli() {
    const input = document.getElementById('beli-cari-produk');
    const keyword = input.value.toLowerCase();
    const container = document.getElementById('hasil-cari-produk-beli');
    
    if(keyword.length < 1) {
        container.classList.add('d-none');
        return;
    }

    // Filter dari cacheProdukList
    const filtered = cacheProdukList.filter(item => item.nama.toLowerCase().includes(keyword));

    let html = '';
    if(filtered.length === 0) {
        html = '<div class="list-group-item text-muted small">Produk tidak ditemukan</div>';
    } else {
        filtered.forEach(item => {
            // Saat diklik, panggil fungsi pilihProduk
            // Kita kirim nama dan harga belinya
            html += `
            <a href="javascript:void(0)" class="list-group-item list-group-item-action py-2" 
              onclick="pilihProdukBeli('${item.nama}', ${item.hargaBeli})">
                <div class="fw-bold text-dark">${item.nama}</div>
                <div class="d-flex justify-content-between small text-muted">
                    <span>HPP: Rp ${Number(item.hargaBeli).toLocaleString()}</span>
                    <span>Stok: ${item.stok}</span>
                </div>
            </a>
            `;
        });
    }

    container.innerHTML = html;
    container.classList.remove('d-none');
}

// Fungsi saat produk dipilih dari list
function pilihProdukBeli(namaProduk, hargaBeli) {
    // 1. Isi Input Teks (Visual)
    document.getElementById('beli-cari-produk').value = namaProduk;
    
    // 2. Isi Hidden Input (Data Valid)
    document.getElementById('beli-produk-selected').value = namaProduk; 
    
    // 3. Isi Harga Beli Otomatis ke Input Harga
    document.getElementById('beli-harga').value = hargaBeli;
    
    // 4. Sembunyikan Suggestion
    document.getElementById('hasil-cari-produk-beli').classList.add('d-none');
    
    // 5. [PENTING] Trigger update subtotal (barangkali Qty sudah diisi duluan)
    updateHargaBeli(); 
}

// Hapus hasil pencarian jika klik di luar area
document.addEventListener('click', function(e) {
    if (!e.target.closest('#hasil-cari-produk-beli') && !e.target.closest('#beli-cari-produk')) {
        document.getElementById('hasil-cari-produk-beli').classList.add('d-none');
    }
});
// --- javascript ---

  // --- RIWAYAT TRANSAKSI ---

function loadRiwayatData() {
    loading(true);
    google.script.run
      .withFailureHandler(err => {
         loading(false);
         myAlert('Error', err, 'error');
      })
      .withSuccessHandler(data => {
         loading(false);
         globalRiwayatData = data; // Simpan ke variabel global

         const tb = document.querySelector('#tabel-riwayat tbody');
         const thead = document.querySelector('#tabel-riwayat thead tr');
         
         // Update Header Tabel Sesuai Permintaan
         thead.innerHTML = `
            <th>ID & Waktu</th>
            <th>Pelanggan</th>
            <th>Total</th>
            <th>Aksi</th>
         `;

         tb.innerHTML = '';
         
         if (!data || data.length === 0) {
            tb.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada data transaksi.</td></tr>';
            return;
         }
  
         data.forEach((trx, index) => {
            let tgl = '-';
            try { tgl = new Date(trx.waktu).toLocaleString('id-ID'); } catch(e) {}
            
            // Render Baris (Row)
            tb.innerHTML += `
              <tr>
                 <td>
                    <span class="fw-bold text-primary">${trx.id}</span><br>
                    <small class="text-muted">${tgl}</small>
                 </td>
                 <td>${trx.pelanggan} <br> <small class="text-muted">Kasir: ${trx.kasir}</small></td>
                 <td class="fw-bold">${rupiah(trx.totalBayar)}</td>
                 <td>
                   <button class="btn btn-sm btn-info text-white" onclick="viewDetail(${index})">
                      <i class="material-icons align-middle" style="font-size:16px">visibility</i> View
                   </button>
                 </td>
              </tr>
            `;
         });
      }).getRiwayatTransaksi();
}

// Fungsi untuk Membuka Modal Detail
function viewDetail(index) {
    const trx = globalRiwayatData[index]; // Ambil data dari variabel global berdasarkan index
    if(!trx) return;

    // Isi Info Header Modal
    document.getElementById('det-id').innerText = trx.id;
    document.getElementById('det-pelanggan').innerText = trx.pelanggan;
    document.getElementById('det-waktu').innerText = new Date(trx.waktu).toLocaleString('id-ID');
    
    // Isi Tabel Detail Item
    const tb = document.querySelector('#tabel-detail-trx tbody');
    tb.innerHTML = '';
    
    trx.items.forEach(item => {
        tb.innerHTML += `
            <tr>
                <td>${item.produk} <br> <small class="text-muted">${item.tipe}</small></td>
                <td class="text-center">${item.qty}</td>
                <td class="text-end">${rupiah(item.hargaTotal)}</td>
            </tr>
        `;
    });

    // Isi Grand Total di Bawah Modal
    document.getElementById('det-total').innerText = rupiah(trx.totalBayar);

    // Tampilkan Modal
    new bootstrap.Modal(document.getElementById('modalDetailTrx')).show();
}

  function aksiRetur(id, produk, qty, tipe) {
     // Menggunakan myConfirm (Modal) agar konsisten dengan UI
     myConfirm('Retur Barang', `Yakin ingin membatalkan/retur item ini?\n\n${produk} (${qty})\n\nStok akan dikembalikan ke sistem.`, () => {
        loading(true);
        google.script.run.withSuccessHandler(res => {
           loading(false);
           myAlert('Sukses', res, 'success');
           loadRiwayatData();
           loadProduk(); // Update stok di tabel produk
        }).prosesRetur(id, produk, qty, tipe, 'PARTIAL');
     });
  }

  function filterRiwayat() {
    const k = document.getElementById('cari-trx').value.toLowerCase();
    document.querySelectorAll('#tabel-riwayat tbody tr').forEach(tr => {
       if(tr.innerText.toLowerCase().includes(k)) {
          tr.style.display = '';
       } else {
          tr.style.display = 'none';
       }
    });
  }

  function aksiRetur(id, produk, qty, tipe) {
     if(confirm(`Yakin ingin meretur/membatalkan item ini?\n\n${produk} (${qty})\n\nStok akan dikembalikan.`)) {
        loading(true);
        google.script.run.withSuccessHandler(res => {
           loading(false);
           alert(res);
           loadRiwayatData();
           loadProduk(); // Update stok
        }).prosesRetur(id, produk, qty, tipe, 'PARTIAL');
     }
  }

  function filterRiwayat() {
    const k = document.getElementById('cari-trx').value.toLowerCase();
    document.querySelectorAll('#tabel-riwayat tbody tr').forEach(tr => {
       tr.style.display = tr.innerText.toLowerCase().includes(k) ? '' : 'none';
    });
  }

  // 2. FUNGSI LOAD DATA
function loadRiwayatJual() {
   loading(true);
   google.script.run.withSuccessHandler(data => {
      loading(false);
      dataJualTemp = data; // Simpan ke global
      renderTabelRiwayat('tabel-riwayat-jual', data, 'JUAL');
   }).getRiwayatTransaksi(); // Fungsi lama (sudah diupdate grouping)
}

function loadRiwayatBeli() {
   loading(true);
   google.script.run.withSuccessHandler(data => {
      loading(false);
      dataBeliTemp = data; // Simpan ke global
      renderTabelRiwayat('tabel-riwayat-beli', data, 'BELI');
   }).getRiwayatPembelian(); // Fungsi baru di Code.gs
}

// 3. RENDER TABEL GENERIK
// --- LOGIC RENDER & FILTER RIWAYAT YANG DIPERBAIKI ---

// 1. UPDATE FUNGSI RENDER TABEL (Agar menyimpan Data Waktu)
function renderTabelRiwayat(tableId, data, tipe) {
   const tb = document.querySelector(`#${tableId} tbody`);
   tb.innerHTML = '';

   if(!data || data.length === 0) { 
      tb.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-muted">Belum ada data transaksi.</td></tr>'; 
      return;
   }

   data.forEach((trx, index) => {
      let dateObj = new Date(trx.waktu);
      let tglStr = dateObj.toLocaleString('id-ID');
      let timestamp = dateObj.getTime();

      // [BARU] Logika Tag Retur
      let tagRetur = '';
      if (trx.isRetur) {
          tagRetur = `<br><span class="badge bg-danger border border-light shadow-sm mt-1" style="font-size:9px; letter-spacing:0.5px;">[ TELAH DI RETUR ]</span>`;
      }

      tb.innerHTML += `
        <tr data-ts="${timestamp}"> 
           <td>
              <span class="fw-bold text-primary" style="font-size:0.9rem">${trx.id}</span>
              ${tagRetur} <br>
              <small class="text-muted" style="font-size:0.8rem">${tglStr}</small>
           </td>
           <td>
              <span class="fw-bold text-dark">${trx.pelanggan}</span>
              ${trx.kasir ? '<br><small class="text-muted">Kasir: '+trx.kasir+'</small>' : ''}
           </td>
           <td class="fw-bold">${rupiah(trx.totalBayar)}</td>
           <td>
             <button class="btn btn-sm btn-info text-white rounded-pill px-3" onclick="viewDetailTrx('${tipe}', ${index})">
               <i class="material-icons align-middle" style="font-size:14px">visibility</i> View
             </button>
           </td>
        </tr>`;
   });
}

// 2. FUNGSI FILTER UTAMA (Cari Text + Tanggal)
function terapkanFilter(tipe) {
    let tableId, inputStart, inputEnd, inputText;

    // Tentukan ID elemen berdasarkan Tipe (JUAL / BELI)
    if (tipe === 'JUAL') {
        tableId = 'tabel-riwayat-jual';
        inputStart = 'filter-jual-start';
        inputEnd = 'filter-jual-end';
        inputText = 'filter-jual-text';
    } else {
        tableId = 'tabel-riwayat-beli';
        inputStart = 'filter-beli-start';
        inputEnd = 'filter-beli-end';
        inputText = 'filter-beli-text';
    }

    // Ambil Nilai dari Input
    const keyword = document.getElementById(inputText).value.toLowerCase();
    const startDateVal = document.getElementById(inputStart).value;
    const endDateVal = document.getElementById(inputEnd).value;

    // Konversi tanggal filter ke Timestamp (00:00:00 dan 23:59:59)
    let startTs = startDateVal ? new Date(startDateVal).setHours(0,0,0,0) : 0;
    let endTs = endDateVal ? new Date(endDateVal).setHours(23,59,59,999) : 9999999999999; 

    // Loop semua baris di tabel
    const rows = document.querySelectorAll(`#${tableId} tbody tr`);
    let foundCount = 0;

    rows.forEach(row => {
        // Ambil data dari baris
        const textContent = row.innerText.toLowerCase();
        const rowTs = Number(row.getAttribute('data-ts')); // Ambil timestamp tersembunyi

        // Cek Logika Filter
        const matchText = textContent.includes(keyword);
        const matchDate = rowTs >= startTs && rowTs <= endTs;

        // Tampilkan jika Text COCOK -DAN- Tanggal MASUK RANGE
        if (matchText && matchDate) {
            row.style.display = '';
            foundCount++;
        } else {
            row.style.display = 'none';
        }
    });

    if(foundCount === 0) {
       // Opsional: Tampilkan pesan jika tidak ada hasil
       // myAlert('Info', 'Data tidak ditemukan dengan filter tersebut.');
    }
}

// --- KONFIGURASI TANGGAL (FLATPICKR) ---

// --- KONFIGURASI TANGGAL (FIX ANTI BLANK) ---
function initTanggal() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1); 

    const baseConfig = {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d/m/Y",
        locale: "id",
        allowInput: true,
        disableMobile: "true"
    };

    // 1. Tambahkan #dash-filter-start
    flatpickr("#filter-jual-start, #filter-beli-start, #filter-keu-start, #lap-start, #dash-filter-start", {
        ...baseConfig,
        defaultDate: firstDay 
    });

    // 2. Tambahkan #dash-filter-end
    flatpickr("#filter-jual-end, #filter-beli-end, #filter-keu-end, #lap-end, #dash-filter-end", {
        ...baseConfig,
        defaultDate: today 
    });

    // 3. Init Kolom Jatuh Tempo (Set Default: 7 Hari lagi)
    const nextWeek = new Date();
    nextWeek.setDate(nextWeek.getDate() + 7);
    flatpickr("#pos-jatuh-tempo", {
        ...baseConfig,
        defaultDate: nextWeek
    });

    // 4. Init Sisanya (Input tanggal lain yang mungkin ada)
    flatpickr("input[type=date]:not(.flatpickr-input)", {
        ...baseConfig
    });

        // Di dalam initTanggal()
    flatpickr("#filter-jual-start, #filter-beli-start, #filter-keu-start", { // <--- Tambah #filter-keu-start
        ...baseConfig,
        defaultDate: today
    });

    flatpickr("#filter-jual-end, #filter-beli-end, #filter-keu-end", { // <--- Tambah #filter-keu-end
        ...baseConfig,
        defaultDate: today
    });
}

// --- [BARU] LOGIKA FILTER DASHBOARD ---

// 1. Eksekusi Filter (Dipanggil tombol Filter)
function terapkanFilterDashboard() {
    const start = document.getElementById('dash-filter-start').value;
    const end = document.getElementById('dash-filter-end').value;

    if(!start || !end) {
        return myAlert('Filter Error', 'Harap isi tanggal awal dan akhir.', 'warning');
    }

    // Panggil fungsi loadDashboard yang sudah ada, tapi dengan parameter
    loadDashboard(start, end);
}

// 2. Logika Dropdown Cepat (Copy logic dari setFilterCepat tapi khusus dashboard)
function setFilterDashboard(pilihan) {
    const now = new Date();
    let start = new Date();
    let end = new Date();

    // Helper Format YYYY-MM-DD
    const fmt = (d) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const d_str = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${d_str}`;
    };

    if (pilihan === "bulan_ini") {
        start = new Date(now.getFullYear(), now.getMonth(), 1); // Tgl 1
    } else if (pilihan === "bulan_lalu") {
        start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        end = new Date(now.getFullYear(), now.getMonth(), 0); 
    } else if (pilihan === "kemarin") {
        start.setDate(now.getDate() - 1);
        end.setDate(now.getDate() - 1);
    } else if (pilihan === "7_hari") {
        start.setDate(now.getDate() - 6);
    } else if (pilihan === "hari_ini") {
        // default now
    } else {
        return; // Custom
    }

    // Update Input Tanggal
    const elStart = document.getElementById('dash-filter-start');
    const elEnd = document.getElementById('dash-filter-end');

    if (elStart._flatpickr) elStart._flatpickr.setDate(fmt(start), true);
    else elStart.value = fmt(start);

    if (elEnd._flatpickr) elEnd._flatpickr.setDate(fmt(end), true);
    else elEnd.value = fmt(end);

    // Langsung load data tanpa tekan tombol filter lagi (Opsional, agar cepat)
    terapkanFilterDashboard();
}

// [UPDATE] Fungsi Auto Date agar support Flatpickr & Tampilan Langsung Muncul
function setAutoDate(tipe) {
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1); 

    const toStr = (d) => {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const strStart = toStr(firstDay);
    const strEnd = toStr(now);

    const elStart = document.getElementById(`filter-${tipe}-start`);
    const elEnd = document.getElementById(`filter-${tipe}-end`);

    // LOGIKA UPDATE: Tambahkan parameter true agar UI merefresh
    if(elStart) {
        if(elStart._flatpickr) {
            // Parameter 'true' memaksa tampilan input berubah
            elStart._flatpickr.setDate(strStart, true); 
        } else {
            elStart.value = strStart;
        }
    }

    if(elEnd) {
        if(elEnd._flatpickr) {
            elEnd._flatpickr.setDate(strEnd, true);
        } else {
            elEnd.value = strEnd;
        }
    }
}

// Tambahkan Event Listener agar menekan ENTER di kolom pencarian langsung memfilter
document.getElementById('filter-jual-text')?.addEventListener('keyup', function(e) {
    if(e.key === 'Enter') terapkanFilter('JUAL');
    else terapkanFilter('JUAL'); // Live search saat mengetik
});

document.getElementById('filter-beli-text')?.addEventListener('keyup', function(e) {
    if(e.key === 'Enter') terapkanFilter('BELI');
    else terapkanFilter('BELI'); // Live search saat mengetik
});

// GANTI FUNGSI viewDetailTrx DENGAN INI

function viewDetailTrx(tipe, index) {
   // 1. Ambil Data Transaksi
   const data = tipe === 'JUAL' ? dataJualTemp : dataBeliTemp;
   const trx = data[index];
   
   if(!trx) return myAlert('Error', 'Data transaksi tidak ditemukan', 'error');

   // [PENTING] Set variable global ini agar bisa dibaca oleh fungsi cetakInvoiceRetur
   currentReturData = trx; 

   // 2. Isi Info Header Modal
   document.getElementById('det-id').innerText = trx.id;
   document.getElementById('det-pelanggan').innerText = trx.pelanggan;
   
   try {
       document.getElementById('det-waktu').innerText = new Date(trx.waktu).toLocaleString('id-ID');
   } catch(e) {
       document.getElementById('det-waktu').innerText = '-';
   }

   document.getElementById('det-total').innerText = rupiah(trx.totalBayar);
   
   // 3. Render Tabel Barang (Dengan Logika Retur)
   const tb = document.querySelector('#tabel-detail-trx tbody');
   tb.innerHTML = '';
   
   let adaBarangRetur = false;
   let totalRefundHitung = 0;

   trx.items.forEach(item => {
       // DETEKSI RETUR:
       // Cek apakah item memiliki properti 'qtyRetur' > 0 ATAU status mengandung kata 'Retur'
       // (Sesuaikan dengan data yang dikirim backend Anda)
       let qtyRetur = Number(item.qtyRetur) || 0;
       let isRetur = qtyRetur > 0 || (item.status && item.status.toString().toLowerCase().includes('retur'));
       
       // Styling Baris
       let classRow = '';
       let infoRetur = '';
       
       if (isRetur) {
           adaBarangRetur = true;
           classRow = 'table-danger'; // Warna merah muda
           
           // Hitung estimasi refund untuk tombol cetak
           // Harga Satuan = HargaTotal / Qty Awal
           let hargaSatuan = (item.qty > 0) ? (item.hargaTotal / item.qty) : 0;
           // Jika qtyRetur tidak tercatat tapi status retur, asumsikan full (fallback), tapi utamakan qtyRetur
           let qtyRefund = qtyRetur > 0 ? qtyRetur : item.qty; 
           totalRefundHitung += (qtyRefund * hargaSatuan);

           infoRetur = `<br><span class="badge bg-danger mt-1" style="font-size:9px">DIRETUR: ${qtyRefund} Pcs</span>`;
       }

       tb.innerHTML += `
        <tr class="${classRow}">
            <td>
                <span class="${isRetur ? 'text-danger fw-bold' : ''}">${item.produk}</span> 
                ${infoRetur}
                <br> <small class="text-muted">${item.tipe}</small>
            </td>
            <td class="text-center">
                ${item.qty}
            </td>
            <td class="text-end">${rupiah(item.hargaTotal)}</td>
        </tr>`;
   });

   // 4. SETUP TOMBOL FOOTER
   const footer = document.querySelector('#modalDetailTrx .modal-footer');
   footer.innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>`;
   
   // A. Tombol CETAK INVOICE (Normal)
   if(tipe === 'JUAL') {
       const btnCetak = document.createElement('button');
       btnCetak.className = 'btn btn-primary ms-2 fw-bold';
       btnCetak.innerHTML = '<i class="material-icons align-middle" style="font-size:16px">print</i> CETAK STRUK';
       btnCetak.onclick = () => {
           const payloadInvoice = {
               pelanggan: trx.pelanggan,
               kasir: trx.kasir || 'Admin',
               metode: trx.metode || 'Tunai', 
               jatuhTempo: trx.jatuhTempo || '',
               diskon: trx.diskonTotal || 0,
               items: trx.items.map(i => ({
                   produkNama: i.produk,
                   qty: i.qty,
                   tipe: i.tipe,
                   hargaSatuan: (i.qty > 0) ? (i.hargaTotal / i.qty) : 0, 
                   total: i.hargaTotal
               }))
           };
           bootstrap.Modal.getInstance(document.getElementById('modalDetailTrx')).hide();
           tampilkanInvoice(payloadInvoice, trx.id);
       };
       footer.appendChild(btnCetak);
   }

   // B. Tombol CETAK BUKTI RETUR (Khusus jika ada barang retur)
   if(adaBarangRetur) {
       const btnCetakRetur = document.createElement('button');
       btnCetakRetur.className = 'btn btn-outline-danger ms-2 fw-bold';
       btnCetakRetur.innerHTML = '<i class="material-icons align-middle" style="font-size:16px">receipt</i> CETAK RETUR';
       
       btnCetakRetur.onclick = () => {
           // Siapkan payload sesuai format yang diminta fungsi cetakInvoiceRetur
           const payloadRetur = {
               idTrx: trx.id,
               alasan: trx.alasanRetur || 'Retur Barang (Cetak Ulang)',
               items: trx.items // Item sudah mengandung qtyRetur dari database
           };
           
           // Panggil fungsi cetak yang sudah Anda buat
           cetakInvoiceRetur(payloadRetur, totalRefundHitung);
       };
       footer.appendChild(btnCetakRetur);
   }

   // C. Tombol PROSES RETUR BARU (Agar bisa retur susulan)
   const btnRetur = document.createElement('button');
   btnRetur.className = 'btn btn-danger ms-2';
   btnRetur.innerText = 'RETUR / BATAL';
   btnRetur.onclick = () => {
       bootstrap.Modal.getInstance(document.getElementById('modalDetailTrx')).hide();
       bukaFormRetur(trx, tipe);
   };
   footer.appendChild(btnRetur);

   // Tampilkan Modal
   new bootstrap.Modal(document.getElementById('modalDetailTrx')).show();
}

// 5. BUKA FORM RETUR (Baru)
function bukaFormRetur(trx, tipe) {
    currentReturData = trx; // [BARU] Simpan data transaksi ke global var
    
    document.getElementById('retur-id-trx').value = trx.id;
    document.getElementById('retur-jenis-trx').value = tipe;
    document.getElementById('check-retur-semua').checked = false;
    document.getElementById('retur-alasan').value = '';
    
    const container = document.getElementById('container-retur-items');
    container.innerHTML = '';

    trx.items.forEach((item, idx) => {
        let hargaSatuan = item.hargaTotal / item.qty;
        
        container.innerHTML += `
           <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2 item-retur-row">
              <div style="flex:1">
                 <small class="fw-bold">${item.produk}</small><br>
                 <small class="text-muted">Dibeli: ${item.qty} | ${item.tipe || ''}</small>
                 <input type="hidden" class="data-produk" value="${item.produk}">
                 <input type="hidden" class="data-tipe" value="${item.tipe || ''}">
                 <input type="hidden" class="data-harga" value="${hargaSatuan}">
                 <input type="hidden" class="data-qty-asal" value="${item.qty}">
              </div>
              <div style="width: 100px;">
                 <input type="number" class="form-control form-control-sm input-qty-retur" 
                        placeholder="0" min="0" max="${item.qty}">
              </div>
           </div>
        `;
    });
    
    new bootstrap.Modal(document.getElementById('modalFormRetur')).show();
}

// 6. TOGGLE RETUR SEMUA
function toggleReturSemua() {
    const isChecked = document.getElementById('check-retur-semua').checked;
    const inputs = document.querySelectorAll('.input-qty-retur');
    const rows = document.querySelectorAll('.item-retur-row');
    
    inputs.forEach((input, idx) => {
        if(isChecked) {
            // Isi dengan qty maksimal (qty beli)
            const qtyAsal = rows[idx].querySelector('.data-qty-asal').value;
            input.value = qtyAsal;
            input.setAttribute('readonly', true); // Kunci input
        } else {
            input.value = '';
            input.removeAttribute('readonly'); // Buka kunci
        }
    });
}

// 7. PROSES SIMPAN KE DATABASE
function prosesSimpanRetur() {
    const idTrx = document.getElementById('retur-id-trx').value;
    const jenis = document.getElementById('retur-jenis-trx').value;
    const alasan = document.getElementById('retur-alasan').value;
    
    let itemsToReturn = [];
    let hasInput = false;
    let totalRefundEstimasi = 0; // [BARU]

    const rows = document.querySelectorAll('.item-retur-row');
    rows.forEach(row => {
        const prod = row.querySelector('.data-produk').value;
        const tipe = row.querySelector('.data-tipe').value;
        const harga = Number(row.querySelector('.data-harga').value);
        const qtyInput = row.querySelector('.input-qty-retur').value;
        const qtyRetur = Number(qtyInput);

        if(qtyRetur > 0) {
            hasInput = true;
            totalRefundEstimasi += (qtyRetur * harga); // Hitung total
        }
        
        itemsToReturn.push({
            produk: prod,
            tipe: tipe,
            hargaSatuan: harga,
            qtyRetur: qtyRetur
        });
    });

    if(!hasInput) return myAlert('Error', 'Masukkan jumlah barang yang ingin diretur!', 'error');

    const payload = {
        idTrx: idTrx,
        jenis: jenis,
        alasan: alasan,
        items: itemsToReturn
    };
    
    myConfirm('Konfirmasi Retur', 'Stok akan disesuaikan. Lanjutkan?', () => {
        loading(true);
        google.script.run.withSuccessHandler(res => {
            loading(false);
            
            const modalEl = document.getElementById('modalFormRetur');
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if(modalInstance) modalInstance.hide();
            
            myAlert('Sukses', res, 'success');
            
            // --- [BARU] POPUP CETAK INVOICE RETUR ---
            if(jenis === 'JUAL') {
                // Tampilkan invoice retur
                cetakInvoiceRetur(payload, totalRefundEstimasi);
            }
            // ----------------------------------------
            
            if(jenis === 'JUAL') {
                loadRiwayatJual();
            } else {
                loadRiwayatBeli();
            }

            setTimeout(() => {
                loadDashboard();
                loadProduk();
                loadKeuangan();
            }, 500);
            
        }).prosesReturBaru(payload);
    });
}

// [UPDATE] Load Data Supplier ke Variabel Global
function loadPembelianData() {
  google.script.run.withSuccessHandler(data => {
      // 1. Simpan data ke variabel global agar bisa dicari
      globalListSupplier = data;
      
      // 2. Kosongkan inputan saat halaman dimuat ulang
      document.getElementById('beli-supplier').value = '';
  }).getData('SUPPLIER');
}

// --- LOGIKA PENCARIAN SUPPLIER (BARU) ---

// 1. Event Listener saat mengetik nama supplier
document.getElementById('beli-supplier')?.addEventListener('input', function() {
    const keyword = this.value.toLowerCase();
    const container = document.getElementById('hasil-cari-supplier');
    
    container.innerHTML = ''; // Bersihkan hasil sebelumnya

    if(keyword.length < 1) {
        container.classList.add('d-none'); // Sembunyikan jika kosong
        return;
    }

    // Filter Data Supplier
    const hasil = globalListSupplier.filter(r => {
        // r[1] adalah Nama Supplier (sesuai urutan kolom di Code.gs)
        const nama = r[1].toLowerCase(); 
        return nama.includes(keyword);
    });

    if(hasil.length === 0) {
         container.innerHTML = '<div class="list-group-item text-muted small">Supplier tidak ditemukan.</div>';
         container.classList.remove('d-none');
         return;
    }
    
    // Render Hasil Pencarian
    hasil.slice(0, 5).forEach(r => { // Tampilkan max 5 hasil
        const nama = r[1];
        
        const btn = document.createElement('button');
        btn.className = 'list-group-item list-group-item-action py-2 small fw-bold';
        btn.innerHTML = nama;
        
        // Saat diklik, isi ke input dan sembunyikan list
        btn.onclick = function() {
            document.getElementById('beli-supplier').value = nama;
            container.classList.add('d-none');
        };
        container.appendChild(btn);
    });
    
    container.classList.remove('d-none'); // Munculkan list
});

// 2. Tampilkan semua supplier jika input diklik (Focus)
document.getElementById('beli-supplier')?.addEventListener('focus', function() {
    if(this.value === '' && globalListSupplier.length > 0) {
        const container = document.getElementById('hasil-cari-supplier');
        container.innerHTML = '';
        
        // Tampilkan 5 supplier pertama sebagai saran
        globalListSupplier.slice(0, 5).forEach(r => {
            const btn = document.createElement('button');
            btn.className = 'list-group-item list-group-item-action py-2 small fw-bold';
            btn.innerHTML = r[1];
            btn.onclick = function() {
                document.getElementById('beli-supplier').value = r[1];
                container.classList.add('d-none');
            };
            container.appendChild(btn);
        });
        container.classList.remove('d-none');
    }
});

// 3. Sembunyikan dropdown jika klik di luar area
document.addEventListener('click', function(e) {
    // Jika yang diklik BUKAN input supplier, tutup dropdown
    if (e.target.id !== 'beli-supplier') {
        document.getElementById('hasil-cari-supplier')?.classList.add('d-none');
    }
});

function simpanSupplier() {
    // 1. Ambil nilai
    var namaVal = document.getElementById('sup-nama').value;
    var hpVal = document.getElementById('sup-hp').value;
    var alamatVal = document.getElementById('sup-alamat').value;

    // 2. Validasi
    if (!namaVal) {
        Swal.fire('Gagal', 'Nama Supplier wajib diisi!', 'warning');
        return;
    }

    var dataKirim = {
        nama: namaVal,
        hp: hpVal,
        alamat: alamatVal
    };

    // Tampilkan loading di tombol
    var btnSimpan = document.querySelector('#modalSupplier .btn-primary');
    var txtAwal = btnSimpan.innerHTML;
    btnSimpan.innerHTML = 'Menyimpan...';
    btnSimpan.disabled = true;

    google.script.run
        .withSuccessHandler(function() {
            // Reset Tombol
            btnSimpan.innerHTML = txtAwal;
            btnSimpan.disabled = false;

            // Tutup Modal
            var modalEl = document.getElementById('modalSupplier');
            var modal = bootstrap.Modal.getInstance(modalEl);
            if(modal) modal.hide();

            // === [FITUR BARU DISINI] ===
            // 1. Otomatis isi kolom supplier di halaman pembelian dengan nama baru
            if(document.getElementById('beli-supplier')) {
                document.getElementById('beli-supplier').value = namaVal;
            }
            
            // 2. Reset Form Modal
            document.getElementById('sup-nama').value = '';
            document.getElementById('sup-hp').value = '';
            document.getElementById('sup-alamat').value = '';

            // 3. Pesan Sukses
            Swal.fire({
                icon: 'success',
                title: 'Berhasil',
                text: 'Supplier ' + namaVal + ' siap digunakan!',
                timer: 1500,
                showConfirmButton: false
            });

        })
        .withFailureHandler(function(err) {
             btnSimpan.innerHTML = txtAwal;
             btnSimpan.disabled = false;
             Swal.fire('Error', err.message, 'error');
        })
        .tambahSupplier(dataKirim);
}

  function prosesBeli() {
    const d = { supplier: document.getElementById('beli-supplier').value, produk: document.getElementById('beli-produk').value, qty: document.getElementById('beli-qty').value, total: document.getElementById('beli-harga').value * document.getElementById('beli-qty').value, metode:'Tunai', isTukar: document.getElementById('beli-tukar').checked };
    if(confirm('Simpan Beli?')) {
        loading(true);
        google.script.run.withSuccessHandler(()=>{ 
            loading(false);
            alert('Sukses'); 
            loadProduk(); 
        }).simpanPembelian(d);
    }
  }

function loadPelanggan() {
    loading(true);
    google.script.run.withSuccessHandler(data => {
      loading(false);

      // --- PENGAMAN ---
      if (!data) return;

      const tb = document.querySelector('#tabel-pelanggan tbody');
      tb.innerHTML = '';
      data.forEach(r => {
        tb.innerHTML += `
          <tr>
            <td class="fw-bold">${r[1]}</td>
            <td>${r[2]}</td>
            <td>${r[3]}<br><small class="text-muted">${r[4]}</small></td>
            <td>
               <button class="btn btn-sm btn-warning" onclick="editPelanggan('${r[0]}','${r[1]}','${r[2]}','${r[3]}','${r[4]}')"><i class="material-icons" style="font-size:14px">edit</i></button>
               <button class="btn btn-sm btn-danger" onclick="hapusPelanggan('${r[0]}')"><i class="material-icons" style="font-size:14px">delete</i></button>
            </td>
          </tr>`;
      });
    }).getData('PELANGGAN');
  }

  // Handle Modal (Bisa dari menu Pelanggan, bisa dari shortcut Kasir)
  let isFromKasir = false; 

  function modalPelanggan(fromKasir = false) {
    isFromKasir = fromKasir;
    document.getElementById('pel-id').value = '';
    document.getElementById('pel-nama').value = '';
    document.getElementById('pel-pt').value = '';
    document.getElementById('pel-hp').value = '';
    document.getElementById('pel-alamat').value = '';
    new bootstrap.Modal(document.getElementById('modalPelanggan')).show();
  }

  function editPelanggan(id, nama, pt, hp, alamat) {
    document.getElementById('pel-id').value = id;
    document.getElementById('pel-nama').value = nama;
    document.getElementById('pel-pt').value = pt;
    document.getElementById('pel-hp').value = hp;
    document.getElementById('pel-alamat').value = alamat;
    new bootstrap.Modal(document.getElementById('modalPelanggan')).show();
  }

function simpanPelangganDB() {
    const d = {
      id: document.getElementById('pel-id').value,
      nama: document.getElementById('pel-nama').value,
      pt: document.getElementById('pel-pt').value,
      hp: document.getElementById('pel-hp').value,
      alamat: document.getElementById('pel-alamat').value
    };

    if(!d.nama) return myAlert('Peringatan', 'Nama wajib diisi!', 'warning');

    loading(true);
    google.script.run.withSuccessHandler(res => {
       loading(false);
       
       // [1] GANTI ALERT BIASA JADI POPUP KEREN
       myAlert('Berhasil', res, 'success');
       
       bootstrap.Modal.getInstance(document.getElementById('modalPelanggan')).hide();
       
       if(isFromKasir) {
          // [2] KIRIM NAMA BARU AGAR BISA DI-AUTO SELECT
          loadPelangganDropdown(d.nama); 
       } else {
          // Jika dari menu admin, refresh tabel seperti biasa
          loadPelanggan();
       }
    }).simpanPelanggan(d);
  }
function hapusPelanggan(id) {
    myConfirm('Hapus Pelanggan', 'Apakah Anda yakin ingin menghapus data pelanggan ini?', () => {
       loading(true);
       google.script.run.withSuccessHandler(() => {
         loading(false);
         loadPelanggan();
         myAlert('Sukses', 'Data Pelanggan berhasil dihapus', 'success');
       }).hapusPelanggan(id);
    });
  }

  function filterPelanggan() {
    const k = document.getElementById('cari-pelanggan').value.toLowerCase();
    document.querySelectorAll('#tabel-pelanggan tbody tr').forEach(tr => {
       tr.style.display = tr.innerText.toLowerCase().includes(k) ? '' : 'none';
    });
  }

  // --- INTEGRASI KE KASIR ---
  
function loadPelangganDropdown(targetNama = null) {
    google.script.run.withSuccessHandler(data => {
       if (!data) return; 
       
       // 1. Simpan Data ke Global Variable
       globalListPelanggan = data; 
       
       // 2. Jika ada target (misal baru tambah pelanggan), langsung set ke input
       if(targetNama) {
           document.getElementById('kasir-pelanggan').value = targetNama;
       }
    }).getListPelanggan();
}

// 1. FUNGSI FETCH DATA DARI SERVER
function loadKeuangan() {
    loading(true);
    google.script.run.withSuccessHandler(d => {
        loading(false);
        
        // Simpan ke variabel global agar bisa difilter
        globalKeuanganData = d || []; 

        // Render tabel dengan data mentah (semua data)
        renderTabelKeuangan(globalKeuanganData);

    }).getData('KEUANGAN');
}

// [UPDATE] FUNGSI RENDER TABEL KEUANGAN (DENGAN TOMBOL CETAK)
function renderTabelKeuangan(data) {
    const tb = document.querySelector('#tabel-keuangan tbody'); 
    tb.innerHTML = '';

    if (!data || data.length === 0) {
        tb.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">Belum ada data keuangan.</td></tr>';
        return; 
    }

    data.slice(0, 100).forEach(r => {
        // r[0]: ID, r[1]: Tanggal, r[2]: Jenis, r[3]: Kategori, r[4]: Nominal, r[5]: Ket
        
        let tglDisplay = '-';
        let timestamp = 0;
        
        try { 
            if(r[1]) {
                let d = new Date(r[1]);
                timestamp = d.getTime(); 
                let dd = String(d.getDate()).padStart(2, '0');
                let mm = String(d.getMonth() + 1).padStart(2, '0');
                let yyyy = d.getFullYear();
                tglDisplay = `${dd}/${mm}/${yyyy}`;
            }
        } catch(e){ console.log(e); }

        let colorClass = r[2] === 'Pemasukan' ? 'text-success' : 'text-danger';
        let nominal = rupiah(r[4]);

        // Cek ID Manual vs Auto
        let isManual = String(r[0]).includes('MANUAL');
        let aksiTombol = '';
        
        // Bersihkan tanda petik di keterangan agar tidak merusak HTML onclick
        let safeKet = r[5] ? r[5].toString().replace(/'/g, "\\'").replace(/"/g, '&quot;') : "";
        let safeDate = r[1]; 

        // [BARU] Tombol Cetak (Re-usable string)
        let btnCetak = `
            <button class="btn btn-sm btn-info text-white py-0 px-2 me-1" 
                onclick="siapkanCetak('${r[0]}', '${safeDate}', '${r[2]}', '${r[3]}', ${r[4]}, '${safeKet}')" 
                title="Cetak Slip">
                <i class="material-icons" style="font-size:14px">print</i>
            </button>
        `;
        
        if(isManual) {
            // Jika Manual: Tombol Cetak + Edit + Hapus
            aksiTombol = `
            ${btnCetak}
            <button class="btn btn-sm btn-warning text-dark py-0 px-2" 
                onclick="editKeuangan('${r[0]}', '${safeDate}', '${r[2]}', '${r[3]}', ${r[4]}, '${safeKet}')" title="Edit">
                <i class="material-icons" style="font-size:14px">edit</i>
            </button>
            <button class="btn btn-sm btn-light text-danger border py-0 px-2 ms-1" onclick="hapusKeuangan('${r[0]}')" title="Hapus">
                <i class="material-icons" style="font-size:14px">delete</i>
            </button>
            `;
        } else {
            // Jika Auto: Tombol Cetak + Badge Auto
            aksiTombol = `
            ${btnCetak}
            <span class="badge bg-light text-muted border" title="Data Otomatis">
                <i class="material-icons align-middle" style="font-size:12px">lock</i> Auto
            </span>
            `;
        }

        tb.innerHTML += `
        <tr data-ts="${timestamp}">
            <td>${tglDisplay}</td>
            <td><span class="badge ${r[2] === 'Pemasukan' ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'}">${r[2]}</span></td>
            <td>${r[3]}</td>
            <td class="${colorClass} fw-bold">${nominal}</td>
            <td><small class="text-muted text-truncate d-block" style="max-width: 150px;">${r[5]}</small></td>
            <td class="text-center" style="white-space: nowrap;">${aksiTombol}</td>
        </tr>`;
    });
}

// [BARU] Helper untuk tombol cetak di tabel
function siapkanCetak(id, tgl, jenis, kat, nom, ket) {
    const dataObj = {
        id: id,
        tanggal: tgl, // Format tanggal raw dari DB
        jenis: jenis,
        kategori: kat,
        nominal: nom,
        ket: ket
    };
    // Panggil fungsi cetak nota yang sudah kita perbaiki sebelumnya
    cetakNotaKeuangan(dataObj);
}

// 3. FUNGSI FILTER KEUANGAN
function terapkanFilterKeuangan() {
    const keyword = document.getElementById('filter-keu-text').value.toLowerCase();
    const startDateVal = document.getElementById('filter-keu-start').value;
    const endDateVal = document.getElementById('filter-keu-end').value;

    // Konversi tanggal filter ke Timestamp
    let startTs = startDateVal ? new Date(startDateVal).setHours(0,0,0,0) : 0;
    let endTs = endDateVal ? new Date(endDateVal).setHours(23,59,59,999) : 9999999999999; 

    // Filter Array Global
    const hasilFilter = globalKeuanganData.filter(r => {
        // Ambil data baris
        let strData = (r[2] + " " + r[3] + " " + r[5]).toLowerCase(); // Gabung Jenis, Kategori, Ket
        let rowDate = new Date(r[1]);
        let rowTs = rowDate.getTime();

        // Cek Logika
        const matchText = strData.includes(keyword);
        const matchDate = rowTs >= startTs && rowTs <= endTs;

        return matchText && matchDate;
    });

    // Render ulang dengan data hasil filter
    renderTabelKeuangan(hasilFilter);
}

// Event Listener agar tekan Enter langsung filter
document.getElementById('filter-keu-text')?.addEventListener('keyup', function(e) {
    if(e.key === 'Enter') terapkanFilterKeuangan();
});

// [BARU] Load Data Akun dari Server
function loadDataAkun() {
    google.script.run.withSuccessHandler(data => {
        globalListAkun = data; // Simpan ke global
        
        // Render ke Dropdown Modal Keuangan
        const selKeu = document.getElementById('keu-akun');
        selKeu.innerHTML = '';
        data.forEach(a => {
            selKeu.innerHTML += `<option value="${a.nama}" data-saldo="${a.saldo}">${a.nama}</option>`;
        });
        
        // Trigger update tampilan saldo
        cekSaldoUI(); 

    }).getDaftarAkun();
}

// [BARU] Update Tampilan Saldo saat Dropdown diganti
function cekSaldoUI() {
    const sel = document.getElementById('keu-akun');
    const saldo = sel.options[sel.selectedIndex]?.getAttribute('data-saldo') || 0;
    
    // Tampilkan dengan format Rupiah
    document.getElementById('label-saldo-akun').innerText = rupiah(saldo);
    
    // Sedikit logika visual: Kalau saldo minus/nol kasih warna merah
    if(saldo <= 0) {
        document.getElementById('label-saldo-akun').className = "fw-bold text-danger";
    } else {
        document.getElementById('label-saldo-akun').className = "fw-bold text-primary";
    }
}

function bukaModalKeuangan() {
    // --- 1. SETUP TANGGAL (Flatpickr / Manual) ---
    const elTanggal = document.getElementById('keu-tanggal');
    const today = new Date();

    if (elTanggal._flatpickr) {
        elTanggal._flatpickr.setDate(today, true);
    } else {
        const offset = today.getTimezoneOffset() * 60000;
        const localISOTime = (new Date(today - offset)).toISOString().slice(0, 10);
        elTanggal.value = localISOTime;
    }

    // --- 2. LOAD DATA BARU (Akun & Kategori) ---
    // Penting: Panggil ini agar dropdown Akun & Kategori selalu update
    loadDataAkun(); 
    refreshDropdownKategori(); 

    // --- 3. RESET FORM INPUT ---
    document.getElementById('keu-jenis').selectedIndex = 0; // Reset ke Pengeluaran
    document.getElementById('keu-nominal').value = ''; 
    document.getElementById('keu-ket').value = '';
    
    // --- 4. RESET TAMPILAN UI (PENTING UNTUK MENCEGAH BUG EDIT) ---
    // Pastikan judul dan tombol kembali ke mode "Catat Baru", bukan "Edit"
    document.getElementById('modalKeuanganTitle').innerHTML = '<i class="material-icons align-middle me-2">edit_note</i>Catat Transaksi';
    document.getElementById('modalKeuanganTitle').className = "fw-bold text-white"; // Kembalikan warna text
    
    // Reset Tombol Simpan
    const btn = document.getElementById('btn-simpan-keuangan');
    btn.removeAttribute('data-id'); // Hapus ID edit jika ada
    btn.innerText = "SIMPAN TRANSAKSI"; 
    btn.className = "btn btn-primary w-100 fw-bold rounded-pill"; // Kembalikan warna tombol

    // --- 5. TAMPILKAN MODAL ---
    new bootstrap.Modal(document.getElementById('modalKeuangan')).show();
    
    // Opsional: Fokus otomatis ke input nominal setelah modal muncul
    setTimeout(() => document.getElementById('keu-nominal').focus(), 500);
}

function editKeuangan(id, tglRaw, jenis, kategori, nominal, ket) {
    // Visual Mode Edit
    document.getElementById('modalKeuanganTitle').innerText = "Edit Data Keuangan";
    document.getElementById('modalKeuanganTitle').className = "fw-bold text-warning"; 

    const btn = document.getElementById('btn-simpan-keuangan');
    btn.setAttribute('data-id', id);
    btn.innerText = "UPDATE PERUBAHAN";
    btn.className = "btn btn-warning fw-bold text-dark"; 

    // --- ISI DATA LAMA ---
    
    // 1. UPDATE TANGGAL (FIX BUG KOSONG)
    const elTanggal = document.getElementById('keu-tanggal');
    
    // Cek apakah Flatpickr aktif di elemen ini?
    if (elTanggal._flatpickr) {
        // Jika YA: Gunakan setDate bawaan Flatpickr agar UI berubah
        elTanggal._flatpickr.setDate(tglRaw, true);
    } else {
        // Jika TIDAK: Fallback manual HTML biasa
        let dateVal = '';
        try {
            if(tglRaw) {
                dateVal = new Date(tglRaw).toISOString().split('T')[0];
            }
        } catch(e) {}
        elTanggal.value = dateVal;
    }

    // 2. Jenis & Ket
    document.getElementById('keu-jenis').value = jenis;
    document.getElementById('keu-ket').value = ket;

    // 3. Nominal (Diformat Ribuan: 100000 -> 100.000)
    document.getElementById('keu-nominal').value = new Intl.NumberFormat('id-ID').format(nominal);

    // 4. Load Kategori
    const selectEl = document.getElementById('keu-kategori');
    selectEl.innerHTML = '<option>Loading...</option>'; 

    google.script.run.withSuccessHandler(categories => {
        selectEl.innerHTML = ''; 
        if (categories) categories.forEach(cat => selectEl.innerHTML += `<option value="${cat}">${cat}</option>`);
        selectEl.value = kategori;
        // Jaga-jaga jika kategori lama sudah dihapus dari master, tetap tampilkan
        if (selectEl.value !== kategori) {
             const opt = document.createElement('option');
             opt.value = kategori; opt.innerText = kategori;
             selectEl.appendChild(opt); selectEl.value = kategori;
        }
    }).getKategori();

    new bootstrap.Modal(document.getElementById('modalKeuangan')).show();
}

// --- FUNGSI BARU: HAPUS ---
function hapusKeuangan(id) {
    myConfirm('Hapus Data', 'Yakin hapus data keuangan ini?', () => {
        loading(true);
        google.script.run.withSuccessHandler(() => {
            loading(false);
            loadKeuangan(); // Refresh tabel
            loadDashboard(); // Refresh angka dashboard
            myAlert('Sukses', 'Data berhasil dihapus', 'success');
        }).hapusKeuangan(id);
    });
}

// [UPDATE] Fungsi Simpan Keuangan (Kirim Data Akun)
function simpanKeuangan() {
    const akun = document.getElementById('keu-akun').value;
    const tgl = document.getElementById('keu-tanggal').value;
    const jenis = document.getElementById('keu-jenis').value;
    const kategori = document.getElementById('keu-kategori').value;
    const rawNominal = document.getElementById('keu-nominal').value;
    const nominal = rawNominal.replace(/\./g, ''); 
    const ket = document.getElementById('keu-ket').value;

    if(!akun) return myAlert('Error', 'Pilih akun pembayaran dulu.', 'warning');
    if(!nominal || nominal == 0) return myAlert('Error', 'Nominal wajib diisi.', 'warning');

    const dataKirim = { 
        tanggal: tgl, 
        jenis: jenis, 
        kategori: kategori, 
        nominal: nominal, 
        keterangan: ket,
        akun: akun // [BARU]
    };

    loading(true);
    google.script.run.withSuccessHandler(res => { 
        loading(false);
        bootstrap.Modal.getInstance(document.getElementById('modalKeuangan')).hide();
        loadKeuangan(); 
        loadDashboard(); 
        myAlert('Sukses', 'Transaksi berhasil disimpan!', 'success');
    }).simpanKeuangan(dataKirim);
}

function bukaModalTransfer() {
    // 1. Ambil data akun terbaru
    loading(true);
    google.script.run.withSuccessHandler(data => {
        loading(false);
        globalListAkun = data;
        
        const selAsal = document.getElementById('trf-asal');
        const selTujuan = document.getElementById('trf-tujuan');
        
        selAsal.innerHTML = '';
        selTujuan.innerHTML = '';
        
        data.forEach(a => {
            selAsal.innerHTML += `<option value="${a.nama}" data-saldo="${a.saldo}">${a.nama}</option>`;
            selTujuan.innerHTML += `<option value="${a.nama}">${a.nama}</option>`;
        });

        // Update Saldo Asal
        cekSaldoTransfer();
        
        // Reset Input
        document.getElementById('trf-nominal').value = '';
        document.getElementById('trf-ket').value = '';
        
        new bootstrap.Modal(document.getElementById('modalTransfer')).show();

    }).getDaftarAkun();
}

function cekSaldoTransfer() {
    const sel = document.getElementById('trf-asal');
    const saldo = sel.options[sel.selectedIndex]?.getAttribute('data-saldo') || 0;
    
    // Update teks saldo dengan format yang lebih rapi
    const elSaldo = document.getElementById('saldo-trf-asal');
    elSaldo.innerText = rupiah(saldo);

    // Visual feedback: Jika saldo 0, warnanya merah. Jika ada isinya, warna biru.
    if(Number(saldo) <= 0) {
        elSaldo.classList.remove('text-primary');
        elSaldo.classList.add('text-danger');
    } else {
        elSaldo.classList.remove('text-danger');
        elSaldo.classList.add('text-primary');
    }
}
function eksekusiTransfer() {
    const asal = document.getElementById('trf-asal').value;
    const tujuan = document.getElementById('trf-tujuan').value;
    const rawNominal = document.getElementById('trf-nominal').value;
    const nominal = Number(rawNominal.replace(/\./g, ''));
    const ket = document.getElementById('trf-ket').value;

    if(asal === tujuan) return myAlert('Error', 'Akun asal dan tujuan tidak boleh sama.', 'warning');
    if(nominal <= 0) return myAlert('Error', 'Nominal transfer tidak valid.', 'warning');

    // Cek saldo cukup gak? (Opsional, kalau mau maksa transfer biarin aja)
    const selAsal = document.getElementById('trf-asal');
    const saldoAsal = Number(selAsal.options[selAsal.selectedIndex]?.getAttribute('data-saldo') || 0);
    
    if(nominal > saldoAsal) {
         if(!confirm(`Saldo akun ${asal} hanya ${rupiah(saldoAsal)}. Transfer akan membuat saldo minus. Lanjutkan?`)) return;
    }

    const payload = {
        akunAsal: asal,
        akunTujuan: tujuan,
        nominal: nominal,
        ket: ket
    };

    loading(true);
    google.script.run.withSuccessHandler(res => {
        loading(false);
        bootstrap.Modal.getInstance(document.getElementById('modalTransfer')).hide();
        loadKeuangan();
        loadDashboard();
        myAlert('Berhasil', 'Transfer saldo sukses!', 'success');
    }).prosesTransferSaldo(payload);
}

// 2. Fungsi Refresh Dropdown (Dipisahkan agar bisa dipanggil ulang)
function refreshDropdownKategori() {
    const selectEl = document.getElementById('keu-kategori');
    
    // Tampilkan indikator loading kecil di dalam dropdown (opsional)
    selectEl.innerHTML = '<option>Loading...</option>';

    google.script.run.withSuccessHandler(categories => {
        selectEl.innerHTML = ''; // Bersihkan dropdown
        
        if (categories && categories.length > 0) {
            categories.forEach(cat => {
                selectEl.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        } else {
            selectEl.innerHTML = '<option value="">Belum ada kategori</option>';
        }
    }).getKategori();
}

// 3. [PENGGANTI PROMPT] Fungsi Buka Modal Input Kategori
function tambahKategoriBaru() {
    // Reset inputan biar bersih
    document.getElementById('input-kategori-baru-val').value = ''; 
    // Tampilkan Modal Kecil Baru
    new bootstrap.Modal(document.getElementById('modalInputKategori')).show();
    // Auto focus ke input biar user langsung ngetik
    setTimeout(() => document.getElementById('input-kategori-baru-val').focus(), 500);
}

// 4. Fungsi Eksekusi Simpan ke Database
function prosesSimpanKategoriBaru() {
    const namaKategori = document.getElementById('input-kategori-baru-val').value;
    
    if(!namaKategori) return myAlert('Error', 'Nama kategori tidak boleh kosong!', 'warning');

    // Tutup modal input kecil
    const modalEl = document.getElementById('modalInputKategori');
    const modalInstance = bootstrap.Modal.getInstance(modalEl);
    modalInstance.hide();

    loading(true); // Tampilkan loading

    google.script.run.withSuccessHandler(() => {
        loading(false); // Matikan loading
        
        // --- INI KUNCINYA: REFRESH DROPDOWN SETELAH SUKSES ---
        refreshDropdownKategori(); 
        
        // Kasih notif sukses cantik
        myAlert('Berhasil', `Kategori "${namaKategori}" ditambahkan!`, 'success');
        
    }).tambahKategori(namaKategori);
}

// Tambahan: Supaya bisa tekan ENTER di input kategori baru
document.getElementById('input-kategori-baru-val').addEventListener("keypress", function(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    prosesSimpanKategoriBaru();
  }
});

function switchTab(tabId, el) {
    document.querySelectorAll('.tab-content-item').forEach(d => d.classList.add('d-none'));
    document.getElementById('tab-' + tabId).classList.remove('d-none');

    document.querySelectorAll('#payrollTabs .nav-link').forEach(l => {
        l.classList.remove('active', 'text-primary');
        l.classList.add('text-muted');
    });
    if(el) {
        el.classList.add('active', 'text-primary');
        el.classList.remove('text-muted');
    }

    if(tabId === 'karyawan') loadKaryawan();
    if(tabId === 'kasbon') loadKasbon();
    if(tabId === 'kasbon') loadAkunKasbon();
    if(tabId === 'penggajian') initPenggajian();
}

// [BARU] Fungsi untuk mengisi dropdown akun di form kasbon
function loadAkunKasbon() {
    google.script.run.withSuccessHandler(data => {
        const el = document.getElementById('kasbon-akun');
        el.innerHTML = '<option value="">-- Pilih Akun --</option>';
        data.forEach(a => {
            el.innerHTML += `<option value="${a.nama}">${a.nama}</option>`;
        });
    }).getDaftarAkun();
}

// [UPDATE FIX] Preview Foto (Anti Error jika elemen HTML hilang)
function previewKaryawanImage(input) {
    const preview = document.getElementById('kry-preview-foto');
    
    // CEK DULU: Apakah elemen gambar ada?
    if (!preview) {
        console.error("ERROR: Elemen <img id='kry-preview-foto'> tidak ditemukan di index.html");
        alert("Error Tampilan: Kotak preview foto tidak ditemukan. Pastikan Anda sudah update file index.html");
        return; // Berhenti agar tidak error merah
    }

    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// [UPDATE] Reset Modal (Ganti Link Placeholder biar gak Error Merah)
function modalKaryawan() { 
    document.getElementById('kry-id').value = '';
    
    // Placeholder Base64 (Aman Tanpa Internet) - Kotak Abu-abu
    const placeholder = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlZWVlIiAvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIiBmaWxsPSIjYWFhYWFhIj5GT1RPPC90ZXh0Pjwvc3ZnPg==";
    
    document.getElementById('kry-preview-foto').src = placeholder;
    document.getElementById('kry-file-foto').value = '';

    // Reset semua input text
    const ids = ['kry-nama', 'kry-tmp-lahir', 'kry-tgl-lahir', 'kry-email', 'kry-no-id', 'kry-alamat-ktp', 'kry-alamat-dom', 'kry-darurat-nama', 'kry-darurat-telp', 'kry-gaji', 'kry-bonus'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = '';
    });
    
    // Reset Select
    document.getElementById('kry-gender').value = 'Laki-laki';
    document.getElementById('kry-tipe-id').value = 'KTP';

    new bootstrap.Modal(document.getElementById('modalKaryawan')).show(); 
}

// [FUNGSI BARU: BUKA EDIT (POPULATE DATA)]
function bukaEditKaryawan(index) {
    const d = globalListKaryawan[index];
    if(!d) return;

    // Set Value dari Data Array
    // Urutan Array: 0:ID, 1:Nama, 2:TmpLahir, 3:TglLahir, 4:Gender, 5:NoID, 6:TipeID, 7:Email, 8:AlamatKTP, 9:Domisili, 10:DaruratNama, 11:DaruratTelp, 12:Gaji, 13:Bonus, 14:Foto, 15:Status
    
    document.getElementById('kry-id').value = d[0];
    document.getElementById('kry-nama').value = d[1];
    document.getElementById('kry-tmp-lahir').value = d[2];
    
    // Format Tanggal Lahir (YYYY-MM-DD)
    if(d[3]) {
        let tgl = new Date(d[3]);
        // Fix offset timezone
        tgl.setMinutes(tgl.getMinutes() - tgl.getTimezoneOffset());
        document.getElementById('kry-tgl-lahir').value = tgl.toISOString().split('T')[0];
    }

    if(d[4] === 'Perempuan') document.getElementById('genderP').checked = true;
    else document.getElementById('genderL').checked = true;

    document.getElementById('kry-no-id').value = d[5];
    document.getElementById('kry-tipe-id').value = d[6] || 'KTP';
    document.getElementById('kry-email').value = d[7];
    document.getElementById('kry-alamat-ktp').value = d[8];
    document.getElementById('kry-alamat-dom').value = d[9];
    
    document.getElementById('kry-darurat-nama').value = d[10];
    document.getElementById('kry-darurat-telp').value = d[11];

    document.getElementById('kry-gaji').value = Number(d[12]).toLocaleString('id-ID');
    document.getElementById('kry-bonus').value = Number(d[13]).toLocaleString('id-ID');

    // Handle Foto (LOGIKA BARU)
    document.getElementById('kry-foto-lama').value = d[14];
    
    if(d[14] && d[14].length > 5) {
        // JIKA ADA FOTO:
        const imgEl = document.getElementById('kry-preview-img');
        imgEl.src = d[14];
        imgEl.classList.remove('d-none');                // Muncul Foto
        document.getElementById('kry-no-foto').classList.add('d-none'); // Sembunyi Icon
    } else {
        // JIKA TIDAK ADA FOTO (Pakai Icon):
        document.getElementById('kry-preview-img').src = '';
        document.getElementById('kry-preview-img').classList.add('d-none'); // Sembunyi Foto
        document.getElementById('kry-no-foto').classList.remove('d-none');  // Muncul Icon
    }

    // Reset Input File
    document.getElementById('kry-foto-input').value = '';
    
    // Buka Tab Pertama
    const firstTab = new bootstrap.Tab(document.querySelector('#pribadi-tab'));
    firstTab.show();

    new bootstrap.Modal(document.getElementById('modalKaryawan')).show();
}

// [UPDATE FIX] Buka Edit Karyawan (Versi Anti-Error / Safe Mode)
function bukaEditKaryawan(id) {
    loading(true);
    google.script.run.withSuccessHandler(data => {
        loading(false);
        
        // 1. Cari Data Karyawan
        const k = data.find(row => row[0] == id);
        if(!k) return myAlert('Error', 'Data karyawan tidak ditemukan!', 'error');

        // 2. Helper Aman: Hanya isi jika elemen ada di HTML
        const setVal = (elmId, val) => {
            const el = document.getElementById(elmId);
            if(el) {
                el.value = (val === undefined || val === null) ? '' : val;
            } else {
                console.warn('Element HTML tidak ditemukan:', elmId);
            }
        };

        // 3. Isi Form (Menggunakan Helper Aman)
        setVal('kry-id', k[0]);
        setVal('kry-nama', k[1]);
        setVal('kry-tmp-lahir', k[2]);
        
        // Format Tanggal (Safe)
        try {
            if(k[3]) {
                let d = new Date(k[3]);
                let yyyy = d.getFullYear();
                let mm = String(d.getMonth()+1).padStart(2,'0');
                let dd = String(d.getDate()).padStart(2,'0');
                setVal('kry-tgl-lahir', `${yyyy}-${mm}-${dd}`);
            } else {
                setVal('kry-tgl-lahir', '');
            }
        } catch(e) { setVal('kry-tgl-lahir', ''); }

        setVal('kry-gender', k[4] || 'Laki-laki');
        setVal('kry-no-id', k[5]);
        setVal('kry-tipe-id', k[6] || 'KTP');
        setVal('kry-email', k[7]);
        setVal('kry-alamat-ktp', k[8]);
        setVal('kry-alamat-dom', k[9]);
        setVal('kry-darurat-nama', k[10]);
        setVal('kry-darurat-telp', k[11]);
        
        // Handle Tanggal Masuk (Safe Check)
        try {
            if(k[16]) { // Index 16 = Kolom Q
                let dm = new Date(k[16]);
                let yyyy = dm.getFullYear();
                let mm = String(dm.getMonth()+1).padStart(2,'0');
                let dd = String(dm.getDate()).padStart(2,'0');
                setVal('kry-tgl-masuk', `${yyyy}-${mm}-${dd}`);
            } else {
                setVal('kry-tgl-masuk', '');
            }
        } catch(e) { setVal('kry-tgl-masuk', ''); }
        
        // Format Angka (Safe)
        const gaji = k[12] ? Number(k[12]) : 0;
        const bonus = k[13] ? Number(k[13]) : 0;
        setVal('kry-gaji', gaji.toLocaleString('id-ID'));
        setVal('kry-bonus', bonus.toLocaleString('id-ID'));

        // 4. Handle Foto (Safe)
        const imgEl = document.getElementById('kry-preview-foto');
        const fileIn = document.getElementById('kry-file-foto');
        
        // Placeholder default (Base64)
        const placeholder = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlZWVlIiAvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIiBmaWxsPSIjYWFhYWFhIj5GT1RPPC90ZXh0Pjwvc3ZnPg==";

        if(imgEl) {
            const urlFoto = k[14];
            if(urlFoto && urlFoto.length > 10) {
                imgEl.src = urlFoto;
            } else {
                imgEl.src = placeholder;
            }
        }
        
        if(fileIn) fileIn.value = ''; // Reset input file

        // 5. Buka Modal
        const modalEl = document.getElementById('modalKaryawan');
        if(modalEl) {
            new bootstrap.Modal(modalEl).show();
        } else {
            alert('Error: Modal HTML (id="modalKaryawan") tidak ditemukan. Pastikan Anda sudah update index.html!');
        }

    }).getData('KARYAWAN');
}

// [UPDATE FIX] Simpan Karyawan (Anti-Crash: Cek Elemen Dulu)
function simpanKaryawanDB() {
    // 1. Ambil Element File dengan Pengecekan Aman
    const fileInput = document.getElementById('kry-file-foto');
    let file = null;
    
    // Cek dulu: Apakah elemennya ada?
    if (fileInput && fileInput.files) {
        file = fileInput.files[0];
    } else {
        console.warn("Input file foto tidak ditemukan di HTML. Foto diabaikan.");
    }

    // 2. Ambil Helper Value (Fungsi kecil biar gak error kalau ID salah)
    const getVal = (id) => {
        const el = document.getElementById(id);
        return el ? el.value : '';
    };

    // 3. Susun Data
    const d = { 
        id: getVal('kry-id'), 
        nama: getVal('kry-nama'), 
        tmpLahir: getVal('kry-tmp-lahir'),
        tglLahir: getVal('kry-tgl-lahir'),
        gender: getVal('kry-gender'),
        noId: getVal('kry-no-id'),
        tipeId: getVal('kry-tipe-id'),
        email: getVal('kry-email'),
        alamatId: getVal('kry-alamat-ktp'),
        alamatDom: getVal('kry-alamat-dom'),
        daruratNama: getVal('kry-darurat-nama'),
        daruratTelp: getVal('kry-darurat-telp'),
        // Hapus titik pada format rupiah
        gaji: getVal('kry-gaji').replace(/\./g, ''),
        bonus: getVal('kry-bonus').replace(/\./g, ''),
        tglMasuk: getVal('kry-tgl-masuk'), // <--- TAMBAHKAN INI
        foto: null
    };

    // Validasi Sederhana
    if(!d.nama) return myAlert('Error', 'Nama karyawan wajib diisi!', 'warning');

    // 4. Logika Foto Lama (Jika Edit)
    if(d.id) {
        const imgPreview = document.getElementById('kry-preview-foto');
        if(imgPreview) {
            const currentSrc = imgPreview.src;
            // Jika src bukan placeholder base64 default, berarti itu foto lama
            if(currentSrc.includes('googleusercontent') || currentSrc.includes('drive.google')) {
                d.foto = currentSrc;
            }
        }
    }

    // 5. Fungsi Kirim ke Server
    const kirim = (payload) => {
        loading(true);
        google.script.run
            // [UPDATE] Bagian Success Handler di simpanKaryawanDB
            .withSuccessHandler((res) => {
                loading(false); 
                
                // 1. Tutup Modal
                const modalEl = document.getElementById('modalKaryawan');
                if(modalEl) bootstrap.Modal.getInstance(modalEl).hide();
                
                // 2. Refresh Tabel Karyawan
                loadKaryawan(); 
                
                // 3. [BARU] Refresh Halaman Penggajian (Jika sedang dibuka)
                // Cek apakah user sedang membuka tab penggajian dan sudah pilih periode?
                const periodeInput = document.getElementById('filter-periode-gaji');
                if(periodeInput && periodeInput.value) {
                    // Panggil cekDataGaji agar karyawan baru langsung terdeteksi (muncul kuning)
                    cekDataGaji(); 
                }

                myAlert('Berhasil', res, 'success');
            })
            .withFailureHandler((err) => {
                loading(false);
                myAlert('Gagal', err.message, 'error');
            })
            .simpanKaryawan(payload);
    };

    // 6. Eksekusi (Dengan atau Tanpa Upload Foto)
    if (file) {
        // Cek Ukuran (Maks 2MB)
        if(file.size > 2 * 1024 * 1024) return myAlert('Error', 'Ukuran foto maksimal 2MB', 'warning');
        
        const reader = new FileReader();
        reader.onload = function(e) {
            d.foto = {
                data: e.target.result.split(',')[1],
                mimeType: file.type,
                fileName: file.name
            };
            kirim(d);
        };
        reader.readAsDataURL(file);
    } else {
        // Simpan tanpa ganti foto baru
        kirim(d);
    }
}

// [UPDATE FIX] Load Karyawan (Anti Error Null & Tampilan Baru)
function loadKaryawan() {
    const tb = document.querySelector('#tabel-karyawan tbody');
    if(tb) tb.innerHTML = '<tr><td colspan="5" class="text-center py-3">Memuat data...</td></tr>';

    google.script.run
    .withFailureHandler(err => {
        console.log("Gagal load karyawan: " + err);
        if(tb) tb.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal mengambil data. Coba Refresh.</td></tr>';
    })
    .withSuccessHandler(d => {
      const sk = document.getElementById('kasbon-nama');
      if(tb) tb.innerHTML=''; 
      if(sk) sk.innerHTML='';
      
      // [PENTING] Tambahkan (d || []) untuk mencegah error "reading forEach of null"
      const dataAman = d || []; 

      if(dataAman.length === 0) {
          if(tb) tb.innerHTML = '<tr><td colspan="5" class="text-center text-muted fst-italic py-3">Belum ada data karyawan.</td></tr>';
          return;
      }
      
      dataAman.forEach(r => {
        // r[1] = Nama, r[12] = Gaji, r[13] = Bonus, r[14] = Foto URL
        
        // Ambil Foto (Kolom O / Index 14)
        let imgHtml = '';
        if(r[14] && r[14].length > 10) {
            imgHtml = `<img src="${r[14]}" class="rounded-circle border me-2" style="width:35px; height:35px; object-fit:cover;">`;
        } else {
            // Avatar inisial jika tidak ada foto
            let inisial = r[1] ? r[1].substring(0,2).toUpperCase() : 'NA';
            imgHtml = `<div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width:35px; height:35px; font-size:12px;">${inisial}</div>`;
        }

        // Format Rupiah (Safe Check)
        let gaji = r[12] ? Number(r[12]) : 0;
        let bonus = r[13] ? Number(r[13]) : 0;

        // Render Baris Tabel
        if(tb) {
            tb.innerHTML += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        ${imgHtml}
                        <div>
                            <div class="fw-bold text-dark">${r[1]}</div>
                            <small class="text-muted" style="font-size:10px;">${r[6] || 'ID'}: ${r[5] || '-'}</small>
                        </div>
                    </div>
                </td>
                <td>
                    ${r[11] || '-'}<br>
                    <small class="text-muted" style="font-size:10px;">Darurat: ${r[10] || '-'}</small>
                </td>
                <td>${rupiah(gaji)}</td>
                <td>${rupiah(bonus)}</td>
                <td>
                    <button class="btn btn-sm btn-warning text-dark me-1" onclick="bukaEditKaryawan('${r[0]}')">
                        <i class="material-icons" style="font-size:14px">edit</i>
                    </button>
                    <button class="btn btn-sm btn-light text-danger border" onclick="hapusKaryawan('${r[0]}')">
                        <i class="material-icons" style="font-size:14px">delete</i>
                    </button>
                </td>
            </tr>`;
        }
        if(sk) sk.innerHTML+=`<option>${r[1]}</option>`;
      });
    }).getData('KARYAWAN');
}



function hapusKaryawan(id) { if(confirm('Hapus?')) google.script.run.withSuccessHandler(loadKaryawan).hapusKaryawan(id); }

// 1. UPDATE FUNGSI LOAD KASBON (Tambah Tombol Detail & Keterangan)
function loadKasbon() {
    const filter = document.getElementById('filter-status-kasbon').value;
    const tb = document.querySelector('#tabel-kasbon tbody');
    tb.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';

    google.script.run.withSuccessHandler(data => {
        tb.innerHTML = '';
        let filtered = data;
        if(filter !== 'Semua') {
            filtered = data.filter(x => String(x[5]).includes(filter));
        }

        if(filtered.length === 0) {
            tb.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Tidak ada data.</td></tr>';
            return;
        }

        filtered.forEach(r => {
            // r[0]:ID, r[1]:Tgl, r[2]:Nama, r[3]:Total, r[4]:Keterangan, r[5]:Status, r[6]:SudahBayar, r[8]:Angsuran
            
            let tgl = new Date(r[1]).toLocaleDateString('id-ID');
            let sudahBayar = Number(r[6]) || 0;
            let sisa = Number(r[3]) - sudahBayar;
            
            let statusBadge = r[5].includes('Belum') 
                ? '<span class="badge bg-danger">Belum Lunas</span>' 
                : '<span class="badge bg-success">Lunas</span>';

            // [BARU] Ambil Keterangan & Pembayaran Via Apa
            // Kita batasi panjang teks biar tabel tidak terlalu lebar
            let ketDisplay = r[4] ? r[4] : '-';
            if(ketDisplay.length > 35) ketDisplay = ketDisplay.substring(0, 35) + '...';

            tb.innerHTML += `
                <tr class="align-middle"> <td>${tgl}</td>
                    <td>
                        <div class="fw-bold">${r[2]}</div>
                        <small class="text-muted fst-italic" style="font-size:11px; display:block; line-height:1.2;">
                            ${ketDisplay}
                        </small>
                    </td>
                    <td>
                        <div class="fw-bold">${rupiah(r[3])}</div>
                        <small class="text-muted">Sisa: <span class="text-danger fw-bold">${rupiah(sisa)}</span></small>
                    </td>
                    <td>${rupiah(r[8])}<small>/bln</small></td>
                    <td>
                        <div class="d-flex flex-column align-items-center gap-1">
                            ${statusBadge}
                            <button class="btn btn-sm btn-outline-dark rounded-pill px-3" onclick="bukaModalBayarKasbon('${r[0]}', '${r[2]}', ${r[3]}, ${sudahBayar})">
                                Detail / Bayar
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
    }).getDataKasbonFull();
}

// [UPDATE] 1. Buka Modal & Load Akun
function bukaModalBayarKasbon(id, nama, total, sudah) {
    let sisa = total - sudah;
    
    // Isi Info di Modal
    document.getElementById('det-kasbon-id').value = id;
    document.getElementById('det-kasbon-nama').innerText = nama;
    document.getElementById('det-kasbon-total').innerText = rupiah(total);
    document.getElementById('det-kasbon-sudah').innerText = rupiah(sudah);
    document.getElementById('det-kasbon-sisa').innerText = rupiah(sisa);
    document.getElementById('input-bayar-cicilan').value = '';

    // Tampilkan/Sembunyikan Form Bayar
    const formArea = document.getElementById('form-bayar-manual-area');
    if(sisa <= 0) {
        formArea.classList.add('d-none'); // Sudah lunas, sembunyikan form bayar
    } else {
        formArea.classList.remove('d-none');
        
        // --- [BAGIAN PENTING] LOAD DATA AKUN KE DROPDOWN ---
        const selAkun = document.getElementById('input-bayar-akun');
        selAkun.innerHTML = '<option value="">Loading...</option>';
        
        google.script.run.withSuccessHandler(akunList => {
            selAkun.innerHTML = '';
            akunList.forEach(a => {
                // Default pilih "Kas Tunai" jika ada, agar cepat
                let selected = a.nama.toLowerCase().includes('tunai') ? 'selected' : '';
                selAkun.innerHTML += `<option value="${a.nama}" ${selected}>${a.nama}</option>`;
            });
        }).getDaftarAkun();
    }

    // Load History Pembayaran (Tabel Bawah)
    const tbHistory = document.querySelector('#tabel-history-cicilan tbody');
    tbHistory.innerHTML = '<tr><td colspan="4" class="text-center">Memuat riwayat...</td></tr>';
    const btnCetakRekap = document.getElementById('btn-cetak-rekap');
    if(btnCetakRekap) btnCetakRekap.disabled = true;

    new bootstrap.Modal(document.getElementById('modalDetailKasbon')).show();

    // Ambil Data Riwayat dari Server
    google.script.run.withSuccessHandler(hist => {
        tbHistory.innerHTML = '';

        if(!hist || hist.length === 0) {
            tbHistory.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Belum ada pembayaran.</td></tr>';
            return;
        }

        // Aktifkan tombol cetak
        if(btnCetakRekap) {
            btnCetakRekap.disabled = false;
            btnCetakRekap.onclick = () => {
                const dataLengkap = {
                    idKasbon: id,
                    namaKaryawan: nama,
                    totalPinjam: total,
                    totalBayar: sudah,
                    sisaHutang: sisa,
                    listRiwayat: hist
                };
                cetakRekapKasbonFull(dataLengkap);
            };
        }

        hist.forEach(h => {
            let tgl = new Date(h.tanggal).toLocaleDateString('id-ID');
            let badgeTipe = h.tipe.includes('Manual') 
                ? `<span class="badge bg-primary bg-opacity-10 text-primary border border-primary-subtle" style="font-size:10px">Manual</span>` 
                : `<span class="badge bg-warning bg-opacity-10 text-warning-emphasis border border-warning-subtle" style="font-size:10px">Payroll</span>`;
            
            // Data untuk cetak struk per transaksi
            const printData = JSON.stringify({
                idKasbon: id, 
                nama: nama,
                tanggal: tgl,
                nominal: h.nominal,
                tipe: h.tipe,
                ket: h.ket,
                sisa: sisa 
            }).replace(/"/g, "&quot;");

            tbHistory.innerHTML += `
                <tr>
                    <td>${tgl}</td>
                    <td>${badgeTipe}<br><small class="text-muted" style="font-size:9px">${h.ket}</small></td>
                    <td class="text-end fw-bold">${rupiah(h.nominal)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-light border rounded-circle p-1" onclick="cetakSlipKasbon(${printData})" title="Cetak Struk">
                            <i class="material-icons" style="font-size:14px">print</i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }).getDetailHistoryKasbon(id);
}

// [UPDATE] 2. Proses Bayar (Kirim Data Akun ke Server)
function prosesBayarCicilanManual() {
    const id = document.getElementById('det-kasbon-id').value;
    const nama = document.getElementById('det-kasbon-nama').innerText; 
    
    // AMBIL NILAI INPUT
    const akunDipilih = document.getElementById('input-bayar-akun').value;
    const rawNominal = document.getElementById('input-bayar-cicilan').value;
    const nominal = Number(rawNominal.replace(/\./g, '')); // Buang titik ribuan

    // VALIDASI
    if(!akunDipilih) return myAlert('Pilih Akun', 'Harap pilih akun penerima dana (misal: Kas Tunai).', 'warning');
    if(!nominal || nominal <= 0) return myAlert('Nominal Kosong', 'Masukkan jumlah pembayaran.', 'warning');

    myConfirm('Terima Pembayaran', `Terima uang Rp ${rawNominal} dari ${nama}?\n(Masuk ke: ${akunDipilih})`, () => {
        loading(true);
        
        const payload = { 
            idKasbon: id, 
            nominal: nominal,
            akun: akunDipilih, // <-- INI YANG BIKIN SALDO NAMBAH
            keterangan: 'Pembayaran Cicilan Manual'
        };

        google.script.run.withSuccessHandler(res => {
            loading(false);
            
            // Tutup Modal
            bootstrap.Modal.getInstance(document.getElementById('modalDetailKasbon')).hide();
            
            // Notifikasi Sukses
            myAlert('Berhasil', res, 'success');
            
            // Refresh Data
            loadKasbon();     // Update sisa hutang di tabel
            loadDashboard();  // Update grafik & info
            loadKeuangan();   // Update tabel keuangan (Pemasukan tercatat)

        }).bayarCicilanManual(payload);
    });
}

// [FIXED] Fungsi Proses Bayar dengan Data Lengkap
function prosesBayarCicilanManual() {
    const id = document.getElementById('det-kasbon-id').value;
    // Ambil nama karyawan dari Teks Modal
    const nama = document.getElementById('det-kasbon-nama').innerText; 
    
    const akunDipilih = document.getElementById('input-bayar-akun').value;
    const rawNominal = document.getElementById('input-bayar-cicilan').value;
    const nominal = Number(rawNominal.replace(/\./g, '')); 

    if(!akunDipilih) return myAlert('Pilih Akun', 'Harap pilih akun penerima dana.', 'warning');
    if(!nominal || nominal <= 0) return myAlert('Nominal Kosong', 'Masukkan jumlah pembayaran.', 'warning');

    myConfirm('Terima Pembayaran', `Terima uang Rp ${rawNominal} dari ${nama}?\n(Masuk ke: ${akunDipilih})`, () => {
        loading(true);
        
        // KITA KIRIM NAMA KARYAWAN KE SERVER AGAR TIDAK ERROR
        const payload = { 
            idKasbon: id, 
            namaKaryawan: nama,   // <--- INI TAMBAHAN PENTING
            nominal: nominal,
            akun: akunDipilih,
            keterangan: 'Pembayaran Cicilan Manual'
        };

        google.script.run
            .withSuccessHandler(res => {
                loading(false);
                bootstrap.Modal.getInstance(document.getElementById('modalDetailKasbon')).hide();
                myAlert('Berhasil', res, 'success');
                
                loadKasbon();     
                loadDashboard();  
                loadKeuangan();   
            })
            .withFailureHandler(err => {
                loading(false);
                myAlert('Gagal', 'Error: ' + err.message, 'error');
            })
            .bayarCicilanManual(payload);
    });
}

function initPenggajian() {
    // Set default bulan ini
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const picker = document.getElementById('filter-periode-gaji');
    
    // 1. Jika kosong, isi tanggal default dulu
    if(!picker.value) {
        picker.value = `${yyyy}-${mm}`;
    }

    // 2. [SOLUSI] Selalu panggil fungsi load data setiap kali fungsi ini jalan
    cekDataGaji(); 
}

// [UPDATE FIX] Cek Data Gaji (Support Karyawan Susulan)
// [UPDATE RAPI] Cek Data Gaji (Sudah Cair)
function cekDataGaji() {
    const periode = document.getElementById('filter-periode-gaji').value;
    if(!periode) return;

    const btnArea = document.getElementById('btn-area-gaji');
    const msg = document.getElementById('status-periode-msg');
    const tbody = document.getElementById('tbody-gaji');

    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5"><div class="spinner-border text-primary spinner-border-sm"></div> Memuat data...</td></tr>';
    btnArea.innerHTML = '';

    google.script.run
    .withFailureHandler(err => {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-4">Gagal: ${err.message}</td></tr>`;
    })
    .withSuccessHandler(data => {
        const safeData = data || []; 
        let totalOrang = safeData.length;
        let belumDigaji = safeData.filter(x => x.status === 'Belum Digaji').length;
        
        if(totalOrang > 0) {
            tbody.innerHTML = '';
            
            // Render Tabel
            safeData.forEach(row => {
                let isLunas = row.status !== 'Belum Digaji';
                let badge = isLunas 
                    ? `<span class="badge bg-success rounded-pill px-3">LUNAS</span>` 
                    : `<span class="badge bg-warning text-dark rounded-pill px-3">BELUM CAIR</span>`;
                
                let btnAksi = isLunas ? `
                        <button class="btn btn-sm btn-dark rounded-pill px-3 shadow-sm" onclick="cetakSlipGaji(${JSON.stringify(row).replace(/"/g, "&quot;")})">
                            <i class="material-icons align-middle" style="font-size:12px">print</i> Slip
                        </button>` : `<small class="text-muted fst-italic">Pending...</small>`;

                tbody.innerHTML += `
                    <tr class="${!isLunas ? 'table-warning' : ''}">
                        <td class="fw-bold text-dark">
                             <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-light border text-muted d-flex align-items-center justify-content-center me-2" style="width:32px; height:32px; font-size:12px;">${row.nama.substring(0,2).toUpperCase()}</div>
                                ${row.nama}
                            </div>
                        </td>
                        <td class="text-end text-end-num text-muted">${rupiah(row.gaji)}</td>
                        <td class="text-end text-end-num text-success fw-bold">${rupiah(row.bonus)}</td>
                        <td class="text-end text-end-num text-danger">${rupiah(row.kasbon)}</td>
                        <td class="text-end text-end-num fw-bold text-primary bg-primary-subtle">${rupiah(row.total)}</td>
                        <td class="text-center">${badge}</td>
                        <td class="text-center">${btnAksi}</td>
                    </tr>
                `;
            });
            
            // Logic Pesan Status (Tetap sama seperti sebelumnya)
            if (belumDigaji > 0) {
                msg.innerHTML = `<span class="text-warning fw-bold"><i class="material-icons align-middle">info</i> Ditemukan ${belumDigaji} Karyawan Baru Belum Digaji!</span>`;
                btnArea.innerHTML = `<button class="btn btn-warning rounded-pill fw-bold shadow px-4" onclick="loadPreviewHitungGaji('${periode}')"><i class="material-icons align-middle">update</i> UPDATE PENCAIRAN (+${belumDigaji})</button>`;
            } else {
                msg.innerHTML = `<span class="text-success fw-bold"><i class="material-icons align-middle">check_circle</i> Periode ${periode} Selesai (${totalOrang} Orang).</span>`;
                btnArea.innerHTML = `<button class="btn btn-outline-dark rounded-pill fw-bold" onclick="printLaporanPDF('tabel-gaji-detail', 'Rekap Gaji ${periode}')"><i class="material-icons align-middle">print</i> Cetak Laporan</button>`;
            }

        } else {
            msg.innerHTML = `<span class="text-muted">Data Gaji Periode ${periode} Belum Ada.</span>`;
            loadPreviewHitungGaji(periode);
        }
    }).getRiwayatGajiByPeriode(periode);
}

// [UPDATE FIX TOMBOL] Load Preview Hanya Yang Belum Lunas & Munculkan Tombol Cairkan
function loadPreviewHitungGaji(periode) {
    const tbody = document.getElementById('tbody-gaji');
    const btnArea = document.getElementById('btn-area-gaji');

    // Tampilkan Loading
    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="spinner-border text-primary spinner-border-sm"></div> Memuat karyawan pending...</td></tr>';

    google.script.run
    .withFailureHandler(err => {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Gagal: ${err.message}</td></tr>`;
    })
    .withSuccessHandler(data => {
        const safeData = data || []; 

        // 1. FILTER: Ambil hanya yang "Belum Digaji"
        const pendingList = safeData.filter(x => x.status === 'Belum Digaji');

        if (pendingList.length === 0) {
             tbody.innerHTML = '<tr><td colspan="7" class="text-center text-success fw-bold py-5"><i class="material-icons d-block mb-2" style="font-size:32px">check_circle</i>Semua karyawan sudah digaji untuk periode ini.</td></tr>';
             btnArea.innerHTML = ''; // Kosongkan tombol jika tidak ada data
             return;
        }

        // 2. MAPPING DATA KE SESSION (Agar bisa diedit)
        sessionPayrollData = pendingList.map(item => ({
            id: item.id,
            nama: item.nama,
            gaji: Number(item.gaji),
            bonus: Number(item.bonus),
            kasbonPotongan: Number(item.kasbon), 
            sisaHutang: 0, 
            total: Number(item.total),
            
            // Default Status Draft
            statusVerifikasi: 'Draft',
            kasbonBaru: 0,
            potonganLain: 0,
            ketKasbonBaru: ''
        })); 

        // 3. [PENTING] PASANG TOMBOL "CAIRKAN" DULU SEBELUM RENDER TABEL
        // Agar saat renderTabelPayroll() jalan, dia bisa mendeteksi tombol ini.
        btnArea.innerHTML = `
            <button id="btn-cairkan-final" class="btn btn-secondary rounded-pill fw-bold shadow px-4" onclick="prosesCairkanSemua('${periode}')" disabled>
                <i class="material-icons align-middle">lock</i> BELUM ADA YANG VERIFIKASI
            </button>
        `;
        
        // 4. RENDER TABEL (Ini akan otomatis update status tombol di atas)
        renderTabelPayroll(); 

        // 5. UPDATE PESAN HEADER
        const msg = document.getElementById('status-periode-msg');
        if(msg) msg.innerHTML = `<span class="text-warning fw-bold"><i class="material-icons align-middle">edit</i> Memproses ${pendingList.length} karyawan yang belum digaji.</span>`;

    }).getRiwayatGajiByPeriode(periode); 
}

// [UPDATE RAPI] Render Tabel Payroll (Draft)
function renderTabelPayroll() {
    const tbody = document.getElementById('tbody-gaji');
    tbody.innerHTML = '';
    
    let verifiedCount = 0;

    if(sessionPayrollData.length === 0) {
         tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted fst-italic py-5">Tidak ada data karyawan aktif.</td></tr>';
         return;
    }

    sessionPayrollData.forEach((p, index) => {
        let badgeStatus = p.statusVerifikasi === 'Sesuai' 
            ? '<span class="badge bg-success-subtle text-success border border-success rounded-pill px-3">SESUAI</span>' 
            : '<span class="badge bg-secondary-subtle text-secondary border border-secondary rounded-pill px-3">DRAFT</span>';
        
        if(p.statusVerifikasi === 'Sesuai') verifiedCount++;

        let infoHutang = p.sisaHutang > 0 ? `<div class="text-danger small mt-1" style="font-size:11px"><i class="material-icons" style="font-size:10px">warning</i> Sisa Hutang: ${rupiah(p.sisaHutang)}</div>` : '';
        let totalPotongan = (p.kasbonPotongan || 0) + (p.potonganLain || 0);

        // Class 'text-end-num' dari style.html untuk angka rata kanan
        tbody.innerHTML += `
            <tr id="row-gaji-${index}" class="${p.statusVerifikasi === 'Sesuai' ? 'bg-success-subtle' : ''}">
                <td class="fw-bold text-dark">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width:32px; height:32px; font-size:12px;">${p.nama.substring(0,2).toUpperCase()}</div>
                        <div>
                            ${p.nama}
                            ${infoHutang}
                        </div>
                    </div>
                </td>
                <td class="text-end text-end-num text-muted">${rupiah(p.gaji)}</td>
                <td class="text-end text-end-num text-success fw-bold">${rupiah(p.bonus)}</td>
                <td class="text-end text-end-num text-danger">${rupiah(totalPotongan)}</td>
                <td class="text-end text-end-num fw-bold text-primary fs-6 bg-primary-subtle">${rupiah(p.total)}</td>
                <td class="text-center">${badgeStatus}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary rounded-pill px-3 shadow-sm" onclick="bukaModalVerifikasi(${index})">
                        Edit
                    </button>
                </td>
            </tr>
        `;
    });
    
    // --- BAGIAN INI YANG DIUBAH AGAR BISA PARTIAL ---
    const btnFinal = document.getElementById('btn-cairkan-final');
    if(btnFinal) {
        // Logika Baru: Tombol AKTIF jika ada MINIMAL 1 yang terverifikasi (verifiedCount > 0)
        // Tidak perlu menunggu semua (verifiedCount === sessionPayrollData.length)
        
        if(verifiedCount > 0) {
            btnFinal.disabled = false;
            btnFinal.className = "btn btn-success rounded-pill fw-bold shadow px-4";
            
            // Teks tombol menunjukkan berapa orang yang akan dibayar
            // Contoh: "CAIRKAN GAJI (2 Org)"
            btnFinal.innerHTML = `<i class="material-icons align-middle">payments</i> CAIRKAN GAJI (${verifiedCount})`;
        } else {
            // Jika belum ada satupun yang diverifikasi
            btnFinal.disabled = true;
            btnFinal.className = "btn btn-secondary rounded-pill fw-bold shadow px-4";
            btnFinal.innerHTML = `<i class="material-icons align-middle">lock</i> BELUM ADA YANG VERIFIKASI`;
        }
    }
}

// [UPDATE] Buka Modal & Isi Data (Dengan Tombol Batal Verifikasi)
function bukaModalVerifikasi(index) {
    const data = sessionPayrollData[index];
    
    document.getElementById('ver-index').value = index;
    document.getElementById('ver-nama').innerText = data.nama;
    document.getElementById('ver-jabatan').innerText = data.statusVerifikasi === 'Sesuai' ? 'SUDAH DIVERIFIKASI' : 'Status: Draft';
    
    // Warnai badge status di modal biar jelas
    const badgeEl = document.getElementById('ver-jabatan');
    if(data.statusVerifikasi === 'Sesuai') {
        badgeEl.className = 'badge bg-success text-white border';
    } else {
        badgeEl.className = 'badge bg-light text-dark border';
    }
    
    // Set Nilai Input (Format Ribuan)
    document.getElementById('ver-gaji').value = Number(data.gaji).toLocaleString('id-ID');
    document.getElementById('ver-bonus').value = Number(data.bonus).toLocaleString('id-ID');
    
    // Potongan Kasbon (Cicilan)
    document.getElementById('ver-potongan-kasbon').value = Number(data.kasbonPotongan).toLocaleString('id-ID');
    document.getElementById('info-sisa-hutang').innerText = `Total Hutang: ${rupiah(data.sisaHutang)}`;

    // Potongan Lain (Manual)
    document.getElementById('ver-potongan-lain').value = Number(data.potonganLain || 0).toLocaleString('id-ID');

    // Kasbon Baru (Jika ada)
    const checkKasbon = document.getElementById('check-kasbon-baru');
    const areaKasbon = document.getElementById('area-kasbon-baru');
    const inputKasbonBaru = document.getElementById('ver-kasbon-baru');
    const inputKasbonKet = document.getElementById('ver-kasbon-ket');

    if(data.kasbonBaru > 0) {
        checkKasbon.checked = true;
        areaKasbon.classList.remove('d-none');
        inputKasbonBaru.value = Number(data.kasbonBaru).toLocaleString('id-ID');
        inputKasbonKet.value = data.ketKasbonBaru;
    } else {
        checkKasbon.checked = false;
        areaKasbon.classList.add('d-none');
        inputKasbonBaru.value = '';
        inputKasbonKet.value = '';
    }

    hitungTotalModal(); // Hitung awal

    // --- LOGIKA BARU: TOMBOL DRAFT ---
    const modalFooter = document.querySelector('#modalDetailGaji .modal-footer');
    let btnDraft = '';

    // Jika statusnya sudah SESUAI, munculkan tombol "Kembalikan ke Draft" warna Kuning
    if(data.statusVerifikasi === 'Sesuai') {
        btnDraft = `
        <button type="button" class="btn btn-warning rounded-pill me-auto fw-bold text-dark shadow-sm" onclick="kembalikanKeDraft(${index})">
            <i class="material-icons align-middle">undo</i> Jadi Draft Lagi
        </button>`;
    }

    modalFooter.innerHTML = `
        ${btnDraft}
        <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Tutup</button>
        <button type="button" class="btn btn-success rounded-pill fw-bold px-4 shadow" onclick="simpanVerifikasiKaryawan()">
            <i class="material-icons align-middle me-1">check_circle</i> ${data.statusVerifikasi === 'Sesuai' ? 'UPDATE DATA' : 'SESUAI'}
        </button>
    `;

    new bootstrap.Modal(document.getElementById('modalDetailGaji')).show();
}

// [BARU] Fungsi untuk membatalkan status Sesuai menjadi Draft
function kembalikanKeDraft(index) {
    // 1. Ubah status data di memori sementara
    sessionPayrollData[index].statusVerifikasi = 'Draft';

    // 2. Tutup Modal
    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('modalDetailGaji'));
    if(modalInstance) modalInstance.hide();

    // 3. Render ulang tabel (Baris akan kembali jadi abu-abu/putih)
    renderTabelPayroll();

    // 4. Notif kecil (Opsional)
    // myAlert('Info', 'Status dikembalikan ke Draft.', 'info');
}

// [BARU] Toggle Input Kasbon Baru
function toggleKasbonBaru() {
    const isChecked = document.getElementById('check-kasbon-baru').checked;
    const area = document.getElementById('area-kasbon-baru');
    if(isChecked) {
        area.classList.remove('d-none');
        document.getElementById('ver-kasbon-baru').focus();
    } else {
        area.classList.add('d-none');
        document.getElementById('ver-kasbon-baru').value = 0;
        hitungTotalModal();
    }
}

// [BARU] Hitung Realtime di dalam Modal
function hitungTotalModal() {
    const gaji = Number(document.getElementById('ver-gaji').value.replace(/\./g, '')) || 0;
    const bonus = Number(document.getElementById('ver-bonus').value.replace(/\./g, '')) || 0;
    const cicilan = Number(document.getElementById('ver-potongan-kasbon').value.replace(/\./g, '')) || 0;
    const potLain = Number(document.getElementById('ver-potongan-lain').value.replace(/\./g, '')) || 0;
    
    // Kasbon Baru (Menambah Uang Diterima, tapi nanti jadi hutang)
    // Logika: Karyawan terima Gaji + Uang Pinjaman Baru
    let kasbonBaru = 0;
    if(document.getElementById('check-kasbon-baru').checked) {
        kasbonBaru = Number(document.getElementById('ver-kasbon-baru').value.replace(/\./g, '')) || 0;
    }

    // Rumus THP: (Gaji + Bonus + PinjamanBaru) - (CicilanLama + PotonganLain)
    const total = (gaji + bonus + kasbonBaru) - (cicilan + potLain);
    
    document.getElementById('ver-total').innerText = rupiah(total);
}

function simpanVerifikasiKaryawan() {
    const index = document.getElementById('ver-index').value;
    
    // 1. AMBIL GAJI DARI INPUT (Karena sekarang bisa diedit manual untuk Pro-rata)
    const gajiBaru = Number(document.getElementById('ver-gaji').value.replace(/\./g, '')) || 0;

    // 2. Ambil Data Lainnya
    const bonus = Number(document.getElementById('ver-bonus').value.replace(/\./g, '')) || 0;
    const cicilan = Number(document.getElementById('ver-potongan-kasbon').value.replace(/\./g, '')) || 0;
    const potLain = Number(document.getElementById('ver-potongan-lain').value.replace(/\./g, '')) || 0;
    
    let kasbonBaru = 0;
    let ketKasbon = '';
    if(document.getElementById('check-kasbon-baru').checked) {
        kasbonBaru = Number(document.getElementById('ver-kasbon-baru').value.replace(/\./g, '')) || 0;
        ketKasbon = document.getElementById('ver-kasbon-ket').value;
    }

    // 3. Update Object Session dengan GAJI BARU
    sessionPayrollData[index].gaji = gajiBaru; // <--- INI KUNCINYA
    sessionPayrollData[index].bonus = bonus;
    sessionPayrollData[index].kasbonPotongan = cicilan;
    sessionPayrollData[index].potonganLain = potLain;
    sessionPayrollData[index].kasbonBaru = kasbonBaru;
    sessionPayrollData[index].ketKasbonBaru = ketKasbon;
    
    // 4. Hitung Total Final (Gaji Baru + Bonus ...)
    sessionPayrollData[index].total = (gajiBaru + bonus + kasbonBaru) - (cicilan + potLain);
    
    // Set Status
    sessionPayrollData[index].statusVerifikasi = 'Sesuai';

    // Tutup Modal & Refresh Tabel
    bootstrap.Modal.getInstance(document.getElementById('modalDetailGaji')).hide();
    renderTabelPayroll();
}

// [UPDATE RAPI] 1. Fungsi Buka Modal Pilih Akun
function prosesCairkanSemua(periode) {
    // A. Ambil Data Siap Cair
    const dataFinal = sessionPayrollData.filter(p => p.statusVerifikasi === 'Sesuai');
    
    if(dataFinal.length === 0) return myAlert('Tidak Ada Data', 'Belum ada data gaji yang statusnya SESUAI.', 'warning');

    // B. Hitung Total
    let totalCair = dataFinal.reduce((acc, curr) => acc + curr.total, 0);

    // C. Isi UI Modal
    document.getElementById('cair-gaji-periode').value = periode;
    document.getElementById('cair-gaji-periode-lbl').innerText = `Periode Gaji: ${periode}`;
    document.getElementById('cair-gaji-count').innerText = `${dataFinal.length} Org`;
    
    // Format Rupiah
    const totalStr = rupiah(totalCair);
    document.getElementById('cair-gaji-total-sm').innerText = totalStr;
    document.getElementById('cair-gaji-total-big').innerText = totalStr;

    // Reset Tombol & Info
    const btn = document.getElementById('btn-submit-cair');
    btn.disabled = false;
    btn.innerHTML = 'BAYAR SEKARANG <i class="material-icons align-middle ms-1" style="font-size:16px">arrow_forward</i>';
    document.getElementById('info-saldo-akun').innerHTML = '<small class="text-muted">Silakan pilih akun pembayaran</small>';

    // D. Load Akun ke Dropdown
    const selAkun = document.getElementById('cair-gaji-akun');
    selAkun.innerHTML = '<option value="">Memuat...</option>';
    
    google.script.run.withSuccessHandler(akunList => {
        selAkun.innerHTML = '<option value="">-- Pilih Akun --</option>';
        
        akunList.forEach(a => {
            // Simpan saldo di atribut data agar mudah diambil
            selAkun.innerHTML += `<option value="${a.nama}" data-saldo="${a.saldo}">${a.nama}</option>`;
        });

        // Event Listener: Saat akun dipilih, tampilkan sisa saldo di bawahnya
        selAkun.onchange = function() {
            const opt = this.options[this.selectedIndex];
            const saldo = Number(opt.getAttribute('data-saldo')) || 0;
            const sisa = saldo - totalCair;
            
            let colorClass = sisa >= 0 ? 'text-success' : 'text-danger';
            let icon = sisa >= 0 ? 'check_circle' : 'warning';
            let msg = sisa >= 0 ? 'Saldo mencukupi' : 'Saldo tidak cukup!';

            document.getElementById('info-saldo-akun').innerHTML = `
                <small class="text-muted me-2">Saldo saat ini: <b>${rupiah(saldo)}</b></small>
                <br>
                <small class="${colorClass} fw-bold"><i class="material-icons align-middle" style="font-size:12px">${icon}</i> Estimasi Sisa: ${rupiah(sisa)}</small>
            `;
        };

    }).getDaftarAkun();

    // E. Tampilkan Modal
    new bootstrap.Modal(document.getElementById('modalCairkanGaji')).show();
}

// [UPDATE RAPI] 2. Fungsi Eksekusi Final
function submitCairkanGaji() {
    const periode = document.getElementById('cair-gaji-periode').value;
    const akunBayar = document.getElementById('cair-gaji-akun').value;
    
    if(!akunBayar) return myAlert('Pilih Akun', 'Harap pilih sumber dana pembayaran.', 'warning');

    // Ambil Data
    const dataFinal = sessionPayrollData.filter(p => p.statusVerifikasi === 'Sesuai');
    
    // UI Loading State (Biar terlihat proses)
    const btn = document.getElementById('btn-submit-cair');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Memproses...';

    // Eksekusi Backend
    google.script.run
      .withSuccessHandler(res => {
        // Tutup Modal
        const modalEl = document.getElementById('modalCairkanGaji');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        modalInstance.hide();

        // Tampilkan Sukses
        myAlert('Berhasil', res, 'success');
        
        // Refresh Halaman
        cekDataGaji(); 
        if(typeof loadDashboard === 'function') loadDashboard();
        if(typeof loadKeuangan === 'function') loadKeuangan();
        if(typeof loadKasbon === 'function') loadKasbon();

      })
      .withFailureHandler(err => {
        // Jika Gagal, kembalikan tombol
        btn.disabled = false;
        btn.innerHTML = originalText;
        myAlert('Gagal', err.message, 'error');
      })
      .simpanGajiBulanan(periode, dataFinal, akunBayar);
}

// [UPDATE FIX] Proses Simpan Gaji (Membersihkan Titik Ribuan)
function prosesSimpanGaji(periode) {
    let finalData = [];
    
    // Loop data preview untuk mengambil nilai input terbaru
    dataGajiPreview.forEach((p, index) => {
        const row = document.getElementById(`row-gaji-${index}`);
        
        // AMBIL NILAI INPUT & BUANG TITIKNYA
        // Contoh: "500.000" -> replace titik -> "500000" -> Number -> 500000
        const bonusStr = row.querySelector('.input-bonus-gaji').value.replace(/\./g, '');
        const potonganStr = row.querySelector('.input-potongan-gaji').value.replace(/\./g, '');

        const bonusVal = Number(bonusStr) || 0;
        const potonganVal = Number(potonganStr) || 0;
        
        // Hitung ulang total di sini untuk memastikan akurasi
        const totalFix = p.gaji + bonusVal - potonganVal;

        finalData.push({
            nama: p.nama,
            gaji: p.gaji,
            bonus: bonusVal,          
            potonganManual: potonganVal, 
            total: totalFix
        });
    });

    myConfirm('Konfirmasi Payroll', `Simpan dan cairkan gaji untuk periode ${periode}?`, () => {
        loading(true);
        google.script.run.withSuccessHandler(res => {
            loading(false);
            
            // Tampilkan Pesan Sukses
            myAlert('Sukses', res, 'success');
            
            // REFRESH SEMUA HALAMAN PENTING
            // Beri jeda sedikit agar server selesai menulis data
            setTimeout(() => {
                cekDataGaji();    // Refresh Tabel Gaji
                loadKasbon();     // Refresh Tabel Kasbon
                loadKeuangan();   // Refresh Keuangan
                loadDashboard();  // Refresh Dashboard
            }, 1000);

        }).simpanGajiBulanan(periode, finalData); 
    });
}

// [UPDATE] Hitung Cicilan Realtime (Support Ribuan)
function hitungCicilan() {
    // Ambil value input, buang titik
    const rawNominal = document.getElementById('kasbon-nominal').value.replace(/\./g, '');
    const nominal = Number(rawNominal) || 0;
    
    const tenor = Number(document.getElementById('kasbon-tenor').value) || 1;
    let finalTenor = tenor < 1 ? 1 : tenor;
    
    let angsuran = Math.ceil(nominal / finalTenor);
    document.getElementById('kasbon-estimasi').value = rupiah(angsuran);
}

function simpanKasbon() {
    const nama = document.getElementById('kasbon-nama').value;
    const rawNominal = document.getElementById('kasbon-nominal').value;
    const nominal = Number(rawNominal.replace(/\./g, '')); // Hapus titik format rupiah
    const tenor = document.getElementById('kasbon-tenor').value;
    const ket = document.getElementById('kasbon-ket').value;
    
    // [BARU] Ambil nilai akun
    const akun = document.getElementById('kasbon-akun').value;

    // Validasi
    if (!nama) return myAlert('Error', 'Pilih karyawan dulu', 'warning');
    if (!nominal || nominal <= 0) return myAlert('Error', 'Nominal harus diisi', 'warning');
    if (!akun) return myAlert('Penting', 'Harap pilih Akun Saldo untuk pencairan dana kasbon ini!', 'warning');

    const payload = {
        nama: nama,
        nominal: nominal,
        tenor: tenor,
        ket: ket,
        akun: akun // Kirim akun ke backend
    };

    myConfirm('Simpan Kasbon', `Beri kasbon Rp ${rawNominal} ke ${nama}?\nSaldo ${akun} akan berkurang.`, () => {
        loading(true);
        google.script.run.withSuccessHandler(res => {
            loading(false);
            myAlert('Sukses', res, 'success');
            
            // Reset Form
            document.getElementById('kasbon-nominal').value = '';
            document.getElementById('kasbon-ket').value = '';
            document.getElementById('kasbon-akun').value = ''; // Reset akun
            
            loadKasbon(); // Refresh tabel history
            loadDashboard(); // Refresh saldo dashboard realtime
            loadKeuangan(); 
        }).simpanKasbon(payload);
    });
}

  function loadHitungGaji() {
    document.querySelector('#tabel-hitung-gaji tbody').innerHTML='Loading...';
    google.script.run.withSuccessHandler(d => {
      payrollDataTemp = d; const tb = document.querySelector('#tabel-hitung-gaji tbody'); tb.innerHTML='';
      d.forEach(p => tb.innerHTML+=`<tr><td>${p.nama}</td><td>${rupiah(p.gaji)}</td><td>${rupiah(p.bonus)}</td><td class="text-danger">${rupiah(p.kasbon)}</td><td class="fw-bold">${rupiah(p.total)}</td></tr>`);
    }).getDataPayroll();
  }
  function cairkanGaji() {
    if(confirm('Cairkan Gaji? Kasbon akan dianggap Lunas.')) google.script.run.withSuccessHandler(alert).prosesPayrollFinal(payrollDataTemp);
  }

  // --- HELPER: SET TANGGAL OTOMATIS (1 sd Hari Ini) ---
function setAutoDate(tipe) {
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1); // Tanggal 1 Bulan Ini

    // Fungsi Format ke YYYY-MM-DD (Waktu Lokal Indonesia)
    const toStr = (d) => {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    // Set ke Input HTML
    const elStart = document.getElementById(`filter-${tipe}-start`);
    const elEnd = document.getElementById(`filter-${tipe}-end`);

    if(elStart) elStart.value = toStr(firstDay);
    if(elEnd) elEnd.value = toStr(now);
}

// Listener untuk Metode Bayar
document.getElementById('pos-metode-bayar')?.addEventListener('change', function() {
    const val = this.value;
    const box = document.getElementById('box-jatuh-tempo');
    
    if(val === 'Hutang') {
        box.classList.remove('d-none'); // Munculkan tanggal
        // Set default jatuh tempo: 7 hari dari sekarang
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        document.getElementById('pos-jatuh-tempo').value = nextWeek.toISOString().split('T')[0];
    } else {
        box.classList.add('d-none'); // Sembunyikan
    }
});

// --- 1. FUNGSI LOAD PIUTANG (FIX BUG STATUS) ---
function loadPiutang() {
   loading(true);
   google.script.run
     .withFailureHandler(err => {
         loading(false);
         myAlert('Error', err.message, 'error');
     })
     .withSuccessHandler(data => {
        loading(false);
        const tb = document.querySelector('#tabel-piutang tbody');
        tb.innerHTML = '';
        
        if(!data || data.length === 0) {
           tb.innerHTML = '<tr><td colspan="4" class="text-center text-muted p-4">Tidak ada data piutang.</td></tr>';
           return;
        }

        data.forEach(row => {
           // row: [0:ID, 1:WaktuStr, 2:Pelanggan, 3:Total, 4:JatuhTempoStr, 5:Status]
           
           const idTrx = row[0];
           const namaPel = row[2];
           const total = row[3];
           const status = row[5] ? row[5].toString().trim() : ''; 
           
           // [PERBAIKAN DISINI] Cek Persis kata 'Lunas' (Case insensitive)
           const isLunas = status.toLowerCase() === 'lunas'; 

           // Format Tanggal Jatuh Tempo
           let tglTempo = '-';
           let isLate = false;

           if(row[4] && row[4].length > 5) {
               let d = new Date(row[4]);
               tglTempo = d.toLocaleDateString('id-ID'); 
               // Telat jika Belum Lunas DAN Tanggal Lewat
               if(!isLunas && d < new Date()) isLate = true;
           }

           let tglTrx = row[1] ? new Date(row[1]).toLocaleDateString('id-ID') : '-';
           
           // Styling Tanggal
           let tempoDisplay = '';
           if(isLunas) {
               tempoDisplay = `<span class="text-success fw-bold"><i class="material-icons align-middle" style="font-size:14px">check_circle</i> Selesai</span>`;
           } else {
               let badgeLate = isLate ? '<span class="badge bg-danger ms-1" style="font-size:9px">Telat</span>' : '';
               let textClass = isLate ? 'text-danger fw-bold' : 'text-dark';
               tempoDisplay = `<div class="${textClass}">${tglTempo} ${badgeLate}</div>`;
           }

           // --- LOGIKA TOMBOL AKSI & CETAK ---
           let buttonsHtml = '';
           
           if (isLunas) {
               // KONDISI LUNAS: Badge + Cetak Bukti Lunas
               buttonsHtml = `
                   <span class="badge bg-light text-secondary border border-secondary px-2 py-1 me-1">SUDAH LUNAS</span>
                   <button class="btn btn-secondary btn-sm rounded-pill px-3 py-1 fw-bold shadow-sm" onclick="cetakSlipPiutang('${idTrx}', '${namaPel}', ${total}, '${tglTempo}', 'LUNAS')" style="font-size:11px">
                      <i class="material-icons align-middle" style="font-size:12px">print</i> BUKTI LUNAS
                   </button>
               `;
           } else {
               // KONDISI HUTANG: Tombol Lunasi + Cetak Tagihan
               buttonsHtml = `
                   <button class="btn btn-success btn-sm rounded-pill px-2 py-1 fw-bold shadow-sm me-1" onclick="prosesPelunasan('${idTrx}', '${namaPel}', ${total})" style="font-size:11px">
                      LUNASI
                   </button>
                   <button class="btn btn-info text-white btn-sm rounded-pill px-2 py-1 fw-bold shadow-sm" onclick="cetakSlipPiutang('${idTrx}', '${namaPel}', ${total}, '${tglTempo}', 'TAGIHAN')" style="font-size:11px">
                      <i class="material-icons align-middle" style="font-size:12px">print</i> TAGIHAN
                   </button>
               `;
           }

           // --- WARNA BACKGROUND BARIS ---
           let bgRow = isLunas ? 'style="background-color: #f8f9fa;"' : '';
           let opacity = isLunas ? 'style="opacity: 0.8;"' : '';

           tb.innerHTML += `
             <tr ${bgRow}>
                <td>
                   ${tempoDisplay}
                   <small class="text-muted d-block" style="font-size:11px">Trx: ${tglTrx}</small>
                </td>
                <td ${opacity}>
                   <span class="fw-bold text-dark">${namaPel}</span><br>
                   <small class="text-muted text-truncate d-block" style="max-width:150px; font-size:10px">${idTrx}</small>
                </td>
                <td class="fw-bold ${isLunas ? 'text-decoration-line-through text-muted' : 'text-danger'}" ${opacity}>
                    ${rupiah(total)}
                </td>
                <td class="text-center" style="white-space: nowrap;">
                   ${buttonsHtml}
                </td>
             </tr>
           `;
        });
     }).getDataPiutang(); 
}
function prosesPelunasan(id, nama, total) {
    myConfirm('Pelunasan Hutang', `Terima pembayaran sebesar ${rupiah(total)} dari ${nama}?\n\nData akan dicatat ke KEUANGAN (Pemasukan) dan status transaksi menjadi LUNAS.`, () => {
        loading(true);
        google.script.run.withSuccessHandler(res => {
            loading(false);
            myAlert('Berhasil', res, 'success');
            loadPiutang();      // Refresh tabel piutang
            loadDashboard();    // Update uang di dashboard
            loadNotifHutang();  // Update lonceng notifikasi
        }).lunasiHutang(id, total, nama);
    });
}

function filterTabelPiutang() {
   // Ambil apa yang diketik user
   const keyword = document.getElementById('cari-piutang').value.toLowerCase();
   
   // Ambil semua baris di tabel piutang
   const rows = document.querySelectorAll('#tabel-piutang tbody tr');
   
   rows.forEach(tr => {
      // Ambil teks di dalam baris tersebut
      const text = tr.innerText.toLowerCase();
      
      // Jika teks cocok dengan pencarian, tampilkan. Jika tidak, sembunyikan.
      if (text.includes(keyword)) {
         tr.style.display = '';
      } else {
         tr.style.display = 'none';
      }
   });
}

function tampilkanInvoice(dataPayload, idTrx) {
    const tglSekarang = new Date().toLocaleString('id-ID');
    const areaCetak = document.getElementById('area-cetak');
    
    // --- 1. AMBIL DISKON (JIKA ADA) ---
    // Pastikan membaca diskon yang dikirim dari form bayar
    let nilaiDiskon = Number(dataPayload.diskon) || 0;

    // --- LOGIKA JATUH TEMPO (Biarin Sama) ---
    let infoMetode = `Metode Bayar: ${dataPayload.metode}`;
    if(dataPayload.metode === 'Hutang' && dataPayload.jatuhTempo) {
        // ... (kode lama jatuh tempo biarkan sama) ...
        const dateObj = new Date(dataPayload.jatuhTempo);
        const tglIndo = dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        infoMetode = `Metode: <b>HUTANG</b><br>Jatuh Tempo: ${tglIndo}`;
    }

    // --- 2. GENERATE BARIS BARANG ---
    let rowsInvoice = '';
    let rowsSuratJalan = '';
    let subTotal = 0; // Ganti nama variabel jadi SubTotal biar jelas

    dataPayload.items.forEach(item => {
        subTotal += item.total; // Jumlahkan total harga barang
        
        rowsInvoice += `
            <tr>
                <td class="text-start">${item.produkNama}<br><small class="text-muted fst-italic">${item.tipe}</small></td>
                <td>${rupiah(item.hargaSatuan)}</td>
                <td>${item.qty}</td>
                <td class="text-end fw-bold">${rupiah(item.total)}</td>
            </tr>`;
            
        rowsSuratJalan += `
            <tr>
                <td class="text-start">${item.produkNama}<br><small class="text-muted fst-italic">${item.tipe}</small></td>
                <td class="fw-bold fs-5">${item.qty}</td>
                <td class="text-center" style="width: 50px; border: 1px solid #000;"></td> 
            </tr>`;
    });

    // --- 3. HITUNG GRAND TOTAL AKHIR ---
    let grandTotal = subTotal - nilaiDiskon;

    // --- SETUP HEADER (Biarkan Sama) ---
    const namaPT = globalCompanyProfile.nama_perusahaan || 'NAMA PERUSAHAAN';
    const alamatPT = globalCompanyProfile.alamat || '-';
    const noPT = globalCompanyProfile.no_perusahaan || '-';
    let htmlLogo = '';
    if(globalCompanyProfile.logo_perusahaan) {
        htmlLogo = `<img src="${globalCompanyProfile.logo_perusahaan}" style="height: 50px; width: auto; margin-right: 15px;">`;
    }

    const headerPT = `
        <div class="d-flex justify-content-between border-bottom border-2 border-dark pb-2 mb-2">
            <div class="d-flex align-items-center">
                ${htmlLogo} 
                <div>
                    <h4 class="fw-bold text-danger m-0 text-uppercase" style="font-size:16pt;">${namaPT}</h4>
                    <small class="text-muted fw-bold" style="font-size:9pt">Telp: ${noPT}</small><br>
                    <small class="text-muted" style="font-size:8pt; display:block; max-width:300px; line-height:1.2;">${alamatPT}</small>
                </div>
            </div>
            <div class="text-end">
                <h4 class="fw-bold text-dark" id="judul-dokumen">INVOICE</h4>
                <div style="font-size:9pt">${tglSekarang}</div>
                <div class="text-danger fw-bold" style="font-size:10pt">${idTrx}</div>
            </div>
        </div>`;

    // --- 4. RENDER HTML INVOICE (UPDATE BAGIAN TFOOT) ---
    const htmlInvoice = `
      <div class="h-100">
         ${headerPT}
         <div class="row mb-2" style="font-size:10pt">
             <div class="col-6">
                 <small class="text-muted fw-bold">KEPADA YTH:</small><br>
                 <strong class="text-dark fs-6">${dataPayload.pelanggan}</strong><br>
                 <small>${infoMetode}</small>
             </div>
             <div class="col-6 text-end">
                 <small class="text-muted fw-bold">KASIR:</small><br>
                 <strong>${dataPayload.kasir}</strong>
             </div>
         </div>

         <table class="table table-bordered border-dark mb-0 table-sm" style="border-color: #000 !important; font-size:10pt;">
             <thead class="bg-light text-center">
                 <tr><th>Nama Barang</th><th>Harga</th><th>Qty</th><th>Total</th></tr>
             </thead>
             <tbody class="text-center">${rowsInvoice}</tbody>
             
             <tfoot class="fw-bold">
                 <tr>
                    <td colspan="3" class="text-end pe-2">Subtotal</td>
                    <td class="text-end">${rupiah(subTotal)}</td>
                 </tr>
                 
                 ${nilaiDiskon > 0 ? `
                 <tr>
                    <td colspan="3" class="text-end pe-2 text-danger">Potongan / Diskon</td>
                    <td class="text-end text-danger">-${rupiah(nilaiDiskon)}</td>
                 </tr>` : ''}

                 <tr>
                    <td colspan="3" class="text-end pe-2 fs-6">GRAND TOTAL</td>
                    <td class="text-end bg-light fs-6">${rupiah(grandTotal)}</td>
                 </tr>
             </tfoot>
         </table>
         
         <div class="row mt-4 align-items-end" style="page-break-inside: avoid;">
            <div class="col-4">
                <small class="fst-italic text-muted" style="font-size:8pt">
                   * Pembayaran sah jika disertai tanda tangan/stempel.<br>
                   * Komplain maksimal 1x24 jam.
                </small>
            </div>
            <div class="col-4 text-center">
                <small>Tanda Terima,</small>
                <br><br><br>
                <small class="fw-bold text-uppercase">( ${dataPayload.pelanggan} )</small>
            </div>
            <div class="col-4 text-center">
                <small>Hormat Kami,</small>
                <br><br><br>
                <small class="fw-bold text-uppercase">( ${dataPayload.kasir} )</small>
            </div>
         </div>
      </div>
    `;

    // --- 5. HALAMAN SURAT JALAN (Biarkan Sama) ---
    // (Copy paste kode surat jalan lama Anda di sini, atau biarkan tidak diubah)
    // --- 5. HALAMAN SURAT JALAN (DIPERBARUI) ---
    const headerSJ = headerPT.replace('INVOICE', 'SURAT JALAN'); 
    
    // HTML Tambahan untuk Info Kendaraan
    const infoLogistik = `
        <div class="row mb-2 border border-dark p-2 mx-1" style="font-size:9pt; background-color:#f8f9fa;">
            <div class="col-6">
                <table style="width:100%;">
                    <tr><td width="90"><strong>NOPOL MOBIL</strong></td><td>: ......................................</td></tr>
                    <tr><td><strong>NAMA SUPIR</strong></td><td>: ......................................</td></tr>
                    <tr><td><strong>NAMA KENEK</strong></td><td>: ......................................</td></tr>
                </table>
            </div>
            <div class="col-6">
                <table style="width:100%;">
                    <tr><td width="100"><strong>JAM MASUK</strong></td><td>: ........... : ........... WIB</td></tr>
                    <tr><td><strong>JAM KELUAR</strong></td><td>: ........... : ........... WIB</td></tr>
                    <tr><td><strong>PARAF SECURITY</strong></td><td>: ......................................</td></tr>
                </table>
            </div>
        </div>
    `;

    const htmlSuratJalan = `
      <div class="h-100">
         ${headerSJ}
         
         <div class="alert alert-secondary p-1 mb-2 text-center fw-bold" style="font-size:10pt; border:1px solid #999;">
             DOKUMEN GUDANG / PENGIRIMAN
         </div>

         <div class="row mb-2" style="font-size:10pt">
             <div class="col-6">
                 <small class="text-muted fw-bold">TUJUAN PENGIRIMAN:</small><br>
                 <strong class="text-dark fs-6">${dataPayload.pelanggan}</strong>
             </div>
             <div class="col-6 text-end">
                 <small class="text-muted fw-bold">NO. TRANSAKSI:</small><br>
                 <strong>${idTrx}</strong>
             </div>
         </div>

         ${infoLogistik}
         
         <table class="table table-bordered border-dark mb-0 table-sm" style="border-color: #000 !important; font-size:10pt;">
             <thead class="bg-light text-center">
                 <tr><th>Nama Barang / Deskripsi</th><th>Qty</th><th>Cek Fisik</th></tr>
             </thead>
             <tbody class="text-center align-middle">${rowsSuratJalan}</tbody>
         </table>

         <div class="row mt-4 text-center" style="page-break-inside: avoid;">
            <div class="col-4"><small>Penerima,</small><br><br><br><br><small>( ....................... )</small></div>
            <div class="col-4"><small>Supir / Kurir,</small><br><br><br><br><small>( ....................... )</small></div>
            <div class="col-4"><small>Kepala Gudang,</small><br><br><br><br><small>( ....................... )</small></div>
         </div>
      </div>
    `;

    areaCetak.innerHTML = htmlInvoice + '<div class="page-break"></div>' + htmlSuratJalan;
    new bootstrap.Modal(document.getElementById('modalInvoice')).show();
}

function tutupInvoice() {
    // Saat invoice ditutup, baru reset keranjang
    resetKeranjang(); 
}

// --- UPDATE FUNGSI FILTER CEPAT ---
function setFilterCepat(pilihan, tipe) {
    
    // 1. Setup Awal (Default: Hari Ini)
    const now = new Date();
    let start = new Date(); 
    let end = new Date();   

    // Helper format YYYY-MM-DD
    const fmt = (d) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    };

    // 2. Logika Pilihan Waktu
    if (pilihan === "" || pilihan === "bulan_ini") {
        start = new Date(now.getFullYear(), now.getMonth(), 1); // Tgl 1 Bulan Ini
        end = now; // Hari Ini
    } else {
        switch(pilihan) {
            case 'hari_ini':
                // Tidak perlu diubah, start & end sudah default 'now'
                break; 
            
            case 'kemarin':
                start.setDate(now.getDate() - 1);
                end.setDate(now.getDate() - 1);
                break;
            
            case '7_hari':
                start.setDate(now.getDate() - 6); 
                break;
                
            case 'bulan_lalu':
                start = new Date(now.getFullYear(), now.getMonth() - 1, 1); 
                end = new Date(now.getFullYear(), now.getMonth(), 0); 
                break;
        }
    }

    // 3. Tentukan ID Input berdasarkan Tipe (JUAL / BELI / KEUANGAN)
    let idStart, idEnd;

    if (tipe === 'JUAL') {
        idStart = 'filter-jual-start'; 
        idEnd = 'filter-jual-end';
    } else if (tipe === 'BELI') {
        idStart = 'filter-beli-start'; 
        idEnd = 'filter-beli-end';
    } else if (tipe === 'KEUANGAN') { // <--- INI BAGIAN PENTING YANG KURANG
        idStart = 'filter-keu-start'; 
        idEnd = 'filter-keu-end';
    } else {
        return; // Jika tipe tidak dikenali, berhenti
    }

    // 4. Eksekusi Update ke Input
    const elStart = document.getElementById(idStart);
    const elEnd = document.getElementById(idEnd);

    // Update Start Date
    if (elStart) {
        if (elStart._flatpickr) elStart._flatpickr.setDate(fmt(start), true);
        else elStart.value = fmt(start);
    }

    // Update End Date
    if (elEnd) {
        if (elEnd._flatpickr) elEnd._flatpickr.setDate(fmt(end), true);
        else elEnd.value = fmt(end);
    }

    // 5. Jalankan Filter Tabel Otomatis
    if(tipe === 'JUAL') terapkanFilter('JUAL');
    else if(tipe === 'BELI') terapkanFilter('BELI');
    else if(tipe === 'KEUANGAN') terapkanFilterKeuangan(); // <--- Refresh Tabel Keuangan
}

// 2. Export ke Excel (Format .xls HTML Table)
function exportKeExcel(tableId, filename = 'Laporan') {
    const table = document.getElementById(tableId);
    let html = table.outerHTML;

    // Bersihkan kolom 'Aksi' (Tombol) agar tidak ikut ke Excel
    // Kita buat elemen sementara untuk manipulasi
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    
    // Hapus kolom terakhir (Aksi) di header dan body
    const rows = tempDiv.querySelectorAll('tr');
    rows.forEach(row => {
        if(row.children.length > 0) {
            row.removeChild(row.lastElementChild); // Hapus kolom terakhir (Aksi)
        }
    });

    // Tambahkan CSS sederhana agar Excel rapi
    const style = `
      <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
      </style>
    `;

    // Buat Blob
    const finalHtml = style + tempDiv.innerHTML;
    const blob = new Blob([finalHtml], { type: 'application/vnd.ms-excel' });
    const url = URL.createObjectURL(blob);
    
    // Trigger Download
    const a = document.createElement('a');
    a.href = url;
    a.download = filename + '_' + new Date().toLocaleDateString('id-ID').replace(/\//g,'-') + '.xls';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// --- FUNGSI CETAK SLIP PIUTANG (REVISI TENGAH & RAPI) ---
function cetakSlipPiutang(idTrx, pelanggan, total, jatuhTempo, mode) {
    
    // 1. Ambil Data Perusahaan
    const namaPT = globalCompanyProfile.nama_perusahaan || 'NAMA PERUSAHAAN';
    const alamatPT = globalCompanyProfile.alamat || '-';
    const noPT = globalCompanyProfile.no_perusahaan || '-';
    const logoUrl = globalCompanyProfile.logo_perusahaan || '';
    
    let htmlLogo = '';
    if (logoUrl) {
        htmlLogo = `<img src="${logoUrl}" style="height: 100px; width: auto; margin-right: 15px;">`;
    }

    const tglCetak = new Date().toLocaleString('id-ID');

    // 2. Konten Dinamis
    let judulDokumen = '';
    let warnaHeader = '';
    let pesanBody = '';
    let labelTotal = '';
    
    if (mode === 'LUNAS') {
        judulDokumen = 'TANDA TERIMA PELUNASAN';
        warnaHeader = '#198754'; // Hijau
        labelTotal = 'TOTAL DIBAYARKAN';
        pesanBody = `
            <div style="background-color: #d1e7dd; padding: 15px; border-left: 5px solid #198754; margin-bottom: 20px; color: #0f5132;">
                <strong>TERIMA KASIH.</strong><br>
                Pembayaran untuk transaksi ini telah kami terima dengan lunas.<br>
                Bukti ini adalah tanda terima yang sah.
            </div>`;
    } else {
        judulDokumen = 'INVOICE / SURAT TAGIHAN';
        warnaHeader = '#dc3545'; // Merah
        labelTotal = 'SISA TAGIHAN';
        pesanBody = `
            <div style="background-color: #f8d7da; padding: 15px; border-left: 5px solid #dc3545; margin-bottom: 20px; color: #842029;">
                <strong>MOHON SEGERA DIBAYAR.</strong><br>
                Kami informasikan bahwa tagihan ini telah/akan jatuh tempo pada tanggal <b>${jatuhTempo}</b>.<br>
                Mohon segera melakukan pembayaran.
            </div>`;
    }

    // 1. Nama File
    const fileName = `Slip_${mode}_${pelanggan.replace(/\s+/g,'_')}_${idTrx}`;

    // 2. CSS (Disesuaikan agar kompatibel dengan Google PDF Engine)
    // Google PDF engine lebih suka CSS inline sederhana, hindari Flexbox kompleks jika layout berantakan
    const cssStyle = `
        <style>
            body { font-family: sans-serif; padding: 20px; color: #333; }
            .header { text-align: center; border-bottom: 3px double #333; padding-bottom: 20px; margin-bottom: 30px; }
            .judul-besar { font-size: 20px; font-weight: bold; color: ${warnaHeader}; text-transform: uppercase; margin-bottom: 5px; border: 2px solid ${warnaHeader}; display:inline-block; padding: 8px 30px; border-radius: 8px; }
            .box-info { width: 100%; margin-bottom: 30px; border-bottom: 1px dashed #ccc; padding-bottom: 20px; overflow: hidden; }
            .left { float: left; width: 48%; }
            .right { float: right; width: 48%; text-align: right; }
            .tabel-detail { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
            .tabel-detail th { background: #f2f2f2; text-align: left; padding: 10px; border-bottom: 2px solid #ddd; }
            .tabel-detail td { padding: 10px; border-bottom: 1px solid #eee; }
            .total-box { text-align: right; font-size: 18px; font-weight: bold; margin-top: 20px; }
            .ttd-area { margin-top: 50px; width: 100%; overflow: hidden; text-align: center; }
            .ttd-left { float: left; width: 40%; }
            .ttd-right { float: right; width: 40%; }
        </style>
    `;

    // 3. HTML Content (Sama seperti sebelumnya, tapi dibungkus variabel fullHtml)
    // Tips: Gunakan 'float' daripada 'flex' untuk kompatibilitas PDF Converter Google yang lebih baik
    const fullHtml = `
    <html>
    <head>${cssStyle}</head>
    <body>
        <div class="header">
            ${htmlLogo}
            <h2 style="margin:0; font-size:24px; color:#d32f2f; text-transform: uppercase;">${namaPT}</h2>
            <div style="font-size:11px;">${alamatPT} | Telp: ${noPT}</div>
        </div>

        <div style="text-align:center; margin-bottom:30px;">
            <div class="judul-besar">${judulDokumen}</div>
            <div style="margin-top:5px; color:#555; font-size:12px;">Dicetak pada: ${tglCetak}</div>
        </div>

        <div class="box-info">
            <div class="left">
                <small style="color:#777; font-weight:bold;">KEPADA YTH:</small><br>
                <span style="font-size:18px; font-weight:bold; color:#000;">${pelanggan}</span>
            </div>
            <div class="right">
                <small style="color:#777; font-weight:bold;">NO. REFERENSI:</small><br>
                <span style="font-size:16px; font-weight:bold;">${idTrx}</span>
            </div>
        </div>

        ${pesanBody}

        <table class="tabel-detail">
            <thead><tr><th>Keterangan Transaksi</th><th style="text-align:right;">Nominal Tagihan</th></tr></thead>
            <tbody>
                <tr>
                    <td>Tagihan Pembelian Barang (ID: <b>${idTrx}</b>)</td>
                    <td style="text-align:right;">${rupiah(total)}</td>
                </tr>
            </tbody>
        </table>

        <div class="total-box">
            ${labelTotal}: <span style="font-size:26px; color:${warnaHeader}; margin-left:10px;">${rupiah(total)}</span>
        </div>

        <div class="ttd-area">
            <div class="ttd-left">
                <small>Penerima,</small><br><br><br><br>
                <div style="border-bottom: 1px solid #000; font-weight:bold;">(${pelanggan})</div>
            </div>
            <div class="ttd-right">
                <small>Hormat Kami,</small><br><br><br><br>
                <div style="border-bottom: 1px solid #000; font-weight:bold;">( Admin Keuangan )</div>
            </div>
        </div>
        
        <div style="margin-top: 30px; font-size: 9px; color: #777; font-style: italic; text-align: center;">
            Dokumen ini dicetak secara otomatis oleh sistem SiGAS PRO.
        </div>
    </body>
    </html>
    `;

    // 4. Kirim ke Server
    loading(true);
    google.script.run
        .withSuccessHandler(function(base64) {
            loading(false);
            downloadPdfFromBase64(base64, fileName);
        })
        .withFailureHandler(function(e) {
            loading(false);
            myAlert('Gagal', e.message, 'error');
        })
        .generatePdfFromHtml(fullHtml, fileName);
}

// --- FUNGSI CETAK INVOICE RETUR ---
function cetakInvoiceRetur(payload, totalRefund) {
    const areaCetak = document.getElementById('area-cetak');
    const tglSekarang = new Date().toLocaleString('id-ID');
    const namaPelanggan = currentReturData ? currentReturData.pelanggan : 'Pelanggan';
    
    // Header
    const namaPT = globalCompanyProfile.nama_perusahaan || 'NAMA PERUSAHAAN';
    const noPT = globalCompanyProfile.no_perusahaan || '-';
    let htmlLogo = '';
    if(globalCompanyProfile.logo_perusahaan) {
        htmlLogo = `<img src="${globalCompanyProfile.logo_perusahaan}" style="height: 50px; width: auto; margin-right: 15px;">`;
    }

    // List Barang Retur
// List Barang Retur
    let rowsBarang = '';
    payload.items.forEach(item => {
        if(item.qtyRetur > 0) {
            
            // --- [PERBAIKAN] HITUNG HARGA SATUAN OTOMATIS ---
            let hargaSatuan = item.hargaSatuan;
            
            // Jika hargaSatuan tidak ada (dari riwayat), hitung manual: Total / Qty Awal
            if (!hargaSatuan && item.qty > 0) {
                hargaSatuan = item.hargaTotal / item.qty;
            }
            // ------------------------------------------------

            rowsBarang += `
            <tr>
                <td class="text-start">${item.produk}<br><small class="text-muted fst-italic">Retur: ${item.alasan || 'Refund'}</small></td>
                <td>${rupiah(hargaSatuan)}</td>  <td>${item.qtyRetur}</td>
                <td class="text-end fw-bold">-${rupiah(hargaSatuan * item.qtyRetur)}</td> </tr>`;
        }
    });

    const html = `
    <div class="h-100" style="font-family: sans-serif; padding: 10px;">
        <div class="d-flex justify-content-between border-bottom border-2 border-danger pb-2 mb-2">
            <div class="d-flex align-items-center">
                ${htmlLogo}
                <div>
                    <h4 class="fw-bold text-danger m-0 text-uppercase" style="font-size:16pt;">${namaPT}</h4>
                    <small class="text-muted fw-bold">BUKTI RETUR / REFUND</small>
                </div>
            </div>
            <div class="text-end">
                <h4 class="fw-bold text-dark">NOTA RETUR</h4>
                <div style="font-size:9pt">${tglSekarang}</div>
                <div class="text-danger fw-bold" style="font-size:10pt">REF: ${payload.idTrx}</div>
            </div>
        </div>

        <div class="row mb-2" style="font-size:10pt">
            <div class="col-6">
                <small class="text-muted fw-bold">CUSTOMER:</small><br>
                <strong class="text-dark fs-6">${namaPelanggan}</strong>
            </div>
            <div class="col-6 text-end">
                <small class="text-muted fw-bold">KETERANGAN:</small><br>
                <strong>${payload.alasan || 'Pengembalian Barang'}</strong>
            </div>
        </div>

        <table class="table table-bordered border-dark mb-0 table-sm" style="border-color: #000 !important; font-size:10pt;">
            <thead class="bg-light text-center">
                <tr><th>Barang Retur</th><th>Harga</th><th>Qty</th><th>Refund</th></tr>
            </thead>
            <tbody class="text-center">${rowsBarang}</tbody>
            <tfoot class="fw-bold">
                <tr>
                    <td colspan="3" class="text-end pe-2">TOTAL PENGEMBALIAN DANA</td>
                    <td class="text-end bg-danger-subtle text-danger">-${rupiah(totalRefund)}</td>
                </tr>
            </tfoot>
        </table>

        <div class="row mt-4 align-items-end" style="page-break-inside: avoid;">
            <div class="col-6 text-center">
                <small>Pelanggan,</small>
                <br><br><br>
                <small class="fw-bold">( ${namaPelanggan} )</small>
            </div>
            <div class="col-6 text-center">
                <small>Petugas / Kasir,</small>
                <br><br><br>
                <small class="fw-bold">( Admin )</small>
            </div>
        </div>
        
        <div class="mt-3 text-center">
            <small class="fst-italic text-muted" style="font-size:8pt">Dokumen ini adalah bukti sah pengembalian barang & dana.</small>
        </div>
    </div>
    `;

    areaCetak.innerHTML = html;
    new bootstrap.Modal(document.getElementById('modalInvoice')).show();
}

// [UPDATE PERBAIKAN] Laporan PDF dengan Gambar Aman (Anti Crash)
// [UPDATE PERBAIKAN] Laporan PDF dengan Gambar Aman & Smart Column Removal
function printLaporanPDF(tableId, judulLaporan) {
    const table = document.getElementById(tableId);
    
    // 1. Setup Nama File
    const tglFile = new Date().toISOString().slice(0,10);
    const fileName = judulLaporan.replace(/\s+/g, '_') + '_' + tglFile;

    // 2. Ambil Data Perusahaan (Sama seperti sebelumnya)
    const namaPT = globalCompanyProfile.nama_perusahaan || 'NAMA PERUSAHAAN';
    const alamatPT = globalCompanyProfile.alamat || '-';
    const noPT = globalCompanyProfile.no_perusahaan || '-';
    
    let logoId = null;
    let htmlLogo = '';
    
    if (globalCompanyProfile.logo_perusahaan) {
        const match = globalCompanyProfile.logo_perusahaan.match(/id=([^&]+)/);
        if (match) {
            logoId = match[1];
            htmlLogo = `<img src="[[LOGO_IMAGE_PLACEHOLDER]]" style="height: 80px; width: auto; margin-right: 20px;">`;
        }
    }

    // 3. Header Laporan (Sama seperti sebelumnya)
    const headerHtml = `
        <div style="display: flex; align-items: center; justify-content: center; border-bottom: 3px double #333; padding-bottom: 15px; margin-bottom: 20px;">
            ${htmlLogo}
            <div style="text-align: center;">
                <h2 style="margin: 0; font-size: 20pt; font-weight: 800; text-transform: uppercase; color: #d32f2f; line-height: 1;">${namaPT}</h2>
                <div style="font-size: 10pt; font-weight: bold; margin-top: 5px; color: #333;">${alamatPT}</div>
                <div style="font-size: 10pt; color: #555;">Telp: ${noPT}</div>
            </div>
        </div>
        <div style="text-align: center; margin-bottom: 15px;">
            <h3 style="margin: 0; text-transform: uppercase; font-size: 14pt; font-weight:bold; text-decoration: underline;">${judulLaporan}</h3>
            <small style="color: #555; font-style: italic;">Dicetak pada: ${new Date().toLocaleString('id-ID')}</small>
        </div>
    `;

    // 4. Clone Tabel & Bersihkan Kolom Aksi (LOGIKA DIPERBAIKI DISINI)
    let tableClone = table.cloneNode(true);
    
    // Cek Header Terakhir
    const ths = tableClone.querySelectorAll('th');
    let removeLastCol = false;

    if (ths.length > 0) {
        const lastHeader = ths[ths.length - 1].innerText.trim().toLowerCase();
        // HANYA hapus jika header adalah "Aksi", "Action", atau kosong (tombol)
        if (lastHeader === 'aksi' || lastHeader === 'action' || lastHeader === '') {
            removeLastCol = true;
            ths[ths.length - 1].remove(); 
        }
    }

    // Jika Header terakhir terdeteksi sebagai tombol, baru hapus isi barisnya
    if (removeLastCol) {
        const rows = tableClone.querySelectorAll('tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if(cells.length > 0) cells[cells.length - 1].remove();
        });
    }

    // 5. CSS Style (Sama seperti sebelumnya)
    const cssStyle = `
        <style>
            body { font-family: sans-serif; padding: 20px; color: #000; }
            table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt; }
            th { background-color: #e0e0e0; color: #000; font-weight: bold; padding: 6px 4px; border: 1px solid #666; text-align: center; }
            td { padding: 4px 5px; border: 1px solid #999; vertical-align: middle; line-height: 1.2; }
            .text-end { text-align: right; }
            .text-center { text-align: center; }
        </style>
    `;

    const fullHtml = `<html><head>${cssStyle}</head><body>${headerHtml}${tableClone.outerHTML}</body></html>`;

    loading(true);
    google.script.run
        .withSuccessHandler(function(base64) {
            loading(false);
            downloadPdfFromBase64(base64, fileName);
        })
        .withFailureHandler(function(err) {
            loading(false);
            myAlert('Gagal', 'Gagal generate PDF: ' + err.message, 'error');
        })
        .generatePdfFromHtml(fullHtml, fileName, logoId);
}

// --- FUNGSI CETAK NOTA KEUANGAN (A5 LANDSCAPE + 3 TANDA TANGAN) ---
// [JAVASCRIPT.HTML]
// Cari fungsi cetakNotaKeuangan(data) dan GANTI isinya dengan yang bersih ini:

function cetakNotaKeuangan(data) {
    // --- [HAPUS BAGIAN ERROR INI] ---
    // const table = document.getElementById(tableId);  <-- INI PENYEBAB ERROR
    // const tglFile = new Date().toISOString().slice(0,10);
    // const fileName = judulLaporan.replace(/\s+/g, '_') + '_' + tglFile; <-- INI JUGA ERROR
    // --------------------------------

    // 1. Ambil Profil Perusahaan
    const namaPT = globalCompanyProfile.nama_perusahaan || 'NAMA PERUSAHAAN';
    const alamatPT = globalCompanyProfile.alamat || '-';
    const noPT = globalCompanyProfile.no_perusahaan || '-';
    const logoUrl = globalCompanyProfile.logo_perusahaan || '';
    
    // --- [LOGIKA GAMBAR] ---
    let htmlLogo = '';
    // Jika ada logo, tampilkan
    if (globalCompanyProfile.logo_perusahaan) {
        // Kita gunakan placeholder agar nanti bisa diganti gambar base64 jika pakai PDF, 
        // tapi untuk window.print() langsung pakai URL saja agar muncul gambarnya.
        htmlLogo = `<img src="${globalCompanyProfile.logo_perusahaan}" style="height: 80px; width: auto; margin-right: 20px;">`;
    }

    // 2. Tentukan Judul, Warna & Label Tanda Tangan Ketiga
    let judulDokumen = '';
    let warnaHeader = '';
    let labelPihakKetiga = ''; 
    
    if (data.jenis === 'Pemasukan') {
        judulDokumen = 'BUKTI KAS MASUK';
        warnaHeader = '#198754'; // Hijau
        labelPihakKetiga = 'Penyetor / Pelanggan'; 
    } else {
        judulDokumen = 'BUKTI KAS KELUAR';
        warnaHeader = '#dc3545'; // Merah
        labelPihakKetiga = 'Penerima Uang'; 
    }

    // Format Tanggal
    let tglStr = new Date(data.tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

    // 3. Template HTML Nota
    const win = window.open('', '', 'height=600,width=800');
    
    const htmlContent = `
    <html>
    <head>
        <title>Cetak Nota - ${data.id}</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
            @page { size: A5 landscape; margin: 0; }
            body { 
                font-family: 'Roboto', sans-serif; 
                padding: 10mm; margin: 0;
                color: #333; 
                -webkit-print-color-adjust: exact; print-color-adjust: exact;
                background-color: white;
            }
            .container { 
                border: 2px solid #333; padding: 20px; 
                width: 100%; height: 100%; 
                box-sizing: border-box; position: relative; 
            }
            .header { 
                display: flex; align-items: center; 
                border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; 
            }
            .header-text h2 { margin: 0; font-size: 18px; color: #333; text-transform: uppercase; }
            .header-text p { margin: 0; font-size: 10px; color: #555; }
            .judul-nota { 
                text-align: center; font-size: 16px; font-weight: bold; 
                background-color: ${warnaHeader}; color: white; 
                padding: 5px; margin-bottom: 15px; border-radius: 4px; letter-spacing: 1px;
            }
            .row-content { display: flex; gap: 20px; }
            .col-left { flex: 1; }
            .col-right { flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; }
            .info-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
            .info-table td { padding: 4px 5px; vertical-align: top; font-size: 12px; } 
            .label { font-weight: bold; width: 120px; color: #555; }
            .separator { width: 10px; }
            .isi { border-bottom: 1px dotted #ccc; font-weight: 500; }
            .nominal-box { 
                background: #f8f9fa; border: 2px dashed ${warnaHeader}; 
                padding: 10px 30px; font-size: 22px; font-weight: bold; 
                color: ${warnaHeader}; display: inline-block; margin-top: 5px;
                border-radius: 8px; text-align: center;
            }
            .terbilang-label { font-size: 10px; color: #777; margin-top: 5px; }
            .footer { 
                display: flex; justify-content: space-between; 
                margin-top: 25px; text-align: center; padding: 0 10px;
            }
            .ttd-box { width: 30%; }
            .ttd-line { border-bottom: 1px solid #000; margin-top: 50px; font-weight: bold; font-size: 12px;}
            .timestamp {
                position: absolute; bottom: 5px; left: 0; right: 0;
                font-size: 8px; color: #999; text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                ${htmlLogo}
                <div class="header-text">
                    <h2>${namaPT}</h2>
                    <p>${alamatPT}</p>
                    <p>Telp: ${noPT}</p>
                </div>
            </div>

            <div class="judul-nota">${judulDokumen}</div>

            <div class="row-content">
                <div class="col-left">
                    <table class="info-table">
                        <tr><td class="label">No. Transaksi</td><td class="separator">:</td><td class="isi">${data.id}</td></tr>
                        <tr><td class="label">Tanggal</td><td class="separator">:</td><td class="isi">${tglStr}</td></tr>
                        <tr><td class="label">Kategori</td><td class="separator">:</td><td class="isi">${data.kategori}</td></tr>
                        <tr><td class="label">Keterangan</td><td class="separator">:</td><td class="isi" style="font-style: italic;">"${data.ket}"</td></tr>
                    </table>
                </div>
                <div class="col-right">
                    <div class="terbilang-label">JUMLAH UANG</div>
                    <div class="nominal-box">${rupiah(data.nominal)}</div>
                </div>
            </div>

            <div class="footer">
                <div class="ttd-box"><small>Disetujui Oleh,</small><div class="ttd-line">( Pimpinan / Owner )</div></div>
                <div class="ttd-box"><small>Dibuat Oleh,</small><div class="ttd-line">( Admin Keuangan )</div></div>
                <div class="ttd-box"><small>${labelPihakKetiga},</small><div class="ttd-line">( ....................... )</div></div>
            </div>
            
            <div class="timestamp">Dicetak otomatis oleh Sistem SiGAS PRO pada ${new Date().toLocaleString('id-ID')}</div>
        </div>
        <script>setTimeout(() => { window.print(); }, 1000);
        ` + '</sc' + 'ript>' + `
    </body>
    </html>
    `;
    
    win.document.write(htmlContent);
    win.document.close();
}

// [UPDATE FINAL FIX] Cetak Slip Kasbon - Style Formal (Surat A5)
function cetakSlipKasbon(dataRaw) {
    // 1. Parsing Data (Aman dari JSON string atau Object langsung)
    let data = {};
    try {
        data = (typeof dataRaw === 'string') ? JSON.parse(dataRaw) : dataRaw;
    } catch (e) {
        alert("Gagal membaca data slip.");
        return;
    }

    const namaPT = globalCompanyProfile.nama_perusahaan || 'NAMA PERUSAHAAN';
    const alamatPT = globalCompanyProfile.alamat || '-';
    const noPT = globalCompanyProfile.no_perusahaan || '-';
    const logoUrl = globalCompanyProfile.logo_perusahaan || '';
    
    // --- [LOGIKA PERBAIKAN DATA TERBALIK] ---
    // data.ket  = "Via BCA" (Metode Bayar Sebenarnya)
    // data.tipe = "Manual" (Jenis Transaksi)
    
    let judul = '';
    let labelJenisTransaksi = ''; 
    let labelMetodeBayar = data.ket || '-'; // Isi: "Via BCA", "Via Tunai"

    if(String(data.tipe).includes('Manual')) {
        judul = 'BUKTI SETORAN CICILAN';
        labelJenisTransaksi = 'PEMBAYARAN MANDIRI';
    } else {
        judul = 'BUKTI POTONG GAJI';
        labelJenisTransaksi = 'PEMOTONGAN GAJI (PAYROLL)';
    }

    let htmlLogo = logoUrl ? `<img src="${logoUrl}" alt="Logo">` : '';

    const win = window.open('', '', 'height=700,width=900');
    
    const htmlContent = `
    <!DOCTYPE html>
    <html lang="id">
    <head>
        <meta charset="UTF-8">
        <title>Slip ${data.nama}</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
            
            @page {
                size: A5 landscape;
                margin: 0; 
            }

            body {
                font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
                margin: 0;
                padding: 0;
                background-color: #e0e0e0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
            }

            /* KONTEN UTAMA (Kertas A5) */
            .slip-container {
                width: 210mm;
                height: 147mm;
                background: #fff;
                padding: 15mm;
                box-sizing: border-box;
                position: relative;
                display: flex;
                flex-direction: column;
                color: #000;
            }

            /* HEADER */
            .header {
                display: flex;
                align-items: center;
                border-bottom: 2px solid #000;
                padding-bottom: 15px;
                margin-bottom: 20px;
            }
            .header-logo img { height: 50px; width: auto; margin-right: 20px; filter: grayscale(100%); }
            .header-info h2 { margin: 0; font-size: 18px; text-transform: uppercase; color: #000; letter-spacing: 1px; }
            .header-info p { margin: 2px 0 0; font-size: 10px; color: #444; }

            /* JUDUL DOKUMEN */
            .doc-title {
                text-align: center;
                font-size: 14px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 2px;
                margin-bottom: 25px;
                text-decoration: underline;
                text-underline-offset: 5px;
            }

            /* ISI: GRID 2 KOLOM */
            .content-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 20px;
                gap: 30px;
            }
            
            .col-left, .col-right {
                flex: 1;
            }

            /* TABEL INFO */
            .info-table { width: 100%; border-collapse: collapse; }
            .info-table td {
                padding: 6px 0;
                font-size: 11px;
                vertical-align: top;
                border-bottom: 1px dotted #ccc;
            }
            .label { font-weight: bold; width: 130px; color: #333; text-transform: uppercase; font-size: 9px; }
            .val { color: #000; font-weight: 500; }

            /* KOTAK NOMINAL (GAYA BANK) */
            .nominal-section {
                margin-top: 10px;
                text-align: right;
                background-color: #f8f9fa;
                border: 1px solid #000;
                padding: 15px;
            }
            .nom-label { font-size: 10px; text-transform: uppercase; font-weight: bold; color: #555; margin-bottom: 5px;}
            .nom-value { font-size: 20px; font-weight: 700; color: #000; }
            
            .sisa-row {
                display: flex; justify-content: flex-end; align-items: center;
                margin-top: 5px; font-size: 11px; color: #333;
            }

            /* FOOTER TANDA TANGAN */
            .footer {
                margin-top: auto;
                display: flex;
                justify-content: space-between;
                padding-top: 10px;
            }
            .ttd-box { width: 30%; text-align: center; }
            .ttd-title { font-size: 9px; text-transform: uppercase; font-weight: bold; margin-bottom: 50px; color: #555; }
            .ttd-line { border-top: 1px solid #000; width: 80%; margin: 0 auto; }
            .ttd-name { font-size: 10px; font-weight: 700; margin-top: 5px; text-transform: uppercase; }

            /* INFO TAMBAHAN */
            .meta-info {
                position: absolute; bottom: 10mm; left: 15mm;
                font-size: 8px; color: #666; font-family: monospace;
            }

            /* PRINT RESET */
            @media print {
                body { background: none; }
                .slip-container { border: none; margin: 0; box-shadow: none; }
            }
        </style>
    </head>
    <body>
        <div class="slip-container">
            <div class="header">
                <div class="header-logo">${htmlLogo}</div>
                <div class="header-info">
                    <h2>${namaPT}</h2>
                    <p>${alamatPT} | Telp: ${noPT}</p>
                </div>
            </div>

            <div class="doc-title">${judul}</div>

            <div class="content-row">
                <div class="col-left">
                    <table class="info-table">
                        <tr><td class="label">No. Referensi</td><td class="val">#${'PAY-' + Date.now().toString().slice(-6)}</td></tr>
                        <tr><td class="label">Tanggal Transaksi</td><td class="val">${data.tanggal}</td></tr>
                        <tr><td class="label">Nama Karyawan</td><td class="val" style="font-weight:bold; font-size:12px">${data.nama}</td></tr>
                        
                        <tr><td class="label">Jenis Transaksi</td><td class="val">${labelJenisTransaksi}</td></tr>
                        <tr><td class="label">Metode Bayar</td><td class="val" style="font-style:italic;">"${labelMetodeBayar}"</td></tr>
                    </table>
                </div>

                <div class="col-right">
                    <div class="nominal-section">
                        <div class="nom-label">Jumlah Dibayar (IDR)</div>
                        <div class="nom-value">${rupiah(data.nominal)}</div>
                        
                        <div style="border-top: 1px solid #ccc; margin: 10px 0;"></div>
                        
                        <div class="sisa-row">
                            <span style="margin-right: 10px;">Sisa Pokok Hutang:</span>
                            <span style="font-weight:bold;">${rupiah(data.sisa)}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer">
                <div class="ttd-box">
                    <div class="ttd-title">Diterima Oleh (Admin),</div>
                    <div class="ttd-line"></div>
                    <div class="ttd-name">.........................</div>
                </div>
                <div class="ttd-box">
                    <div class="ttd-title">Penyetor (Karyawan),</div>
                    <div class="ttd-line"></div>
                    <div class="ttd-name">${data.nama}</div>
                </div>
            </div>

            <div class="meta-info">
                Dicetak: ${new Date().toLocaleString('id-ID')} | Ref ID: ${data.idKasbon}
            </div>
        </div>

        <script>
            setTimeout(() => { window.print(); }, 2000);
        ` + '</sc' + 'ript>' + `
    </body>
    </html>
    `;
    
    win.document.write(htmlContent);
    win.document.close();
}

// [UPDATE FINAL] Cetak Rekap Lengkap Kasbon (Versi A4 Portrait)
function cetakRekapKasbonFull(data) {
    const namaPT = globalCompanyProfile.nama_perusahaan || 'NAMA PERUSAHAAN';
    const alamatPT = globalCompanyProfile.alamat || '-';
    const noPT = globalCompanyProfile.no_perusahaan || '-';
    const logoUrl = globalCompanyProfile.logo_perusahaan || '';
    
    let htmlLogo = logoUrl ? `<img src="${logoUrl}" style="height: 100px; width: auto; margin-right: 20px; filter: grayscale(100%);">` : '';

    // Generate Baris Tabel History
    let rowsHTML = '';
    if(data.listRiwayat.length === 0) {
        rowsHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">Belum ada riwayat pembayaran.</td></tr>';
    } else {
        data.listRiwayat.forEach(item => {
            let tgl = new Date(item.tanggal).toLocaleDateString('id-ID');
            rowsHTML += `
                <tr>
                    <td>${tgl}</td>
                    <td>
                        <div style="font-weight:bold;">${item.tipe}</div>
                        <div style="font-size:10px; color:#555;">${item.ket}</div>
                    </td>
                    <td style="text-align:right;">${rupiah(item.nominal)}</td>
                </tr>
            `;
        });
    }

    const win = window.open('', '', 'height=800,width=700');
    
    const htmlContent = `
    <!DOCTYPE html>
    <html lang="id">
    <head>
        <meta charset="UTF-8">
        <title>Rekap Kasbon - ${data.namaKaryawan}</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
            
            /* SETTING KERTAS A4 PORTRAIT */
            @page { 
                size: A4; 
                margin: 0; 
            }

            body {
                font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
                margin: 0; padding: 0; background: #e0e0e0;
                display: flex; justify-content: center; 
                min-height: 100vh;
                -webkit-print-color-adjust: exact; print-color-adjust: exact;
            }

            /* CONTAINER A4 */
            .sheet {
                width: 210mm; 
                min-height: 297mm; /* Tinggi A4 */
                background: #fff; 
                padding: 15mm 20mm; /* Margin kiri-kanan lebih lega */
                box-sizing: border-box; 
                position: relative; 
                display: flex; 
                flex-direction: column;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }

            /* HEADER */
            .header {
                display: flex; align-items: center; border-bottom: 3px double #000;
                padding-bottom: 15px; margin-bottom: 25px;
            }
            .header-info h2 { margin: 0; font-size: 20px; text-transform: uppercase; color: #000; letter-spacing: 1px; }
            .header-info p { margin: 2px 0 0; font-size: 11px; color: #444; }
            
            /* JUDUL */
            .doc-title {
                text-align: center; font-size: 16px; font-weight: 800;
                text-transform: uppercase; letter-spacing: 1.5px;
                background: #f8f9fa; padding: 10px; margin-bottom: 30px; 
                border-top: 1px solid #000; border-bottom: 1px solid #000;
            }

            /* SUMMARY GRID */
            .info-grid {
                display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px;
            }
            .info-col {
                display: flex; flex-direction: column; gap: 8px;
            }
            .row-item {
                display: flex; justify-content: space-between; border-bottom: 1px dotted #ccc; padding-bottom: 2px;
            }
            .lbl { font-size: 11px; color: #666; font-weight: bold; text-transform: uppercase; }
            .val { font-size: 13px; font-weight: bold; color: #000; }
            .val-red { color: #d32f2f; font-size: 16px; }

            /* TABEL HISTORY */
            .table-container { flex-grow: 1; }
            .tbl-rekap { width: 100%; border-collapse: collapse; font-size: 11px; }
            .tbl-rekap th { 
                background: #333; color: #fff; padding: 10px 8px; text-align: left; 
                text-transform: uppercase; letter-spacing: 0.5px;
            }
            .tbl-rekap td { 
                border-bottom: 1px solid #ddd; padding: 8px; vertical-align: top; 
            }
            .tbl-rekap tr:nth-child(even) { background-color: #f9f9f9; }

            /* FOOTER */
            .footer { 
                margin-top: 50px; 
                display: flex; justify-content: space-between; text-align: center; 
                page-break-inside: avoid;
            }
            .ttd-box { width: 30%; }
            .ttd-line { border-bottom: 1px solid #000; margin-top: 60px; font-weight: bold; font-size: 11px; }
            .timestamp { margin-top: 30px; font-size: 9px; color: #999; text-align: center; }

            /* PRINT STYLE */
            @media print {
                body { background: none; margin: 0; padding: 0; }
                .sheet { margin: 0; box-shadow: none; border: none; width: 100%; height: auto; }
            }
        </style>
    </head>
    <body>
        <div class="sheet">
            <div class="header">
                ${htmlLogo}
                <div class="header-info">
                    <h2>${namaPT}</h2>
                    <p>${alamatPT} | Telp: ${noPT}</p>
                </div>
            </div>

            <div class="doc-title">REKAPITULASI PINJAMAN KARYAWAN</div>

            <div class="info-grid">
                <div class="info-col">
                    <div class="row-item">
                        <span class="lbl">ID Karyawan</span> <span class="val">-</span>
                    </div>
                    <div class="row-item">
                        <span class="lbl">Nama Karyawan</span> <span class="val" style="font-size:14px">${data.namaKaryawan}</span>
                    </div>
                    <div class="row-item">
                        <span class="lbl">ID Pinjaman</span> <span class="val">${data.idKasbon}</span>
                    </div>
                </div>
                <div class="info-col" style="background:#fffcfc; padding:10px; border:1px solid #eee;">
                    <div class="row-item">
                        <span class="lbl">Total Pinjaman</span> <span class="val">${rupiah(data.totalPinjam)}</span>
                    </div>
                    <div class="row-item">
                        <span class="lbl">Total Terbayar</span> <span class="val text-success">${rupiah(data.totalBayar)}</span>
                    </div>
                    <div class="row-item" style="border-bottom:none; margin-top:5px; align-items:center;">
                        <span class="lbl" style="color:#d32f2f;">SISA HUTANG</span> <span class="val val-red">${rupiah(data.sisaHutang)}</span>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <h4 style="font-size:12px; text-transform:uppercase; border-bottom:2px solid #333; display:inline-block; margin-bottom:10px;">Rincian Pembayaran</h4>
                <table class="tbl-rekap">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Tanggal</th>
                            <th style="width: 50%;">Keterangan / Metode</th>
                            <th style="width: 30%; text-align:right;">Nominal Bayar</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rowsHTML}
                    </tbody>
                    <tfoot style="border-top: 2px solid #333; font-weight:bold;">
                        <tr>
                            <td colspan="2" style="text-align:right; padding-top:10px;">TOTAL PEMBAYARAN MASUK</td>
                            <td style="text-align:right; padding-top:10px; font-size:12px;">${rupiah(data.totalBayar)}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="footer">
                <div class="ttd-box">
                    <small>Disetujui Oleh,</small>
                    <div class="ttd-line">( Admin / HRD )</div>
                </div>
                <div class="ttd-box">
                    <small>Penyetor / Karyawan,</small>
                    <div class="ttd-line">( ${data.namaKaryawan} )</div>
                </div>
            </div>

            <div class="timestamp">
                Dicetak pada: ${new Date().toLocaleString('id-ID')}
            </div>
        </div>
        <script>setTimeout(() => { window.print(); }, 2000);
        ` + '</sc' + 'ript>' + `
    </body>
    </html>
    `;
    
    win.document.write(htmlContent);
    win.document.close();
}

// --- FUNGSI CETAK SLIP GAJI KARYAWAN ---
function cetakSlipGaji(data) {
    // --- TAMBAHAN BARU: Bikin idGaji isinya angka saja (Hapus huruf) ---
    data.idGaji = data.id ? data.id.replace(/\D/g, '') : '-'; 

    // 1. Ambil Profil Perusahaan
    const namaPT = globalCompanyProfile.nama_perusahaan || 'PERUSAHAAN ANDA';
    const alamatPT = globalCompanyProfile.alamat || '-';
    const logoUrl = globalCompanyProfile.logo_perusahaan || '';
    
    let htmlLogo = logoUrl ? `<img src="${logoUrl}" style="height: 100px; width: auto; margin-right: 15px; filter: grayscale(100%);">` : '';

    // 2. Format Rupiah Helper
    const rp = (n) => new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits:0}).format(n);

    // 3. Buka Jendela Print
    const win = window.open('', '', 'height=600,width=800');
    
    const htmlContent = `
    <!DOCTYPE html>
    <html lang="id">
    <head>
        <title>Slip Gaji - ${data.nama}</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
            @page { size: A5 landscape; margin: 0; }
            body { 
                font-family: 'Roboto', sans-serif; 
                background: #e0e0e0; 
                margin: 0; padding: 0;
                display: flex; justify-content: center; align-items: center; 
                min-height: 100vh;
                -webkit-print-color-adjust: exact; print-color-adjust: exact;
            }
            .slip-box {
                width: 210mm; height: 140mm; /* A5 Landscape */
                background: white; padding: 15mm; box-sizing: border-box;
                display: flex; flex-direction: column; position: relative;
            }
            .header {
                display: flex; align-items: center; border-bottom: 2px solid #000;
                padding-bottom: 10px; margin-bottom: 20px;
            }
            .header h2 { margin: 0; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; }
            .header p { margin: 2px 0 0; font-size: 10px; color: #555; }
            
            .title { text-align: center; font-weight: bold; text-transform: uppercase; text-decoration: underline; margin-bottom: 20px; font-size: 16px; }
            
            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
            .info-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
            .lbl { font-weight: bold; color: #444; }
            
            .rincian-box { border: 1px solid #ccc; padding: 10px; height: 100%; }
            .rincian-head { font-size: 11px; font-weight: bold; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-bottom: 10px; text-transform: uppercase; }
            
            .total-row { 
                background: #f1f1f1; padding: 10px; 
                display: flex; justify-content: space-between; align-items: center;
                border: 1px solid #999; margin-top: auto;
            }
            
            .footer { margin-top: auto; display: flex; justify-content: space-between; text-align: center; }
            .ttd-line { border-bottom: 1px solid #000; margin-top: 50px; width: 120px; margin-left: auto; margin-right: auto; }
            
            @media print {
                body { background: none; }
                .slip-box { width: 100%; height: 100%; margin: 0; border: none; }
            }
        </style>
    </head>
    <body>
        <div class="slip-box">
            <div class="header">
                ${htmlLogo}
                <div>
                    <h2>${namaPT}</h2>
                    <p>${alamatPT}</p>
                </div>
            </div>

            <div class="title">SLIP GAJI KARYAWAN</div>

            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 12px;">
                <table>
                    <tr><td class="lbl" width="100">Periode</td><td>: ${data.periode}</td></tr>
                    <tr><td class="lbl">ID Transaksi</td><td>: ${data.id}</td></tr>
                    <tr><td class="lbl">Nama</td><td>: <b>${data.nama}</b></td></tr>
                </table>
                <div style="text-align: right;">
                    <small>Dicetak: ${new Date().toLocaleDateString('id-ID')}</small><br>
                </div>
            </div>

            <div class="info-grid">
                <div class="rincian-box">
                    <div class="rincian-head" style="color: green;">PENERIMAAN (+)</div>
                    <div class="info-row"><span class="lbl">Gaji Pokok</span> <span>${rp(data.gaji)}</span></div>
                    <div class="info-row"><span class="lbl">Bonus / Tunjangan</span> <span>${rp(data.bonus)}</span></div>
                    
                    ${data.kasbonBaru > 0 ? `<div class="info-row text-primary"><span class="lbl">Pencairan Kasbon</span> <span>${rp(data.kasbonBaru)}</span></div>` : ''}
                    
                </div>
                <div class="rincian-box">
                    <div class="rincian-head" style="color: red;">POTONGAN (-)</div>
                    <div class="info-row"><span class="lbl">Kasbon / Cicilan</span> <span>${rp(data.kasbon)}</span></div>
                </div>
            </div>

            <div class="total-row">
                <span style="font-weight: bold; font-size: 14px;">TOTAL DITERIMA (THP)</span>
                <span style="font-weight: bold; font-size: 20px; color: #333;">${rp(data.total)}</span>
            </div>

            <div class="footer">
                <div style="width: 30%;">
                    <small>Diserahkan Oleh,</small>
                    <div class="ttd-line"></div>
                    <small>Admin Keuangan</small>
                </div>
                <div style="width: 30%;">
                    <small>Diterima Oleh,</small>
                    <div class="ttd-line"></div>
                    <small>${data.nama}</small>
                </div>
            </div>
        </div>
        <script>setTimeout(() => { window.print(); }, 2000);
        ` + '</sc' + 'ript>' + `
    </body>
    </html>
    `;
    
    win.document.write(htmlContent);
    win.document.close();
}

// --- LOGIKA LAPORAN BARU ---

// [JAVASCRIPT.HTML] Cari fungsi loadLaporanUtama
function loadLaporanUtama() {
    const start = document.getElementById('lap-start').value;
    const end = document.getElementById('lap-end').value;
    
    if(!start || !end) return; 

    loading(true);
    google.script.run.withSuccessHandler(data => {
        loading(false);
        
        globalLaporanData = data; // <--- SIMPAN DATA MENTAH DISINI
        
        renderLaporanUI(data);    // Lanjut tampilkan ke layar
    }).getLaporanDetail(start, end);
}

function loadLaporanSaldo() {
    const tbody = document.querySelector('#tabel-lap-saldo tbody');
    const labelTotal = document.getElementById('total-saldo-all');
    
    // Tampilkan Loading
    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted"><div class="spinner-border spinner-border-sm text-primary"></div> Memuat data saldo...</td></tr>';

    google.script.run.withSuccessHandler(data => {
        tbody.innerHTML = '';
        let totalAset = 0;

        if(!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">Belum ada akun keuangan yang terdaftar.</td></tr>';
            labelTotal.innerText = 'Rp 0';
            return;
        }

        data.forEach(acc => {
            totalAset += Number(acc.saldo);
            
            // Ikon berdasarkan tipe akun
            let icon = 'account_balance_wallet'; // Default
            let bgIcon = 'bg-warning-subtle text-warning-emphasis';
            
            if(acc.tipe === 'Bank') { 
                icon = 'account_balance'; 
                bgIcon = 'bg-primary-subtle text-primary';
            } else if (acc.tipe === 'Tunai') {
                icon = 'payments';
                bgIcon = 'bg-success-subtle text-success';
            } else if (acc.tipe === 'E-Wallet') {
                icon = 'smartphone';
                bgIcon = 'bg-info-subtle text-info-emphasis';
            }

            // Tentukan warna saldo (Merah jika minus/nol, Hitam jika ada isi)
            let colorSaldo = Number(acc.saldo) <= 0 ? 'text-danger' : 'text-dark';

            tbody.innerHTML += `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle p-2 me-3 ${bgIcon} d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="material-icons" style="font-size:20px">${icon}</i>
                            </div>
                            <div>
                                <div class="fw-bold text-dark">${acc.nama}</div>
                                <small class="text-muted" style="font-size:11px;">ID: ${acc.id}</small>
                            </div>
                        </div>
                    </td>
                    <td style="font-family: 'Consolas', monospace; font-weight: 600; color: #555;">
                        ${acc.norek && acc.norek !== '-' ? acc.norek : '<span class="text-muted fst-italic">-</span>'}
                    </td>
                    <td>
                        <span class="badge bg-light text-secondary border">${acc.tipe}</span>
                    </td>
                    <td class="text-end fw-bold ${colorSaldo} fs-6">
                        ${rupiah(acc.saldo)}
                    </td>
                </tr>
            `;
        });

        // Update Total Aset di Footer
        labelTotal.innerText = rupiah(totalAset);

    }).getDaftarAkun(); // Menggunakan fungsi backend yang sudah ada
}

function renderLaporanUI(data) {
    const rp = (n) => new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits:0}).format(n);

    // Hitung Total Pengeluaran GABUNGAN untuk Tampilan Layar
    // (Biaya Listrik/Gaji + Uang Refund Retur)
    let totalBebanDisplay = (data.pengeluaran || 0) + (data.totalRetur || 0);

    // 1. ISI KARTU UTAMA
    document.getElementById('lap-pendapatan').innerText = rp(data.pendapatan);
    document.getElementById('lap-hpp').innerText = rp(data.hpp);
    document.getElementById('lap-kotor').innerText = rp(data.labaKotor);
    
    // TAMPILKAN GABUNGAN DI SINI
    document.getElementById('lap-beban').innerText = rp(totalBebanDisplay); 
    
    document.getElementById('lap-bersih').innerText = rp(data.labaBersih);
    document.getElementById('lap-beli').innerText = rp(data.pembelian)
    
    // --- UPDATE BAGIAN ASET (LEBIH DETAIL) ---
    const elStok = document.getElementById('lap-stok');

    // 2. ISI TABEL PENGELUARAN (Tampilkan gabungan juga di header tabel)
    document.getElementById('lap-beban-total').innerText = rp(totalBebanDisplay);
    
    // Kita ubah isinya jadi HTML agar bisa ada baris baru
    elStok.innerHTML = `
        <div class="fw-bold fs-4">${rp(data.nilaiStok)}</div>
        <div class="mt-2 pt-2 border-top" style="font-size: 11px; line-height: 1.4;">
            <div class="d-flex justify-content-between">
                <span class="text-secondary">Wadah (Fisik):</span>
                <span class="fw-bold text-dark">${rp(data.asetFisik)}</span>
            </div>
            <div class="d-flex justify-content-between">
                <span class="text-secondary">Isi (Dagang):</span>
                <span class="fw-bold text-success">${rp(data.asetDagang)}</span>
            </div>
        </div>
    `;

    // 2. ISI TABEL METODE BAYAR
    const tbMetode = document.querySelector('#tabel-metode-bayar tbody');
    tbMetode.innerHTML = '';
    
    Object.keys(data.metodeBayar).forEach(m => {
        let nominal = data.metodeBayar[m];
        tbMetode.innerHTML += `
            <tr>
                <td class="ps-3 fw-bold text-muted">${m}</td>
                <td class="text-end pe-3 fw-bold text-dark">${rp(nominal)}</td>
            </tr>
        `;
    });

    // 3. ISI TABEL PENGELUARAN
    document.getElementById('lap-beban-total').innerText = rp(data.pengeluaran); 
    
    const tbBeban = document.querySelector('#tabel-det-pengeluaran tbody');
    tbBeban.innerHTML = '';

    if(data.listPengeluaran.length === 0) {
        tbBeban.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Tidak ada pengeluaran pada periode ini.</td></tr>';
    } else {
        data.listPengeluaran.forEach(r => {
            let tgl = new Date(r.tanggal).toLocaleDateString('id-ID');
            tbBeban.innerHTML += `
                <tr>
                    <td class="fw-bold text-primary" style="font-size:12px">${r.id}</td>
                    <td>${tgl}</td>
                    <td><span class="badge bg-light text-dark border">${r.kategori}</span></td>
                    <td class="text-muted small">${r.ket}</td>
                    <td class="text-end fw-bold text-danger">${rp(r.jumlah)}</td>
                </tr>
            `;
        });
    }
}

// FUNGSI FILTER CEPAT (Dropdown) - SUDAH DIPERBAIKI SUPORT FLATPICKR
function setFilterLaporan(pilihan) {
    const now = new Date();
    let start = new Date();
    let end = new Date();

    // Helper Format YYYY-MM-DD
    const fmt = (d) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const d_str = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${d_str}`;
    };

    if (pilihan === "bulan_ini") {
        start = new Date(now.getFullYear(), now.getMonth(), 1);
    } else if (pilihan === "bulan_lalu") {
        start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        end = new Date(now.getFullYear(), now.getMonth(), 0); 
    } else if (pilihan === "kemarin") {
        start.setDate(now.getDate() - 1);
        end.setDate(now.getDate() - 1);
    } else if (pilihan === "7_hari") {
        start.setDate(now.getDate() - 6);
    } 
    // "hari_ini" default start=now, end=now

    // --- PERBAIKAN UTAMA DI SINI ---
    const elStart = document.getElementById('lap-start');
    const elEnd = document.getElementById('lap-end');

    // Cek apakah elemen ini dikendalikan oleh Flatpickr?
    if (elStart._flatpickr) {
        elStart._flatpickr.setDate(start, true); // true = trigger change event
    } else {
        elStart.value = fmt(start);
    }

    if (elEnd._flatpickr) {
        elEnd._flatpickr.setDate(end, true);
    } else {
        elEnd.value = fmt(end);
    }

    // Trigger Load Data
    loadLaporanUtama();
}

// --- EKSPOR PDF & EXCEL (Sederhana) ---
function exportLaporanExcel() {
    // Gunakan fungsi export yang sudah ada, tapi targetkan tabel spesifik
    // Untuk Laporan Lengkap, idealnya buat endpoint khusus, tapi untuk cepat:
    // Kita export tabel Pengeluaran saja dulu atau buat HTML khusus hidden table
    alert('Fitur Excel Full Report akan segera hadir. Saat ini gunakan Print PDF.');
}

// --- FUNGSI CETAK LAPORAN PROFESIONAL (A4) ---
// [REVISI PRO] Export PDF Laporan Keuangan (Gaya Profesional - Clean Black & White)
// [JAVASCRIPT.HTML] Update Fungsi Cetak PDF (FIXED VERSION)
function printLaporanPDFCurrent() {
    // 1. Identifikasi Tab Aktif
    const isTabLabaAktif = document.getElementById('tab-laba').classList.contains('active');
    const elTabSaldo = document.getElementById('tab-saldo');
    const isTabSaldoAktif = elTabSaldo && elTabSaldo.classList.contains('active');
    
    // 2. Data Perusahaan & Tanggal
    const namaPT = globalCompanyProfile.nama_perusahaan || 'NAMA PERUSAHAAN';
    const alamatPT = globalCompanyProfile.alamat || '-';
    
    // Tanggal Helper
    const startVal = document.getElementById('lap-start').value;
    const endVal = document.getElementById('lap-end').value;
    const tglStart = startVal ? new Date(startVal).toLocaleDateString('id-ID') : '-';
    const tglEnd = endVal ? new Date(endVal).toLocaleDateString('id-ID') : '-';

    let periodeStr = `Periode: ${tglStart} s/d ${tglEnd}`;
    let judulLaporan = '';
    let fileName = 'Laporan_Keuangan';

    // --- LOGIKA LOGO (Agar Tidak Crash & Tetap Berwarna) ---
    let logoId = null;
    let htmlLogo = '';
    if (globalCompanyProfile.logo_perusahaan) {
        const match = globalCompanyProfile.logo_perusahaan.match(/id=([^&]+)/);
        if (match) {
            logoId = match[1];
            // Logo diberi margin bottom agar tidak nempel header teks
            htmlLogo = `<img src="[[LOGO_IMAGE_PLACEHOLDER]]" style="height: 65px; width: auto; margin-bottom: 8px;">`;
        }
    }
    // -------------------------------------------------------

    // 3. Konten HTML Body
    let kontenBody = '';

    if (isTabLabaAktif) {
        judulLaporan = 'LAPORAN LABA RUGI';
        fileName = `Laba_Rugi_${tglStart}_${tglEnd}`;
        
        // Helper Format Rupiah
        const rp = (n) => new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits:0}).format(n);

        // Ambil data dari variable global
        const data = globalLaporanData || {};
        
        const valPendapatan = rp(data.pendapatan || 0);
        const valHPP = rp(data.hpp || 0);
        const valKotor = rp(data.labaKotor || 0);
        const valBersih = rp(data.labaBersih || 0);
        const valRetur = data.totalRetur || 0; // Masih angka asli untuk logic

        // --- GROUPING RINCIAN BIAYA OPERASIONAL ---
        let detailOps = {};
        let totalOps = 0;
        let listItems = data.listPengeluaran || [];

        // Loop & Filter (Pisahkan Retur dari Operasional)
        listItems.forEach(item => {
            if (item.kategori !== 'Retur Penjualan') {
                if (!detailOps[item.kategori]) detailOps[item.kategori] = 0;
                detailOps[item.kategori] += item.jumlah;
                totalOps += item.jumlah;
            }
        });

        // Buat HTML Rincian Biaya Ops
        let htmlRincianOps = '';
        if (Object.keys(detailOps).length > 0) {
            // Header
            htmlRincianOps += `
                <tr>
                    <td class="label-sub" style="padding-left: 20px; font-weight:bold;">Biaya Operasional</td>
                    <td class="value-sub"></td> 
                </tr>`;
            // Isi
            for (let [kat, jml] of Object.entries(detailOps)) {
                htmlRincianOps += `
                    <tr>
                        <td class="label-sub" style="padding-left: 40px; font-size: 9pt;">- ${kat}</td>
                        <td class="value-sub" style="font-size: 9pt;">(${rp(jml)})</td>
                    </tr>`;
            }
        } else {
             htmlRincianOps += `
                <tr>
                    <td class="label-sub" style="padding-left: 20px;">Biaya Operasional</td>
                    <td class="value-sub">(${rp(0)})</td>
                </tr>`;
        }

        // Total Pengeluaran (Ops + Retur)
        let totalBebanSemua = totalOps + valRetur;
        
        // Data Bawah (Stok & Metode Bayar)
        const valStok = rp(data.nilaiStok || 0);
        const valBeli = rp(data.pembelian || 0);
        const tabelMetodeHTML = document.getElementById('tabel-metode-bayar') ? document.getElementById('tabel-metode-bayar').innerHTML : '';

        // SUSUN ULANG TAMPILAN PDF LABA RUGI
        kontenBody = `
            <table class="table-account" style="margin-top:20px;">
                <tr>
                    <td class="label-main">A. PENDAPATAN USAHA (OMZET)</td>
                    <td class="value-main">${valPendapatan}</td>
                </tr>
                <tr>
                    <td class="label-sub" style="padding-left: 20px;">Harga Pokok Penjualan (HPP)</td>
                    <td class="value-sub" style="color: #000;">(${valHPP})</td> 
                </tr>
                <tr class="row-total" style="background-color:#f9f9f9;">
                    <td class="label-total">LABA KOTOR</td>
                    <td class="value-total">${valKotor}</td>
                </tr>
                
                <tr>
                    <td colspan="2" style="padding-top:15px; font-weight:bold; text-decoration:underline;">B. PENGELUARAN & BIAYA</td>
                </tr>
                
                ${htmlRincianOps}

                ${valRetur > 0 ? `
                <tr>
                    <td class="label-sub" style="padding-left: 20px; color:#d32f2f; font-weight:bold;">Retur Penjualan (Refund)</td>
                    <td class="value-sub" style="color: #d32f2f;">(${rp(valRetur)})</td>
                </tr>` : ''}

                <tr style="border-top:1px dashed #ccc;">
                    <td class="label-sub" style="padding-left: 20px; font-style:italic; padding-top:5px;">Total Pengeluaran (B)</td>
                    <td class="value-sub" style="font-style:italic; padding-top:5px;">(${rp(totalBebanSemua)})</td>
                </tr>

                <tr class="row-grand-total" style="background-color:#e8f5e9;">
                    <td class="label-grand">LABA BERSIH (NET PROFIT)</td>
                    <td class="value-grand">${valBersih}</td>
                </tr>
            </table>

            <div style="margin-top: 40px;">
                <table style="width:100%; border-collapse:collapse;">
                    <tr>
                        <td style="width:48%; vertical-align:top;">
                            <div class="section-title">Data Stok Barang</div>
                            <table class="table-borderless">
                                <tr><td style="padding:4px 0;">Nilai Aset Stok</td><td style="text-align:right; font-weight:bold;">${valStok}</td></tr>
                                <tr><td style="padding:4px 0;">Pembelian Stok (Periode Ini)</td><td style="text-align:right; font-weight:bold;">${valBeli}</td></tr>
                            </table>
                        </td>
                        <td style="width:4%;"></td>
                        <td style="width:48%; vertical-align:top;">
                            <div class="section-title">Rincian Pembayaran Diterima</div>
                            <table class="table-bordered">
                                <thead><tr style="background-color:#f2f2f2;"><th>Metode</th><th style="text-align:right;">Total</th></tr></thead>
                                <tbody>${tabelMetodeHTML}</tbody>
                            </table>
                        </td>
                    </tr>
                </table>
            </div>
        `;

    } else if (isTabSaldoAktif) {
        // --- LOGIKA NERACA SALDO ---
        judulLaporan = 'NERACA SALDO (POSISI KEUANGAN)';
        const tglNow = new Date().toISOString().slice(0,10);
        fileName = `Neraca_Saldo_${tglNow}`;
        periodeStr = `Posisi Per Tanggal: ${new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`; 

        const valTotalSaldo = document.getElementById('total-saldo-all').innerText;
        
        // Re-construct Rows agar bersih dari HTML aneh-aneh
        const rows = document.querySelectorAll('#tabel-lap-saldo tbody tr');
        let cleanRows = '';
        rows.forEach((row, idx) => {
             const tds = row.querySelectorAll('td');
             if(tds.length > 0) {
                 // Bersihkan nama akun
                 let nama = tds[0].querySelector('.fw-bold') ? tds[0].querySelector('.fw-bold').innerText : tds[0].innerText;
                 let idAkun = tds[0].querySelector('small') ? tds[0].querySelector('small').innerText : '';
                 let norek = tds[1].innerText;
                 let tipe = tds[2].innerText;
                 let saldo = tds[3].innerText;
                 
                 // Zebra striping manual untuk PDF
                 let bg = idx % 2 === 0 ? '#fff' : '#f9f9f9';

                 cleanRows += `
                    <tr style="background-color:${bg};">
                        <td style="padding: 6px;">
                            <span style="font-weight:bold;">${nama}</span><br>
                            <span style="font-size:8pt; color:#444;">${idAkun}</span>
                        </td>
                        <td style="text-align:center;">${norek}</td>
                        <td style="text-align:center;">${tipe}</td>
                        <td style="text-align:right; font-weight:bold;">${saldo}</td>
                    </tr>`;
             }
        });

        kontenBody = `
            <div style="border: 1px solid #000; padding: 15px; margin-bottom: 30px; text-align:center;">
                <div style="font-size:10pt; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">Total Aset Keuangan</div>
                <div style="font-size:22pt; font-weight:bold; color:#000;">${valTotalSaldo}</div>
            </div>
            
            <div class="section-title">Rincian Saldo Akun</div>
            <table class="table-bordered">
                <thead>
                    <tr style="background-color:#eee;">
                        <th style="width:40%;">Nama Akun</th>
                        <th style="width:25%;">No. Rekening</th>
                        <th style="width:15%;">Tipe Akun</th>
                        <th style="width:20%; text-align:right;">Saldo Akhir</th>
                    </tr>
                </thead>
                <tbody>${cleanRows}</tbody>
            </table>
        `;

    } else {
        // --- LOGIKA LAPORAN PENGELUARAN BIASA ---
        judulLaporan = 'LAPORAN PENGELUARAN';
        fileName = `Pengeluaran_${tglStart}_${tglEnd}`;
        
        const valTotalBeban = document.getElementById('lap-beban-total').innerText;
        
        // Clone Tabel
        let tabelAsli = document.getElementById('tabel-det-pengeluaran').cloneNode(true);
        tabelAsli.className = 'table-bordered'; 
        tabelAsli.removeAttribute('style'); 
        
        // Hapus kolom aksi
        const ths = tabelAsli.querySelectorAll('th');
        if(ths.length > 0) ths[ths.length - 1].remove();
        const trs = tabelAsli.querySelectorAll('tr');
        trs.forEach(r => {
             const cells = r.querySelectorAll('td');
             if(cells.length > 0) cells[cells.length - 1].remove();
             // Paksa text hitam
             r.style.color = '#000';
        });

        kontenBody = `
            <div style="border-bottom: 2px solid #000; padding: 10px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:11pt; font-weight:bold;">TOTAL PENGELUARAN</span>
                <span style="font-size:16pt; font-weight:bold;">${valTotalBeban}</span>
            </div>
            <div class="section-title">Rincian Transaksi</div>
            ${tabelAsli.outerHTML}
        `;
    }

    // 4. CSS STYLE - PROFESSIONAL & CLEAN
    const cssStyle = `
        <style>
            @page { margin: 15mm; size: A4; }
            body { 
                font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
                color: #000; 
                font-size: 10pt; 
                line-height: 1.4;
            }
            
            /* Header Style */
            .header-container { text-align: center; margin-bottom: 30px; border-bottom: 3px double #000; padding-bottom: 15px; }
            .company-name { font-size: 18pt; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin: 0; }
            .company-address { font-size: 9pt; margin-top: 5px; color: #333; }
            
            /* Title Style */
            .report-title { text-align: center; font-size: 14pt; font-weight: bold; text-transform: uppercase; text-decoration: underline; margin-bottom: 5px; }
            .report-period { text-align: center; font-size: 9pt; color: #333; margin-bottom: 35px; font-style: italic; }
            
            /* Table Utility */
            .table-account { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .table-account td { padding: 6px 0; vertical-align: bottom; }
            
            /* Laba Rugi Specifics */
            .label-main { font-weight: bold; font-size: 11pt; }
            .value-main { text-align: right; font-weight: bold; font-size: 11pt; }
            
            .row-total { border-top: 1px solid #000; }
            .label-total { font-weight: bold; padding-top: 5px; text-transform: uppercase; }
            .value-total { text-align: right; font-weight: bold; padding-top: 5px; }
            
            /* Grand Total (Double Line) */
            .row-grand-total { border-top: 1px solid #000; border-bottom: 4px double #000; height: 40px; }
            .label-grand { font-weight: 800; font-size: 12pt; vertical-align: middle !important; text-transform: uppercase; }
            .value-grand { text-align: right; font-weight: 800; font-size: 14pt; vertical-align: middle !important; }

            /* Standard Table (Saldo & Pengeluaran) */
            .table-bordered { width: 100%; border-collapse: collapse; font-size: 9pt; margin-top: 5px; }
            .table-bordered th { border: 1px solid #000; padding: 8px; font-weight: bold; text-align: center; text-transform: uppercase; background-color: #f0f0f0; }
            .table-bordered td { border: 1px solid #888; padding: 6px 8px; }
            .table-borderless { width: 100%; }
            
            .section-title { font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #000; display: inline-block; margin-bottom: 5px; font-size: 9pt; }
            
            /* Helper */
            .text-end { text-align: right; }
        </style>
    `;

    // 5. Rakit HTML Lengkap
    const fullHtml = `
    <html>
    <head>${cssStyle}</head>
    <body>
        <div class="header-container">
            ${htmlLogo}
            <div class="company-name">${namaPT}</div>
            <div class="company-address">${alamatPT}</div>
        </div>

        <div class="report-title">${judulLaporan}</div>
        <div class="report-period">${periodeStr}</div>

        ${kontenBody}
        
        <div style="margin-top: 50px; text-align: center; font-size: 8pt; color: #555;">
            Dokumen ini dicetak otomatis oleh sistem SiGAS PRO.<br>
            Tanggal Cetak: ${new Date().toLocaleString('id-ID')}
        </div>
    </body>
    </html>
    `;

    // 6. Eksekusi Download
    loading(true);
    google.script.run
        .withSuccessHandler(function(base64) {
            loading(false);
            downloadPdfFromBase64(base64, fileName.replace(/\s+/g, '_'));
        })
        .withFailureHandler(function(err) {
            loading(false);
            myAlert('Gagal', err.message, 'error');
        })
        .generatePdfFromHtml(fullHtml, fileName, logoId);
}

// --- FITUR NOTIFIKASI LONCENG ---

function getNotifikasiData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const today = new Date();
  let notifikasiList = [];
  
  // 1. CEK HUTANG PELANGGAN (Sheet TRANSAKSI)
  const trxSheet = ss.getSheetByName('TRANSAKSI');
  if (trxSheet) {
    const dataTrx = trxSheet.getDataRange().getValues();
    // Asumsi Kolom: 0=ID, 2=Pelanggan, 8=Metode, 9=JatuhTempo, 10=Status
    // Sesuaikan index kolom jika berbeda
    
    for (let i = 1; i < dataTrx.length; i++) {
      let row = dataTrx[i];
      if (row[8] === 'Hutang' && row[10] === 'Belum Lunas' && row[9]) {
        let tglJatuhTempo = new Date(row[9]);
        
        // Hitung selisih hari (H-3 sudah muncul notif)
        let diffTime = tglJatuhTempo - today;
        let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        if (diffDays <= 3) { // Muncul jika H-3 atau sudah lewat
          let statusWaktu = (diffDays < 0) ? 'Telat ' + Math.abs(diffDays) + ' hari' : 'H-' + diffDays;
          notifikasiList.push({
            tipe: 'hutang',
            judul: 'Tagihan Pelanggan',
            pesan: `${row[2]} jatuh tempo (${statusWaktu})`,
            waktu: Utilities.formatDate(tglJatuhTempo, Session.getScriptTimeZone(), 'dd/MM/yyyy')
          });
        }
      }
    }
  }

  // 2. CEK KASBON KARYAWAN (Sheet KASBON - Jika ada)
  const kasbonSheet = ss.getSheetByName('KASBON'); // Pastikan nama sheet sesuai
  if (kasbonSheet) {
    const dataKasbon = kasbonSheet.getDataRange().getValues();
    // Asumsi: 1=Nama Karyawan, 3=Sisa, 4=Jatuh Tempo, 5=Status
    for (let i = 1; i < dataKasbon.length; i++) {
      let row = dataKasbon[i];
      // Logika: Status Open/Belum Lunas
      if (row[5] !== 'Lunas' && row[4]) {
        let tglJatuhTempo = new Date(row[4]);
        let diffTime = tglJatuhTempo - today;
        let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays <= 3) {
          let statusWaktu = (diffDays < 0) ? 'Telat ' + Math.abs(diffDays) + ' hari' : 'H-' + diffDays;
          notifikasiList.push({
            tipe: 'kasbon',
            judul: 'Kasbon Karyawan',
            pesan: `${row[1]} belum lunas (${statusWaktu})`,
            waktu: Utilities.formatDate(tglJatuhTempo, Session.getScriptTimeZone(), 'dd/MM/yyyy')
          });
        }
      }
    }
  }
  
  return notifikasiList;
}

function tampilkanLogAktivitas() {
    loading(true);
    google.script.run.withSuccessHandler(function(dataLog) {
        loading(false);
        
        let html = `
            <div style="padding:20px;">
                <h3>Log Aktivitas Sistem (50 Terakhir)</h3>
                <table class="table table-sm table-striped" style="font-size:9pt;">
                    <thead class="table-dark">
                        <tr>
                            <th>Waktu</th>
                            <th>Aksi</th>
                            <th>Detail</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        dataLog.forEach(r => {
            // Beri warna badge berdasarkan jenis aksi
            let badgeClass = 'bg-secondary';
            if(r.aksi.includes('HAPUS')) badgeClass = 'bg-danger';
            if(r.aksi.includes('TRANSAKSI')) badgeClass = 'bg-success';
            if(r.aksi.includes('EDIT')) badgeClass = 'bg-warning text-dark';
            
            html += `
                <tr>
                    <td>${r.waktu}</td>
                    <td><span class="badge ${badgeClass}">${r.aksi}</span></td>
                    <td>${r.detail}</td>
                </tr>
            `;
        });
        
        html += `</tbody></table></div>`;
        
        // Tampilkan di Modal atau Swal
        Swal.fire({
            title: '',
            html: html,
            width: '800px',
            showConfirmButton: true,
            confirmButtonText: 'Tutup'
        });
        
    }).getLogAktivitas();
}

// ==========================================
// LOGIKA STOK OPNAME (BUFFER & HISTORY)
// ==========================================
// 1. Fungsi Ganti Tab (Input <-> Riwayat)
function switchTabOpname(tab) {
    // Reset UI Navigasi
    document.querySelectorAll('#tabOpname .nav-link').forEach(btn => btn.classList.remove('active'));
    
    // Sembunyikan detail & munculkan tab menu (jaga-jaga)
    document.getElementById('page-detail-history-so')?.classList.add('d-none');
    document.getElementById('tabOpname')?.classList.remove('d-none');

    if (tab === 'input') {
        document.getElementById('tab-input-opname').classList.remove('d-none');
        document.getElementById('tab-riwayat-opname').classList.add('d-none');
        document.querySelector('#tabOpname li:nth-child(1) button')?.classList.add('active');

        // [UBAH DISINI] Jangan loadDataInputOpname() yang lama (karena itu load semua)
        // Cukup render apa yang ada di draft (keranjang sementara)
        renderTabelDraftOpname(); 
        
        // Pastikan data produk global terupdate untuk pencarian
        if(!globalProdukList || globalProdukList.length === 0) {
            loadProduk(); // Load diam-diam di background
        }

    } else {
        document.getElementById('tab-input-opname').classList.add('d-none');
        document.getElementById('tab-riwayat-opname').classList.remove('d-none');
        document.querySelector('#tabOpname li:nth-child(2) button')?.classList.add('active');
        
        loadRiwayatSO();
    }
}

// ======================= BAGIAN INPUT & DRAFT =======================

// 2. Load Data Produk ke Tabel Input
function loadDataInputOpname() {
  // Jika buffer masih ada isinya, kita peringatkan atau biarkan? 
  // Di sini kita biarkan user load, tapi buffer akan reset jika halaman direfresh total.
  
  loading(true);
  google.script.run.withSuccessHandler(data => {
    loading(false);
    renderTabelInputOpname(data);
  }).getData('PRODUK');
}

function renderTabelInputOpname(data) {
  const tb = document.querySelector('#tabel-input-opname tbody');
  tb.innerHTML = '';

  data.forEach(row => {
    // row[0]=ID, [1]=Nama, [4]=StokIsi, [5]=StokKosong
    let id = row[0];
    
    // Cek apakah produk ini sudah ada di draftBuffer (jika user pindah halaman lalu balik lagi)
    let valIsi = draftBuffer[id] ? draftBuffer[id].fisikIsi : '';
    let valKsg = draftBuffer[id] ? draftBuffer[id].fisikKosong : '';
    let valKet = draftBuffer[id] ? draftBuffer[id].keterangan : '';
    
    // Warna background kuning jika ada di draft
    let bgClass = draftBuffer[id] ? 'bg-warning bg-opacity-10' : ''; 

tb.innerHTML += `
      <tr class="${bgClass}" id="row-op-${id}">
        <td class="fw-bold text-dark">${row[1]}</td>
        
        <td class="text-center bg-light text-muted fw-bold">${row[4]}</td>
        
        <td>
          <input type="number" class="form-control form-control-sm text-center border-primary fw-bold" 
             value="${valIsi}" 
             onchange="updateBuffer('${id}', '${row[1]}', ${row[4]}, ${row[5]}, this)">
        </td>
        
        <td class="text-center bg-light text-muted fw-bold">${row[5]}</td>
        
        <td>
          <input type="number" class="form-control form-control-sm text-center border-secondary fw-bold" 
             value="${valKsg}" 
             onchange="updateBuffer('${id}', '${row[1]}', ${row[4]}, ${row[5]}, this)">
        </td>
        
        <td>
          <input type="text" class="form-control form-control-sm" 
             placeholder="Ket..." value="${valKet}"
             onchange="updateBuffer('${id}', '${row[1]}', ${row[4]}, ${row[5]}, this)">
        </td>
      </tr>
    `;
  });
}

// 3. Update Buffer saat user mengetik
function updateBuffer(id, nama, sysIsi, sysKsg, el) {
  const row = document.getElementById(`row-op-${id}`);
  
  // Ambil nilai dari input fields di baris tersebut
  const inputs = row.querySelectorAll('input'); 
  const inputIsi = inputs[0].value;   // Input Fisik Isi
  const inputKsg = inputs[1].value;   // Input Fisik Kosong
  const inputKet = inputs[2].value;   // Input Keterangan

  // Logika: Jika kedua input angka kosong, hapus dari draft (Batal ubah)
  if (inputIsi === '' && inputKsg === '') {
    delete draftBuffer[id];
    row.classList.remove('bg-warning', 'bg-opacity-10');
  } else {
    // Jika salah satu diisi, yang kosong dianggap SAMA dengan sistem
    const finalIsi = inputIsi === '' ? sysIsi : Number(inputIsi);
    const finalKsg = inputKsg === '' ? sysKsg : Number(inputKsg);

    // Simpan ke object Buffer
    draftBuffer[id] = {
      id: id,
      nama: nama,
      sysIsi: sysIsi,
      sysKsg: sysKsg,
      fisikIsi: finalIsi,
      fisikKosong: finalKsg,
      keterangan: inputKet
    };
    
    // Beri highlight kuning
    row.classList.add('bg-warning', 'bg-opacity-10');
  }
  
  updateBadgeDraft();
}

function updateBadgeDraft() {
  const count = Object.keys(draftBuffer).length;
  const badge = document.getElementById('badge-draft');
  badge.innerText = count;
  if(count > 0) badge.classList.remove('d-none');
  else badge.classList.add('d-none');
}

// 4. Filter Tabel Input (Pencarian)
function filterTabelInputOpname() {
  const k = document.getElementById('cari-opname-input').value.toLowerCase();
  document.querySelectorAll('#tabel-input-opname tbody tr').forEach(tr => {
    // Cari text di dalam tr (nama produk ada di td pertama)
    tr.style.display = tr.innerText.toLowerCase().includes(k) ? '' : 'none';
  });
}

// 5. Review Draft (Tampilkan Modal)
function reviewDraft() {
  const keys = Object.keys(draftBuffer);
  if (keys.length === 0) return myAlert('Info', 'Belum ada data yang diubah.', 'info');

  const tbody = document.getElementById('tbody-review-opname');
  tbody.innerHTML = '';

  keys.forEach(key => {
    const item = draftBuffer[key];
    
    // Hitung selisih untuk tampilan
    const selisihIsi = item.fisikIsi - item.sysIsi;
    const selisihKsg = item.fisikKosong - item.sysKsg;

    // Formatting Tampilan (Merah jika kurang, Hijau jika lebih, Abu jika tetap)
    const fmtDiff = (val) => {
        if(val > 0) return `<span class="text-success fw-bold">(+${val})</span>`;
        if(val < 0) return `<span class="text-danger fw-bold">(${val})</span>`;
        return `<span class="text-muted text-opacity-50">(-)</span>`;
    };
    
    tbody.innerHTML += `
      <tr>
        <td class="fw-bold">${item.nama}</td>
        <td class="text-center">
            ${item.sysIsi} <i class="material-icons align-middle" style="font-size:12px">arrow_forward</i> <b>${item.fisikIsi}</b> ${fmtDiff(selisihIsi)}
        </td>
        <td class="text-center">
            ${item.sysKsg} <i class="material-icons align-middle" style="font-size:12px">arrow_forward</i> <b>${item.fisikKosong}</b> ${fmtDiff(selisihKsg)}
        </td>
        <td><small class="text-muted">${item.keterangan}</small></td>
      </tr>
    `;
  });

  new bootstrap.Modal(document.getElementById('modalReviewOpname')).show();
}

// 6. Eksekusi Simpan ke Database
function prosesSimpanSO() {
    if (Object.keys(draftBuffer).length === 0) return myAlert('Peringatan', 'Belum ada produk!', 'warning');

    Swal.fire({
        title: 'Simpan Data Opname?',
        text: "Stok akan diperbarui sesuai input fisik!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya, Simpan!',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            
            // Tutup Modal
            const modalEl = document.getElementById('modalReviewOpname');
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) modalInstance.hide(); 
            else new bootstrap.Modal(modalEl).hide();
            
            loading(true); 
            const payload = Object.values(draftBuffer);

            google.script.run
                .withSuccessHandler(function(response) {
                    loading(false);
                    let res;
                    try { res = JSON.parse(response); } catch(e) { res = { status: 'error', message: response }; }

                    if (res.status === 'success') {
                        myAlert('Sukses', res.message, 'success');

                        // 1. Bersihkan Input
                        draftBuffer = {};
                        renderTabelDraftOpname();
                        document.getElementById('badge-draft').classList.add('d-none');
                        loadProduk(); // Refresh data global

                        // 2. [SATUKAN JALUR] Langsung Panggil Fungsi Detail Riwayat
                        if (res.id) {
                            // Pindah Tab secara visual ke "Riwayat"
                            switchTabOpname('riwayat');
                            
                            // Panggil fungsi yang SAMA PERSIS dengan klik manual
                            lihatDetailSO(res.id); 
                        } else {
                            switchTabOpname('riwayat');
                        }

                    } else {
                        myAlert('Gagal', res.message, 'error');
                    }
                })
                .withFailureHandler(function(err) {
                    loading(false);
                    myAlert('Error', err.message, 'error');
                })
                .simpanStokOpnameBulk(payload);
        }
    });
}
// [TAMBAH/PASTIKAN ADA DI JAVASCRIPT.HTML]

// 1. Request Data Detail ke Server
function lihatDetailSO(idOpname) {
    loading(true);
    google.script.run
        .withSuccessHandler(function(jsonString) {
            loading(false);
            // PERBAIKAN: Langsung panggil viewDetailSO agar tampilan konsisten (sama persis menu Riwayat)
            // Kita encodeURIComponent karena viewDetailSO melakukan decode di dalamnya
            viewDetailSO(idOpname, encodeURIComponent(jsonString));
        })
        .withFailureHandler(function(err){
            loading(false);
            myAlert('Error', err.message, 'error');
        })
        .getDetailOpname(idOpname);
}

// 2. Render Tampilan Detail
function tampilkanHalamanDetailSO(id, dataItems) {
    // 1. Munculkan Halaman Detail
    document.getElementById('tab-riwayat-opname').classList.add('d-none');
    document.getElementById('page-detail-history-so').classList.remove('d-none');
    
    // 2. Set Info ID
    document.getElementById('info-id-so').innerText = 'ID Transaksi: ' + id;

    // 3. [FIX] TIMPA HEADER TABEL SUPAYA RAPI & SINKRON (5 Kolom)
    const thead = document.querySelector('#tabel-detail-so thead');
    if(thead) {
        thead.innerHTML = `
            <tr class="bg-light">
                <th>Produk</th>
                <th class="text-center">Awal (Sistem)</th>
                <th class="text-center">Akhir (Fisik)</th>
                <th class="text-center">Selisih</th>
                <th>Keterangan</th>
            </tr>
        `;
    }

    // 4. Render Isi Tabel
    const tbody = document.getElementById('tbody-detail-history-so');
    tbody.innerHTML = '';
    
    let totalPlus = 0, totalMinus = 0;

    dataItems.forEach(item => {
        let awal = Number(item.isi_lama) || 0;
        let akhir = Number(item.isi_baru) || 0;
        let selisih = akhir - awal;
        
        let badge = '';
        if(selisih === 0) badge = '<span class="badge bg-light text-muted border">0</span>';
        else if(selisih > 0) {
            badge = `<span class="badge bg-success">+${selisih}</span>`;
            totalPlus += selisih;
        } else {
            badge = `<span class="badge bg-danger">${selisih}</span>`;
            totalMinus += Math.abs(selisih);
        }

        // Pastikan urutan kolom SAMA dengan header di atas
        tbody.innerHTML += `
            <tr>
                <td class="fw-bold">${item.nama}</td>
                <td class="text-center">${awal}</td>
                <td class="text-center fw-bold">${akhir}</td>
                <td class="text-center">${badge}</td>
                <td class="text-muted small">${item.keterangan || '-'}</td>
            </tr>
        `;
    });

    // 5. Update Kartu Statistik
    document.getElementById('hist-so-plus').innerText = totalPlus + " Pcs";
    document.getElementById('hist-so-minus').innerText = totalMinus + " Pcs";
    document.getElementById('hist-so-rugi').innerText = "-"; 
}

// ======================= BAGIAN RIWAYAT =======================

function loadRiwayatSO() {
  const tbody = document.querySelector('#tabel-riwayat-so tbody');
  tbody.innerHTML = '<tr><td colspan="5" class="text-center">Memuat riwayat...</td></tr>';
  
  google.script.run.withSuccessHandler(data => {
    tbody.innerHTML = '';
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Belum ada riwayat opname.</td></tr>';
      return;
    }

    data.forEach(row => {
      // row: [ID, Tanggal, Petugas, JmlItem, JSONString]
      
      // Encode JSON agar aman dimasukkan ke dalam atribut HTML onclick
      let safeJson = encodeURIComponent(row[4]); 

      tbody.innerHTML += `
        <tr>
          <td><span class="badge bg-secondary font-monospace">${row[0]}</span></td>
          <td>${row[1]}</td>
          <td>${row[2]}</td>
          <td><span class="fw-bold">${row[3]}</span> Item</td>
          <td class="text-center">
            <button class="btn btn-sm btn-info text-white rounded-pill px-3" onclick="viewDetailSO('${row[0]}', '${safeJson}')">
              <i class="material-icons align-middle" style="font-size:16px">visibility</i> Detail
            </button>
          </td>
        </tr>
      `;
    });
  }).getRiwayatSO();
}

// --- 1. FUNGSI VIEW DETAIL (Menggantikan Modal Popup) ---
// --- 1. FUNGSI VIEW DETAIL (REVISI: 2 NILAI SELISIH) ---
function viewDetailSO(idSo, jsonString) {
  // Decode data JSON riwayat
  let data = [];
  try {
      data = JSON.parse(decodeURIComponent(jsonString));
  } catch(e) {
      return myAlert('Error', 'Gagal membaca data riwayat.', 'error');
  }
  
  // Set Header Halaman
  document.getElementById('info-id-so').innerText = `ID Opname: ${idSo}`;
  const tbody = document.getElementById('tbody-detail-history-so');
  tbody.innerHTML = '';

  let totalPlus = 0;
  let totalMinus = 0;
  let totalSelisihModal = 0; 
  let totalSelisihJual = 0;

  data.forEach(item => {
    // 1. Cari Data Produk Master
    let produkMaster = globalProdukList.find(p => p[1] === item.nama);
    
    let hppIsi = 0, hppTabung = 0;
    let jualIsi = 0, jualTabung = 0;

    if (produkMaster) {
        hppIsi = Number(produkMaster[3]) || 0;
        hppTabung = Number(produkMaster[9]) || 0;
        jualIsi = Number(produkMaster[2]) || 0;
        jualTabung = Number(produkMaster[10]) || 0;
    }

    // 2. Hitung Selisih Fisik
    const selisihIsi = Number(item.isi_baru) - Number(item.isi_lama);
    const selisihKsg = Number(item.kosong_baru) - Number(item.kosong_lama);

    // 3. Hitung Statistik Quantity
    if (selisihIsi > 0) totalPlus += selisihIsi;
    if (selisihIsi < 0) totalMinus += Math.abs(selisihIsi);
    if (selisihKsg > 0) totalPlus += selisihKsg;
    if (selisihKsg < 0) totalMinus += Math.abs(selisihKsg);

    // 4. Hitung Nilai Rupiah
    let nilaiModal = (selisihIsi * hppIsi) + (selisihKsg * hppTabung);
    totalSelisihModal += nilaiModal;

    let nilaiJual = (selisihIsi * jualIsi) + (selisihKsg * jualTabung);
    totalSelisihJual += nilaiJual;

    // Helper formatter badge
    const fmtDiff = (val) => {
        if(val > 0) return `<span class="badge bg-success">+${val}</span>`;
        if(val < 0) return `<span class="badge bg-danger">${val}</span>`;
        return `<span class="text-muted">-</span>`;
    };
    
    // Warna Text Uang di Tabel
    let colorModal = nilaiModal < 0 ? 'text-danger' : (nilaiModal > 0 ? 'text-success' : 'text-muted');
    let colorJual = nilaiJual < 0 ? 'text-danger' : (nilaiJual > 0 ? 'text-success' : 'text-muted');

    tbody.innerHTML += `
      <tr>
        <td class="fw-bold text-dark align-middle">${item.nama}</td>
        
        <td class="text-center bg-light text-muted align-middle" style="font-size:12px">
            ${item.isi_lama} &rarr; <b>${item.isi_baru}</b>
        </td>
        <td class="text-center align-middle">${fmtDiff(selisihIsi)}</td>

        <td class="text-center bg-light text-muted align-middle" style="font-size:12px">
            ${item.kosong_lama} &rarr; <b>${item.kosong_baru}</b>
        </td>
        <td class="text-center align-middle">${fmtDiff(selisihKsg)}</td>

        <td class="text-end fw-bold align-middle ${colorModal}" style="font-size:11px;">
            ${rupiah(nilaiModal)}
        </td>
        <td class="text-end fw-bold align-middle ${colorJual}" style="font-size:11px;">
            ${rupiah(nilaiJual)}
        </td>
        
        <td class="text-start align-middle" style="white-space: normal; word-wrap: break-word; line-height: 1.2;">
            <small class="text-muted fst-italic">${item.keterangan || '-'}</small>
        </td>
      </tr>
    `;
  });

  // 5. Update Kartu Statistik (BAGIAN INI YANG DI UPDATE)
  const fmtMoney = (val) => val < 0 ? `-${rupiah(Math.abs(val))}` : `+${rupiah(val)}`;

  document.getElementById('hist-so-plus').innerText = totalPlus + " Pcs";
  document.getElementById('hist-so-minus').innerText = totalMinus + " Pcs";
  
  // Update 2 Card Baru
  document.getElementById('hist-so-total-modal').innerText = fmtMoney(totalSelisihModal);
  document.getElementById('hist-so-total-jual').innerText = fmtMoney(totalSelisihJual);

  // Warnai teks card total (Merah jika minus, Hijau jika plus)
  document.getElementById('hist-so-total-modal').className = `fw-bold ${totalSelisihModal < 0 ? 'text-danger' : 'text-success'}`;
  document.getElementById('hist-so-total-jual').className = `fw-bold ${totalSelisihJual < 0 ? 'text-danger' : 'text-success'}`;


  // 6. BARIS TOTAL DI TABEL BAWAH
  const colorTotalModal = totalSelisihModal < 0 ? 'text-danger' : 'text-success';
  const colorTotalJual = totalSelisihJual < 0 ? 'text-danger' : 'text-success';

  tbody.innerHTML += `
    <tr class="bg-light fw-bold" style="border-top: 2px solid #6c757d;">
        <td colspan="5" class="text-end text-dark align-middle">TOTAL AKUMULASI :</td>
        <td class="text-end align-middle ${colorTotalModal}" style="font-size:12px;">
             ${fmtMoney(totalSelisihModal)}
        </td>
        <td class="text-end align-middle ${colorTotalJual}" style="font-size:12px;">
             ${fmtMoney(totalSelisihJual)}
        </td>
        <td></td> 
    </tr>
  `;

  // SWITCH PAGE
  document.getElementById('tab-riwayat-opname').classList.add('d-none'); 
  document.getElementById('page-detail-history-so').classList.remove('d-none'); 
  document.getElementById('tabOpname').classList.add('d-none');
}

// --- 2. FUNGSI TOMBOL KEMBALI ---
function tutupDetailHistorySO() {
  document.getElementById('page-detail-history-so').classList.add('d-none');
  
  // Kembalikan tampilan halaman stok opname utama
  document.getElementById('tabOpname').classList.remove('d-none');
  document.getElementById('tab-riwayat-opname').classList.remove('d-none');
}

// --- LOGIKA PENCARIAN PRODUK OPNAME (GOOGLE STYLE) ---

// 1. Saat Mengetik di Kolom Cari
document.getElementById('op-input-cari')?.addEventListener('input', function() {
    const keyword = this.value.toLowerCase();
    const container = document.getElementById('hasil-cari-produk-opname');
    
    // Jika kosong, sembunyikan
    if(keyword.length < 1) {
        container.classList.add('d-none');
        return; 
    }

    // Filter Data dari Global Produk
    // globalProdukList format: [0]ID, [1]Nama, [2]Jual, [3]Beli, [4]StokIsi, [5]StokKsg
    const hasil = globalProdukList.filter(p => {
        return p[1].toLowerCase().includes(keyword);
    });

    container.innerHTML = ''; // Bersihkan list lama

    if(hasil.length === 0) {
         container.innerHTML = '<div class="list-group-item text-muted small">Produk tidak ditemukan.</div>';
    } else {
        // Tampilkan Maksimal 10 Hasil biar ringan
        hasil.slice(0, 10).forEach(p => {
            const btn = document.createElement('button');
            btn.className = 'list-group-item list-group-item-action py-2 text-start';
            // Tampilan di list: Nama Produk (Stok: 10 | 5)
            btn.innerHTML = `
                <div class="fw-bold text-dark small">${p[1]}</div>
                <div class="text-muted" style="font-size:10px">Sistem: Isi ${p[4]} | Ksg ${p[5]}</div>
            `;
            
            // SAAT DIPILIH (KLIK)
            btn.onclick = function() {
                pilihProdukOpname(p);
            };
            
            container.appendChild(btn);
        });
    }
    
    container.classList.remove('d-none'); // Munculkan Dropdown
});

// 2. Fungsi Mengisi Form Saat Produk Diklik
function pilihProdukOpname(produk) {
    // Isi Inputan
    document.getElementById('op-input-cari').value = produk[1]; // Nama
    document.getElementById('op-id-produk').value = produk[0];  // ID
    
    document.getElementById('op-sys-isi').value = produk[4];    // Stok Isi
    document.getElementById('op-sys-ksg').value = produk[5];    // Stok Kosong
    
    // Sembunyikan Dropdown
    document.getElementById('hasil-cari-produk-opname').classList.add('d-none');
    
    // Langsung fokus ke input Fisik Isi biar cepat
    document.getElementById('op-fisik-isi').focus();
}

// 3. Sembunyikan Dropdown jika klik di luar area
document.addEventListener('click', function(e) {
    if (e.target.id !== 'op-input-cari') {
        document.getElementById('hasil-cari-produk-opname')?.classList.add('d-none');
    }
});

// 4. Update Modal Buka (Reset Form)
function bukaModalTambahOpname() {
    // Reset Form
    document.getElementById('op-input-cari').value = '';
    document.getElementById('op-id-produk').value = '';
    document.getElementById('op-sys-isi').value = '';
    document.getElementById('op-fisik-isi').value = '';
    document.getElementById('op-sys-ksg').value = '';
    document.getElementById('op-fisik-ksg').value = '';
    document.getElementById('op-ket').value = '';
    
    // Sembunyikan dropdown sisa sebelumnya
    document.getElementById('hasil-cari-produk-opname').classList.add('d-none');

    // Pastikan Data Produk Siap
    if(!globalProdukList || globalProdukList.length === 0) {
        loadProduk(); // Load diam-diam
    }

    // Tampilkan Modal
    new bootstrap.Modal(document.getElementById('modalInputOpnameItem')).show();
    
    // Auto focus
    setTimeout(() => document.getElementById('op-input-cari').focus(), 500);
}
// Dipanggil saat user memilih produk dari list
function isiOtomatisOpname() {
    const namaInput = document.getElementById('op-input-cari').value;
    
    // Cari data di globalProdukList
    const produk = globalProdukList.find(p => p[1] === namaInput);
    
    if(produk) {
        // Ketemu! Isi data sistem otomatis
        document.getElementById('op-id-produk').value = produk[0]; // ID
        document.getElementById('op-sys-isi').value = produk[4];   // Stok Isi
        document.getElementById('op-sys-ksg').value = produk[5];   // Stok Kosong
        
        // Fokus langsung ke input fisik isi biar cepat
        document.getElementById('op-fisik-isi').focus();
    } else {
        // Kalau nama ngawur/tidak ketemu
        document.getElementById('op-id-produk').value = '';
        document.getElementById('op-sys-isi').value = '';
        document.getElementById('op-sys-ksg').value = '';
    }
}

// Simpan dari Modal ke Draft Buffer
function tambahItemKeDraft() {
    const id = document.getElementById('op-id-produk').value;
    const nama = document.getElementById('op-input-cari').value;
    
    // Validasi
    if(!id) return myAlert('Error', 'Silakan pilih produk yang valid dari list.', 'warning');

    const sysIsi = Number(document.getElementById('op-sys-isi').value);
    const sysKsg = Number(document.getElementById('op-sys-ksg').value);
    
    let fisikIsi = document.getElementById('op-fisik-isi').value;
    let fisikKsg = document.getElementById('op-fisik-ksg').value;
    const ket = document.getElementById('op-ket').value;

    // Default jika kosong = Dianggap SAMA dengan sistem (Tidak ada selisih)
    if(fisikIsi === '') fisikIsi = sysIsi;
    else fisikIsi = Number(fisikIsi);
    
    if(fisikKsg === '') fisikKsg = sysKsg;
    else fisikKsg = Number(fisikKsg);

    // Simpan ke Object Buffer (Key = ID Produk, biar gak dobel)
    draftBuffer[id] = {
      id: id,
      nama: nama,
      sysIsi: sysIsi,
      sysKsg: sysKsg,
      fisikIsi: fisikIsi,
      fisikKosong: fisikKsg,
      keterangan: ket
    };

    // Render Ulang & Tutup Modal
    renderTabelDraftOpname();
    bootstrap.Modal.getInstance(document.getElementById('modalInputOpnameItem')).hide();
    
    // Notif kecil (opsional)
    // myAlert('Sukses', 'Produk ditambahkan ke list opname.', 'success');
}

function renderTabelDraftOpname() {
    const tb = document.querySelector('#tabel-input-opname tbody');
    const msgKosong = document.getElementById('msg-opname-kosong');
    const badge = document.getElementById('badge-draft');
    
    tb.innerHTML = '';
    
    // Ubah Object Buffer jadi Array
    const listItems = Object.values(draftBuffer);
    
    // Update Badge & Pesan Kosong
    badge.innerText = listItems.length;
    if(listItems.length > 0) {
        badge.classList.remove('d-none');
        msgKosong.classList.add('d-none');
        document.getElementById('tabel-input-opname').classList.remove('d-none');
    } else {
        badge.classList.add('d-none');
        msgKosong.classList.remove('d-none');
        document.getElementById('tabel-input-opname').classList.add('d-none');
        return; 
    }

    listItems.forEach(item => {
        // Hitung Selisih
        let selisihIsi = item.fisikIsi - item.sysIsi;
        let selisihKsg = item.fisikKosong - item.sysKsg;

        // Helper Label Selisih
        const badgeDiff = (n) => {
            if(n === 0) return '<span class="badge bg-light text-muted border">OK</span>';
            if(n > 0) return `<span class="badge bg-success">+${n}</span>`;
            return `<span class="badge bg-danger">${n}</span>`;
        };

        tb.innerHTML += `
            <tr>
                <td class="fw-bold text-dark">${item.nama}</td>
                
                <td class="text-center">
                    <div class="small text-muted">Isi: ${item.sysIsi}</div>
                    <div class="small text-muted">Ksg: ${item.sysKsg}</div>
                </td>
                
                <td class="text-center">
                    <div class="fw-bold">Isi: ${item.fisikIsi}</div>
                    <div class="fw-bold">Ksg: ${item.fisikKosong}</div>
                </td>
                
                <td class="text-center">
                    <div>Isi: ${badgeDiff(selisihIsi)}</div>
                    <div class="mt-1">Ksg: ${badgeDiff(selisihKsg)}</div>
                </td>
                
                <td><small class="text-muted fst-italic">${item.keterangan || '-'}</small></td>
                
                <td class="text-center text-nowrap">
                    <button class="btn btn-sm btn-light text-warning border me-1" onclick="editItemDraft('${item.id}')" title="Edit Data" style="display:inline-flex; align-items:center; justify-content:center;">
                        <i class="material-icons" style="font-size:16px">edit</i>
                    </button>
                    <button class="btn btn-sm btn-light text-danger border" onclick="hapusItemDraft('${item.id}')" title="Hapus dari list" style="display:inline-flex; align-items:center; justify-content:center;">
                        <i class="material-icons" style="font-size:16px">delete</i>
                    </button>
                </td>
            </tr>
        `;
    });
}

function editItemDraft(id) {
    // 1. Ambil data dari variabel global draftBuffer
    const item = draftBuffer[id];
    
    if(!item) {
        return Swal.fire('Error', 'Data tidak ditemukan', 'error');
    }

    // 2. Isi Form Modal dengan Data Item
    document.getElementById('op-id-produk').value = item.id; // Penting: ID lama harus masuk
    document.getElementById('op-input-cari').value = item.nama;
    
    // Info System
    document.getElementById('op-sys-isi').value = item.sysIsi;
    document.getElementById('op-sys-ksg').value = item.sysKsg;

    // Input Fisik (Yang diedit)
    document.getElementById('op-fisik-isi').value = item.fisikIsi;
    document.getElementById('op-fisik-ksg').value = item.fisikKosong;
    document.getElementById('op-ket').value = item.keterangan || '';

    // 3. Sembunyikan hasil pencarian jika masih terbuka
    const dropdownSearch = document.getElementById('hasil-cari-produk-opname');
    if(dropdownSearch) dropdownSearch.classList.add('d-none');

    // 4. Buka Modal Input
    var myModal = new bootstrap.Modal(document.getElementById('modalInputOpnameItem'));
    myModal.show();
}

function hapusItemDraft(id) {
    delete draftBuffer[id];
    renderTabelDraftOpname();
}

// --- FITUR KEAMANAN STOK OPNAME ---

function cekAksesOpname() {
    const PIN_RAHASIA = "123456"; // Sesuaikan PIN Anda

    Swal.fire({
        title: 'Keamanan Stok',
        text: 'Masukkan PIN Otorisasi untuk membuka Stok Opname',
        icon: 'lock',
        input: 'password',
        inputAttributes: {
            autocapitalize: 'off',
            placeholder: '******',
            maxlength: 6,
            style: 'text-align:center; font-size:24px; letter-spacing: 5px; font-weight:bold;'
        },
        showCancelButton: true,
        confirmButtonText: 'BUKA AKSES',
        cancelButtonText: 'Batal',
        confirmButtonColor: '#0d6efd',
        preConfirm: (inputPin) => {
            if (inputPin !== PIN_RAHASIA) {
                Swal.showValidationMessage('PIN Salah! Akses Ditolak.')
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // --- TAMBAHAN BARU DISINI ---
            // Mencatat aktivitas ke server (Spreadsheet)
            google.script.run.catatLog('AKSES_MENU', 'Berhasil membuka menu Stok Opname via PIN');
            // ----------------------------

            Swal.fire({
                icon: 'success',
                title: 'Akses Diberikan',
                timer: 1000,
                showConfirmButton: false
            }).then(() => {
                showPage('stok-opname');
            });
        }
    });
}

// --- FUNGSI FORMAT RUPIAH SAAT MENGETIK ---
function formatRupiahInput(input) {
  // 1. Hapus semua karakter selain angka
  let value = input.value.replace(/\D/g, ''); 
  
  // 2. Format jadi ribuan (Cth: 100000 -> 100.000)
  if(value !== '') {
      input.value = new Intl.NumberFormat('id-ID').format(value);
  } else {
      input.value = '';
  }
}

// --- HELPER DOWNLOAD PDF ---
function downloadPdfFromBase64(base64, filename) {
  // Buat link virtual
  const link = document.createElement('a');
  link.href = 'data:application/pdf;base64,' + base64;
  link.download = filename + ".pdf"; // Nama file otomatis
  
  // Klik otomatis link tersebut
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
